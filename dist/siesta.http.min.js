!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){function d(a){return a?"*"==a||a.indexOf("*")>-1?a=p:m.isArray(a)||(a=[a]):a=["GET"],n.map(a,function(a){return a.toUpperCase()})}function e(a){if(!this)return new e(a);this._rawOpts=l(!0,{},a),this._opts=a;var b=function(a){for(var b,c=/\?<([0-9a-zA-Z_-]*)>/g,d=[];b=c.exec(a);){var e=b[1];d.push(e)}a=a.replace(c,"");var f=new RegExp(a,"g");return{names:d,regExp:f}}.bind(this);if(this._opts.path){var c=this._opts.path;m.isArray(c)||(c=[c]),this._opts.path=[],this.names=[],n.each(c,function(a){var c=b.call(this,a);this._opts.path.push(c.regExp),this.names.push(c.names)}.bind(this))}else this._opts.path=[""],this.names=[[]];if(this._opts.method=d(this._opts.method),!this._opts.mapping)throw new Error("Descriptors must be initialised with a mapping",{opts:a,descriptor:this});if("string"==typeof this._opts.mapping){if(!this._opts.collection)throw new Error("Passed mapping as string, but did not specify the collection it belongs to",{opts:a,descriptor:this});var f;if(f="string"==typeof this._opts.collection?k[this._opts.collection]:this._opts.collection,!f)throw new Error("Collection "+this._opts.collection+" does not exist",{opts:a,descriptor:this});var g=f[this._opts.mapping];if(!g)throw new Error("Mapping "+this._opts.mapping+" does not exist",{opts:a,descriptor:this});this._opts.mapping=g}var h=this._opts.data;if(h&&h.length){var i,o=h.split(".");if(1==o.length)i=o[0];else{var p={};i=p;for(var q=o[0],r=1;r<o.length;r++){var s=o[r];if(r==o.length-1)p[q]=s;else{var t={};p[q]=t,p=t,q=s}}}this._opts.data=i}j.call(this,"path",this._opts),j.call(this,"method",this._opts),j.call(this,"mapping",this._opts),j.call(this,"data",this._opts),j.call(this,"transforms",this._opts)}var f=siesta._internal,g=f.log,h=f.error.InternalSiestaError,i=f.misc.assert,j=f.misc.defineSubProperty,k=f.CollectionRegistry,l=f.extend,m=f.util,n=m._,o=g.loggerWithName("Descriptor");o.setLevel(g.Level.warn);var p=["POST","PATCH","PUT","HEAD","GET","DELETE","OPTIONS","TRACE","CONNECT"];n.extend(e.prototype,{httpMethods:p,_matchPath:function(a){var b,c=[];for(b=0;b<this._opts.path.length;b++){var d=this.names[b],e=this._opts.path[b],f=e.exec(a);if(f){for(b=1;b<f.length;b++)c.push(f[b]);var g;if(c.length==d.length)return g={},n.each(c,function(a,b){g[d[b]]=a}.bind(this)),g}}return null},_matchMethod:function(a){for(var b=0;b<this.method.length;b++)if(a.toUpperCase()==this.method[b])return!0;return!1},bury:function(a,b){var c=b,d=Object.keys(b);i(1==d.length);for(var e=d[0],f=b;"string"!=typeof f[e];)f=f[e],d=Object.keys(f),i(1==d.length),e=d[0];var g=f[e],h={};return f[e]=h,h[g]=a,c},_embedData:function(a){if(this.data){var b;return"string"==typeof this.data?(b={},b[this.data]=a):b=this.bury(a,l(!0,{},this.data)),b}return a},_extractData:function(a){if(o.debug.isEnabled&&o.debug("_extractData",a),this.data){if("string"==typeof this.data)return a[this.data];var b=Object.keys(this.data);i(1==b.length);for(var c=a,d=this.data;"string"!=typeof d;){b=Object.keys(d),i(1==b.length);var e=b[0];if(d=d[e],c=c[e],!c)break}return c?c[d]:null}return a},_matchConfig:function(a){var b=a.type?this._matchMethod(a.type):{};return b&&(b=a.url?this._matchPath(a.url):{}),b&&o.trace.isEnabled&&o.trace("matched config"),b},_matchData:function(a){var b=null;return this.data?a&&(b=this._extractData(a)):b=a,b&&o.trace("matched data"),b},match:function(a,b){var c=this._matchConfig(a),d=!!c,e=!1;if(d)if(o.trace("config matches"),e=this._matchData(b),d=!!e){var f;if(m.isArray(e))for(f in c)c.hasOwnProperty(f)&&n.each(e,function(a){a[f]=c[f]});else for(f in c)c.hasOwnProperty(f)&&(e[f]=c[f]);o.trace("data matches")}else o.trace("data doesnt match");else o.trace("config doesnt match");return e},_transformData:function(a){var b=this.transforms;if("function"==typeof b)a=b(a);else for(var c in b)if(b.hasOwnProperty(c)&&a[c]){var d=b[c],e=a[c];if("string"==typeof d){var f=d.split(".");if(delete a[c],1==f.length)a[f[0]]=e;else{a[f[0]]={};for(var g=a[f[0]],i=1;i<f.length-1;i++){var j=f[i];g[j]={},g=g[j]}g[f[f.length-1]]=e}}else{if("function"!=typeof d)throw new h("Invalid transformer");var k=d(e);m.isArray(k)?(delete a[c],a[k[0]]=k[1]):a[c]=k}}return a}}),c.Descriptor=e,c.resolveMethod=d},{}],2:[function(a,b,c){function d(){return this?(this.requestDescriptors={},void(this.responseDescriptors={})):new d(opts)}function e(a,b){var c=b.mapping,d=c.collection;j(c),j(d),j("string"==typeof d),a[d]||(a[d]=[]),a[d].push(b)}function f(a,b){var c;return c="string"==typeof b?a[b]||[]:a[b._name]||[]}var g=siesta._internal,h=g.log,i=h.loggerWithName("DescriptorRegistry");i.setLevel(h.Level.warn);var j=g.misc.assert,k=g.util,l=k._;l.extend(d.prototype,{registerRequestDescriptor:function(a){e(this.requestDescriptors,a)},registerResponseDescriptor:function(a){i.trace.isEnabled&&i.trace("registerResponseDescriptor"),e(this.responseDescriptors,a)},requestDescriptorsForCollection:function(a){return f(this.requestDescriptors,a)},responseDescriptorsForCollection:function(a){var b=f(this.responseDescriptors,a);return b.length||i.debug.isEnabled&&i.debug("No response descriptors for collection ",this.responseDescriptors),b},reset:function(){this.requestDescriptors={},this.responseDescriptors={}}}),c.DescriptorRegistry=new d},{}],3:[function(a){function b(a,b){var c,d=this,e=Array.prototype.slice.call(arguments,2),f={},g=this._name;"function"==typeof e[0]?c=e[0]:"object"==typeof e[0]&&(f=e[0],c=e[1]);var h=window.q?window.q.defer():null;if(c=p.constructCallbackAndPromiseHandler(c,h),f.type=a,!f.url){var i=this.baseURL;f.url=i+b}void 0===f.parseResponse&&(f.parseResponse=!0),f.success=function(a,b,e){u.trace.isEnabled&&u.trace(f.type+" "+e.status+" "+f.url+": "+JSON.stringify(a,null,4));var h={data:a,textStatus:b,jqXHR:e};if(f.parseResponse){for(var i,j,k=t.responseDescriptorsForCollection(d),l=0;l<k.length;l++){var m=k[l];if(j=m.match(f,a)){i=m;break}}if(i)if(u.trace.isEnabled&&u.trace("Mapping extracted data: "+JSON.stringify(j,null,4)),"object"==typeof j){var n=i.mapping;n.map(j,function(a,b){c&&c(a,b,h)},f.obj)}else c(null,!0,h);else if(c){if(!g)throw new s("Unnamed collection");c(null,null,h)}}else c(null,null,h)},f.error=function(a,b,d){var e={jqXHR:a,textStatus:b,errorThrown:d};c&&c(e,null,e)},u.trace.isEnabled&&u.trace("Ajax request:",f),siesta.ext.http.ajax(f)}function c(a,b,c){this._serialise(b,function(b,d){var e=d;a.fields&&(e={},q.each(a.fields,function(a){e[a]=d[a]})),c(b,e)})}function d(a,d,e){var f,g=this,h=Array.prototype.slice.call(arguments,3),i={};"function"==typeof h[0]?f=h[0]:"object"==typeof h[0]&&(i=h[0],f=h[1]);var j=window.q?window.q.defer():null;f=p.constructCallbackAndPromiseHandler(f,j),h=Array.prototype.slice.call(h,2);var k,l=t.requestDescriptorsForCollection(this);i.type=a;var m=this.baseURL;i.url=m+d;for(var n=0;n<l.length;n++){var o=l[n];if(o._matchConfig(i)){k=o;break}}return k?(u.trace.isEnabled&&u.trace("Matched descriptor: "+k._dump(!0)),c.call(k,e,i,function(c,j){u.trace.isEnabled&&u.trace("_serialise",{err:c,data:j}),c?f&&f(c,null,null):(i.data=j,i.obj=e,q.partial(b,a,d,i,f).apply(g,h))})):f&&(u.trace.isEnabled&&u.trace("Did not match descriptor"),f(null,null,null)),j?j.promise:null}function e(a,c,d){var e,f=window.q?window.q.defer():null,g=Array.prototype.slice.call(arguments,3),h={};"function"==typeof g[0]?e=g[0]:"object"==typeof g[0]&&(h=g[0],e=g[1]),e=p.constructCallbackAndPromiseHandler(e,f);var i=h.deletionMode||"restore";return void 0===h.parseResponse&&(h.parseResponse=!1),b.call(a,"DELETE",c,h,function(a,b,c,f){a?"restore"==i&&d.restore():"success"==i&&d.remove(),e(a,b,c,f)}),("now"==i||"restore"==i)&&d.remove(),f?f.promise:null}function f(a,c,e){var f=Array.prototype.slice.call(arguments,3);return q.partial(c?d:b,e).apply(a,f)}function g(a){var b=Array.prototype.slice.call(arguments,1);return q.partial(f,a,!1,"GET").apply(this,b)}function h(a){var b=Array.prototype.slice.call(arguments,1);return q.partial(f,a,!1,"OPTIONS").apply(this,b)}function i(a){var b=Array.prototype.slice.call(arguments,1);return q.partial(f,a,!1,"TRACE").apply(this,b)}function j(a){var b=Array.prototype.slice.call(arguments,1);return q.partial(f,a,!1,"HEAD").apply(this,b)}function k(a){var b=Array.prototype.slice.call(arguments,1);return q.partial(f,a,!0,"POST").apply(this,b)}function l(a){var b=Array.prototype.slice.call(arguments,1);return q.partial(f,a,!0,"PUT").apply(this,b)}function m(a){var b=Array.prototype.slice.call(arguments,1);return q.partial(f,a,!0,"PATCH").apply(this,b)}if(!siesta)throw new Error("Could not find siesta");var n=siesta._internal,o=(siesta.Collection,n.log),p=n.util,q=p._,r=a("./descriptor"),s=n.error.InternalSiestaError,t=a("./descriptorRegistry").DescriptorRegistry,u=o.loggerWithName("HTTP");u.setLevel(o.Level.warn),siesta.ext||(siesta.ext={});var v;siesta.ext.http={RequestDescriptor:a("./requestDescriptor").RequestDescriptor,ResponseDescriptor:a("./responseDescriptor").ResponseDescriptor,Descriptor:r.Descriptor,_resolveMethod:r.resolveMethod,Serialiser:a("./serialiser"),DescriptorRegistry:a("./descriptorRegistry").DescriptorRegistry,setAjax:function(a){v=a},_httpResponse:b,_httpRequest:d,DELETE:e,HTTP_METHOD:f,GET:g,TRACE:i,OPTIONS:h,HEAD:j,POST:k,PUT:l,PATCH:m,_serialiseObject:c},Object.defineProperty(siesta.ext.http,"ajax",{get:function(){var a=v||($?$.ajax:null)||(jQuery?jQuery.ajax:null);if(!a)throw new s("ajax has not been defined and could not find $.ajax or jQuery.ajax");return a},set:function(a){v=a}})},{"./descriptor":1,"./descriptorRegistry":2,"./requestDescriptor":4,"./responseDescriptor":5,"./serialiser":6}],4:[function(a,b,c){function d(a){return this?(e.call(this,a),this._opts.serializer&&(this._opts.serialiser=this._opts.serializer),this._opts.serialiser||(this._opts.serialiser=f.depthSerializer(0)),k.call(this,"serialiser",this._opts),void k.call(this,"serializer",this._opts,"serialiser")):new d(a)}var e=a("./descriptor").Descriptor,f=a("./serialiser"),g=siesta._internal,h=g.util,i=h._,j=g.log,k=g.misc.defineSubProperty,l=j.loggerWithName("RequestDescriptor");l.setLevel(j.Level.warn),d.prototype=Object.create(e.prototype),i.extend(d.prototype,{_serialise:function(a,b){var c=window.q?window.q.defer():null;b=h.constructCallbackAndPromiseHandler(b,c);var d=this;l.trace.isEnabled&&l.trace("_serialise");var e,f=this.serialiser(a,function(a,c){e||(c=d._transformData(c),b&&b(a,d._embedData(c)))});return void 0!==f?(l.trace.isEnabled&&l.trace("serialiser doesnt use a callback"),e=!0,f=d._transformData(f),b&&b(null,d._embedData(f))):l.trace.isEnabled&&l.trace("serialiser uses a callback",this.serialiser),c?c.promise:null},_dump:function(a){var b={};b.methods=this.method,b.mapping=this.mapping.type,b.path=this._rawOpts.path;var c;c="function"==typeof this._rawOpts.serialiser?"function () { ... }":this._rawOpts.serialiser,b.serialiser=c;var d={};for(var e in this.transforms)if(this.transforms.hasOwnProperty(e)){var f=this.transforms[e];d[e]="function"==typeof f?"function () { ... }":this.transforms[e]}return b.transforms=d,a?JSON.stringify(b,null,4):b}}),c.RequestDescriptor=d},{"./descriptor":1,"./serialiser":6}],5:[function(a,b,c){function d(a){return this?void e.call(this,a):new d(a)}var e=a("./descriptor").Descriptor;d.prototype=Object.create(e.prototype),_.extend(d.prototype,{_extractData:function(a){var b=e.prototype._extractData.call(this,a);return b&&(b=this._transformData(b)),b},_matchData:function(a){var b=e.prototype._matchData.call(this,a);return b&&(b=this._transformData(b)),b},_dump:function(a){var b={};b.methods=this.method,b.mapping=this.mapping.type,b.path=this._rawOpts.path;var c={};for(var d in this.transforms)if(this.transforms.hasOwnProperty(d)){var e=this.transforms[d];c[d]="function"==typeof e?"function () { ... }":this.transforms[d]}return b.transforms=c,a?JSON.stringify(b,null,4):b}}),c.ResponseDescriptor=d},{"./descriptor":1}],6:[function(a,b,c){function d(a){var b=a.mapping.id;return b?a[b]?a[b]:null:void(i.debug.isEnabled&&i.debug("No idfield"))}function e(a,b,c){i.trace.isEnabled&&i.trace("depthSerialiser");var d={};j.each(b._fields,function(a){i.trace.isEnabled&&i.trace("field",a),b[a]&&(d[a]=b[a])});var f=[],g=[],h={},k=[];j.each(b._relationshipFields,function(j){i.trace.isEnabled&&i.trace("relationshipField",j);var l=b.__proxies[j];l.isForward&&(i.debug.isEnabled&&i.debug(j),f.push(j),l.get(function(l,m){i.trace.isEnabled&&i.trace("proxy.get",j),i.debug.isEnabled&&i.debug(j,m),l?(g.push(l),k.push(j),h[j]={err:l,v:m}):m?a?e(a-1,m,function(a,b,e){a?g.push(a):d[j]=b,k.push(j),h[j]={err:a,v:m,resp:e},f.length==k.length&&c&&c(g.length?g:null,d,h)}):(k.push(j),d[j]=m[b.__proxies[j].forwardMapping.id],h[j]={err:l,v:m},f.length==k.length&&c&&c(g.length?g:null,d,h)):(i.debug.isEnabled&&i.debug("no value for "+j),k.push(j),h[j]={err:l,v:m},f.length==k.length&&c&&c(g.length?g:null,d,h))}))}),f.length||c&&c(null,d,{})}var f=siesta._internal,g=f.log,h=f.util,i=g.loggerWithName("Serialiser");i.setLevel(g.Level.warn);var j=h._;c.depthSerialiser=function(a){return j.partial(e,a)},c.depthSerializer=function(a){return j.partial(e,a)},c.idSerializer=d,c.idSerialiser=d},{}]},{},[3]);