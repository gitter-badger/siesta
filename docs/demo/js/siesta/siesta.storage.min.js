!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){function d(a,b,c,d,e){if(!d&&!e)throw new s("Must remove or add something with a splice change.");if(void 0===c||null===c)throw new s("Must pass index to splice change");{var f=a[b];u.partial(f.splice,c,d.length).apply(f,e)}}function e(a,b,c){if(!b)throw new s("Must pass removed");u.each(b,function(b){var d=c[a],e=d.indexOf(b);d.splice(e,1)})}function f(a,b,c,d){var e=a[b];if(e!=d)throw new s("Old value does not match new value: "+JSON.stringify({old:d?d:null,actualOld:e?e:null},null,4));a[b]=c}function g(){if(!this.field)throw new s("Must pass field to change");if(!this.collection)throw new s("Must pass collection to change");if(!this.mapping)throw new s("Must pass mapping to change")}function h(a){if(a._id!=this._id)throw new s('Cannot apply change with _id="'+this._id.toString()+'" to object with _id="'+a._id.toString()+'"')}function i(a,b){if(a)f.call(this,b.__values,this.field,this.new,this.old);else{var c=this.newId||(this.new?this.new._id:null),d=this.oldId||(this.old?this.old._id:null),e=b[this.field+"Proxy"];f.call(this,e,"_id",c,d);var g=this.new||(this.newId?B.get({_id:this.newId}):null),h=this.old||(this.oldId?B.get({_id:this.oldId}):null);g||h?f.call(this,e,"related",g,h):e.related=null}}function j(a,b){if(a)d.call(this,b.__values,this.field,this.index,this.removed,this.added);else{var c=this.removedId||(this.removed?u.pluck(this.removed,"_id"):[]),e=this.addedId||(this.added?u.pluck(this.added,"_id"):[]),f=b[this.field+"Proxy"],g=f.isFault;if(d.call(this,f,"_id",this.index,c,e),!g){var h=this.removed||u.map(c,function(a){return B.get({_id:a})}),i=u.reduce(h,function(a,b){return b&&a},!0),j=this.added||u.map(e,function(a){return B.get({_id:a})}),k=u.reduce(j,function(a,b){return b&&a},!0);if(i&&k)d.call(this,f,"related",this.index,h,j);else{if(!i)throw new s("If not faulted, all removed objects should be cache.");f.related=null}}}}function k(a,b){if(a)e.call(this,this.field,this.removed,b);else{var c=this.removedId||(this.removed?u.pluck(this.removed,"_id"):[]),d=b[this.field+"Proxy"],f=d.isFault;e.call(this,"_id",c,d),!f&&this.removed&&e.call(this,"related",this.removed,d)}}function l(){var a={};for(var b in J)if(J.hasOwnProperty(b)){var c=J[b];for(var d in c)if(c.hasOwnProperty(d)){var e=c[d];z(a,e)}}return a}function m(a){return l()[a]||[]}function n(a){var b=F.defer();a=t.constructCallbackAndPromiseHandler(a,b);var c=l(),d=u.keys(c).length;if(d){H.debug.isEnabled&&H.debug("Merging "+d.toString()+" changes");var e=new v("Merge Changes",function(a){H.debug.isEnabled&&H.debug("Beggining merge operation");var b=[];for(var d in c)c.hasOwnProperty(d)&&b.push(d);var e=G.getPouch();H.debug.isEnabled&&H.debug("Getting docs"),u.each(b,function(a){K[a]={}}),e.allDocs({keys:b,include_docs:!0},function(b,d){if(b)a(b);else{H.debug.isEnabled&&H.debug("Got docs");var f=[],g=[];H.debug.isEnabled&&H.debug("Updating docs docs"),u.each(d.rows,function(a){var b;a.error?"not_found"==a.error?b={_id:a.key}:g.push(a.error):b=a.doc;var d=c[b._id];u.each(d,function(a){a.apply(b)}),f.push(b)}),H.debug.isEnabled&&H.debug("Saving docs");var h=[];h.push(function(a){u.keys(K).length?(H.debug.isEnabled&&H.debug("waiting for observations"),I=function(){H.debug.isEnabled&&H.debug("finished waiting for observations"),a()}):(H.debug.isEnabled&&H.debug("no observations to wait for"),a())}),h.push(function(a){e.bulkDocs(f,function(c,d){b?g.length?(g.push(b),a(g)):a(b):(H.debug.isEnabled&&H.debug("Saved docs",d),a())})}),t.parallel(h,a)}})});e.onCompletion(function(){a&&a(e.error)}),L.addOperation(e)}else a&&(H.debug.isEnabled&&H.debug("Nothing to merge"),a());return b.promise}function o(){var a=[];for(var b in J)if(J.hasOwnProperty(b)){var c=J[b];for(var d in c)if(c.hasOwnProperty(d)){var e=c[d];for(var f in e)e.hasOwnProperty(f)&&(a=a.concat(e[f]))}}return a}function p(){J={}}function q(a){N.call(this,a),Object.defineProperty(this,"changes",{get:function(){return m(this._id)},enumerable:!0})}var r=siesta._internal,s=r.error.InternalSiestaError,t=r.util,u=t._,v=r.Operation,w=r.OperationQueue,x=r.object,y=x.SiestaModel,z=r.extend,A=r.log,B=r.cache,C=r.coreChanges,D=C.Change,E=C.ChangeType,F=(r.collection,r.q),G=a("./pouch"),H=(a("./index"),A.loggerWithName("changes"));H.setLevel(A.Level.warn);var I,J={},K={};G.addObserver(function(a){var b=a.id;for(var c in J)if(J.hasOwnProperty(c)){var d=J[c];for(var e in d)if(d.hasOwnProperty(e)){var f=d[e];if(f[b])return delete f[b],delete K[b],void(!u.keys(K).length&&I&&(I(),I=null))}}});var L=new w("Merge Queue");L.maxConcurrentOperations=1,L.start();var M=C.registerChange;C.registerChange=function(a){C.validateChange(a);var b=a.collection,c=a.mapping,d=a._id;J[b.name]||(J[b.name]={});var e=J[b.name];e[c.type]||(e[c.type]={}),e[c.type][d]||(e[c.type][d]=[]);var f=e[c.type][d],g=M(a);f.push(g)},D.prototype.apply=function(a){if(g.call(this),h.call(this,a),this.type==E.Set)f.call(this,a,this.field,this.newId||this.new,this.oldId||this.old);else if(this.type==E.Splice)a[this.field]||(a[this.field]=[]),d.call(this,a,this.field,this.index,this.removedId||this.removed,this.addedId||this.added);else{if(this.type!=E.Delete)throw new s('Unknown change type "'+this.type.toString()+'"');e.call(this,this.field,this.removedId||this.removed,a)}a.collection||(a.collection=this.collection),a.mapping||(a.mapping=this.mapping),a.type||(a.type=this.mapping)},D.prototype.applySiestaModel=function(a){g.call(this),h.call(this,a);var b=u.keys(this.mapping.relationships),c=this.mapping._fields,d=c.indexOf(this.field)>-1,e=b.indexOf(this.field)>-1;if(!d&&!e)throw new s('Field "'+this.field+'" does not exist within mapping "'+this.mapping.type+'"');if(this.type==E.Set)i.call(this,d,a);else if(this.type==E.Splice)j.call(this,d,a);else{if(this.type!=E.Delete)throw new s('Unknown change type "'+this.type.toString()+'"');k.call(this,d,a)}},Object.defineProperty(c,"changes",{get:function(){return J},set:function(a){J=a},enumerable:!0,configurable:!0}),Object.defineProperty(c,"allChanges",{get:o,enumerable:!0,configurable:!0});var N=y.prototype.constructor;q.prototype=Object.create(y.prototype),q.prototype.applyChanges=function(){if(!this._id)throw new s("Cannot apply changes to object with no _id");var a=this;u.each(this.changes,function(b){b.apply(a)})},y.prototype=new q,c._SiestaModel=q,c.registerChange=C.registerChange,c.mergeChanges=n,c.changesForIdentifier=m,c.resetChanges=p},{"./index":2,"./pouch":3}],2:[function(a,b,c){function d(a,b){for(var c=function(a,b,d,e){if(0==a)return void(d.length>0&&(e[e.length]=d));for(var f=0;f<b.length;f++)c(a-1,b.slice(f+1),d.concat([b[f]]),e)},d=[],e=b;e<a.length;e++)c(e,a,[],d);return d.push(a),d}function e(a){var b=d(a,1);return b.push([]),b}function f(a,b,c){var d=e(c);return o.map(d,function(c){return new h(a,b,c)})}function g(a,b,c,d){var e=n.defer();d=m.constructCallbackAndPromiseHandler(d,e);var g=f(a,b,c),h=0,i=[];return o.each(g,function(a){a.install(function(a){a&&i.push(a),h++,h==g.length&&(q.info.isEnabled&&q.info("Successfully installed all indexes"),d(i.length?i:null))})}),e.promise}function h(a,b,c){this.type=b,this.collection=a,this.fields=c?c.length?o.sortBy(c,function(a){return a}):[c]:[]}var i=siesta._internal,j=i.error.InternalSiestaError,k=i.mapping,l=i.log,m=i.util,n=i.q,o=m._,p=a("./pouch"),q=l.loggerWithName("Index");q.setLevel(l.Level.warn),h.prototype._getDesignDocName=function(){var a=this._getName();return"_design/"+a},h.prototype._constructPouchDbView=function(){var a=this._getName(),b={_id:this._getDesignDocName(),views:{}};return b.views[a]={map:this._constructMapFunction()},b},h.prototype._constructMapFunction=function(){this._validate();var a=this.fields,b=this.type,c=this.collection;return k.constructMapFunction(c,b,a)},h.prototype._validate=function(){if(!this.type)throw new j("Type must be specified in order to construct index map function.",{index:this});if(!this.collection)throw new j("API must be specified in order to construct index map function.",{index:this})},h.prototype._dump=function(){return this._getName()},h.prototype._getName=function(){this._validate();var a=o.reduce(this.fields,function(a,b){return a+"_"+b},"");return this.collection+"_Index_"+this.type+a},h.prototype.install=function(a){var b=n.defer();a=m.constructCallbackAndPromiseHandler(a,b),this._validate();var c=this,d=this._constructPouchDbView(),e=this._getName();return q.debug.isEnabled&&q.debug("Installing Index: "+e,d),p.getPouch().put(d,function(b,d){b&&409===b.status&&(q.debug.isEnabled&&q.debug(e+" already installed"),b=null),!b&&h.indexes.indexOf(c)<0&&h.indexes.push(c),a(b,d)}),b.promise},h.indexes=[],c.Index=h,c._constructIndexes=f,c._getFieldCombinations=e,c.installIndexes=g,c.clearIndexes=function(){h.indexes=[]}},{"./pouch":3}],3:[function(a,b,c){function d(a,b,c){var e=t.defer();return c=o.constructCallbackAndPromiseHandler(c,e),h().get(a,function(e,f){if(e){var g='Unable to get doc with _id="'+a+'". This is a serious error and means that a live object is now out of sync with PouchDB.';v.error(g),c&&c(e)}else{for(var i in b)b.hasOwnProperty(i)&&(f[i]=b[i]);h().put(f,function(e,g){if(e)if(409==e.status)d(a,b);else{var h='Unable to update doc with _id="'+a+'". This is a serious error and means that a live object is now out of sync with PouchDB.';v.error(h),c&&c(e)}else v.trace.isEnabled&&v.trace("Successfully persisted unmergedChanges: "+JSON.stringify({doc:f._id,pouchDBResponse:g,changes:b},null,4)),c&&c(null,g.rev)})}}),e.promise}function e(){w&&w.cancel(),w=x.changes({since:"now",live:!0}),p.each(y,function(a){w.on(z,a)})}function f(a){var b=r();if(!a)throw"Only in memory pouchDB supported atm";if("undefined"==typeof window)throw"nyi";x=new PouchDB("siesta-"+b,{adapter:"memory"}),e()}function g(a,b){var c=t.defer();return b=o.constructCallbackAndPromiseHandler(b,c),x&&x.destroy(),f(a),b&&b(),c.promise}function h(){return x}function i(a){var b=a.collection;if(b){var c=u[b];if(c){var d=a.type;if(d){var e=c[d];if(e)return e;throw new s("Cannot convert PouchDB document into SiestaModel. No mapping with type "+d.toString(),{doc:a})}throw new s("Cannot convert PouchDB document into SiestaModel. No type field within document",{doc:a})}throw new s('Cannot convert PouchDB document into SiestaModel. API "'+b.toString()+'" doesnt exist.',{doc:a})}throw new s("Cannot convert PouchDB document into SiestaModel. No collection field within document",{doc:a})}function j(a){var b=i(a),c=b._new({_id:a._id});c._rev=a._rev,c.isSaved=!0;for(var d in a)a.hasOwnProperty(d)&&(c._fields.indexOf(d)>-1?c.__values[d]=a[d]:c._relationshipFields.indexOf(d)>-1&&(c[d+"Proxy"]._id=a[d]));return c}function k(a){v.debug.isEnabled&&v.debug("toSiesta");for(var b=[],c=0;c<a.length;c++){var d=a[c];if(d){var e={_id:d._id},f=d.type,g=d.collection,h=u[g][f];h.id&&(e[h.id]=d[h.id],e.mapping=h);var i=q.get(e);i?b[c]=i:(b[c]=j(d),q.insert(b[c]),b[c].applyChanges())}else b[c]=null}return b}function l(a){v.trace.isEnabled&&v.trace("from",{obj:a});var b=a.mapping,c={};return p.each(b._fields,function(b){v.trace.isEnabled&&v.trace("field",b);var d=a[b];v.trace.isEnabled&&v.trace(b+"=",d),d&&(c[b]=d)}),p.each(a._proxies,function(a){if(a.isForward){var b=a.forwardName;a._id&&(c[b]=a._id)}}),c._id=a._id,c._rev=a._rev,c.type=a.mapping.type,c.collection=a.collection,c}var m=siesta._internal,n=m.log,o=m.util,p=o._,q=m.cache,r=m.misc.guid,s=m.error.InternalSiestaError,t=m.q,u=m.CollectionRegistry,v=n.loggerWithName("Pouch");v.setLevel(n.Level.warn);var w,x=new PouchDB("siesta"),y=[];e();var z="change";c.toNew=j,c._validate=i,c.from=l,c.toSiesta=k,c.retryUntilWrittenMultiple=d,c.reset=g,c.getPouch=h,c.setPouch=function(a){x=a,e()},c.addObserver=function(a){v.debug.isEnabled&&v.debug("Adding observer",a),y.push(a),w&&w.on(z,a)},c.removeObserver=function(a){var b=y.indexOf(a);b>-1&&(w&&w.removeListener(z,a),y.splice(b,1))}},{}],4:[function(require,module,exports){function RawQuery(a,b,c){var d=this;this.collection=a,this.modelName=b,this.query=c,Object.defineProperty(d,"mapping",{configurable:!0,enumerable:!0,get:function(){var a=require("./index")[d.collection];return a?a[d.modelName]:null}})}function resultsCallback(a,b,c){var d=q.defer();if(a=util.constructCallbackAndPromiseHandler(a,d),b)a&&a(b);else{var e=_.pluck(c.rows,"value");a&&a(null,e)}return d.promise}var _i=siesta._internal,mapping=_i.mapping,utils=_i.utils,util=_i.utils,_=utils._,log=_i.log,InternalSiestaError=_i.error.InternalSiestaError,Query=_i.query.Query,q=_i.q,Logger=log.loggerWithName("RawQuery");Logger.setLevel(log.Level.warn);var Pouch=require("./pouch"),index=require("./index"),Index=index.Index;RawQuery.prototype.execute=function(callback){var deferred=q.defer();if(callback=util.constructCallbackAndPromiseHandler(callback,deferred),this.mapping&&!this.mapping.installed)throw new InternalSiestaError("Mapping must be installed");var self=this,designDocId=this._getDesignDocName(),indexName=self._getIndexName();return Pouch.getPouch().get(designDocId,function(err){function finish(a,b){Logger.trace.isEnabled&&Logger.trace("Received results: ",b),partialCallback(a,b)}var partialCallback=_.partial(resultsCallback,callback),key;if(err)if(404==err.status){Logger.warn('Couldnt find index "'+indexName+'" and hence must iterate through every single document.');var fields=self._sortedFields(),f=mapping.constructMapFunction(self.collection,self.modelName,fields);eval("var mapFunc = "+f),key=self._constructKey(fields),key.length||(key=self.modelName),Pouch.getPouch().query(mapFunc,{key:key},finish)}else finish(err);else key=self._constructKey(),key.length||(key=self.modelName),Logger.debug.isEnabled&&Logger.debug("Executing query "+indexName+": "+key),Pouch.getPouch().query(indexName,{key:key},finish)}),deferred.promise},RawQuery.prototype._getFields=function(){var a=[];for(var b in this.query)this.query.hasOwnProperty(b)&&a.push(b);return a},RawQuery.prototype._sortedFields=function(){var a=this._getFields();return _.sortBy(a,function(a){return a})},RawQuery.prototype._constructKey=function(){var a=this,b=this._sortedFields(),c=_.reduce(b,function(b,c){var d;return d=null===c?"null":void 0===c?"undefined":a.query[c].toString(),b+d+"_"},"");return c.substring(0,c.length-1)},RawQuery.prototype._getDesignDocName=function(){var a=new index.Index(this.collection,this.modelName,this._getFields());return a._getDesignDocName()},RawQuery.prototype._getIndexName=function(){var a=new index.Index(this.collection,this.modelName,this._getFields());return a._getName()},RawQuery.prototype._dump=function(a){var b={};return b.collection=this.collection,b.mapping=this.modelName,b.query=this.query,b.index=this._getIndexName(),b.designDoc=this._getDesignDocName(),a?JSON.stringify(b,null,4):b},exports.RawQuery=RawQuery},{"./index":2,"./pouch":3}],5:[function(a){!function(){var b=siesta._internal,c=b.mapping,d=b.q,e=b.util,f=(_.extend,c.Mapping),g=a("./changes"),h=a("./pouch"),i=a("./query"),j=a("./index"),k=a("./store"),l=siesta.reset;siesta.reset=function(a,b){g.resetChanges(),j.clearIndexes(),h.reset(a,b),l.apply(l,arguments)};var m=c.Mapping.prototype.install;f.prototype.getIndexesToInstall=function(){var a=this,b=_.reduce(a._fields,function(a,b){return a[b]={},a},{});for(var c in a.relationships)if(a.relationships.hasOwnProperty(c)){var d=a.relationships[c];d.reverse!=c&&(b[c]={})}var e=_.reduce(a.indexes,function(a,c){return b[c]&&a.push(c),a},[]);return a.id&&e.push(a.id),e},f.prototype.install=function(a){var b=d.defer();a=e.constructCallbackAndPromiseHandler(a,b);var c=this;return m.call(this,function(b){if(b)a&&a(b);else{var d=c.getIndexesToInstall();j.installIndexes(c.collection,c.type,d,function(b){c._installed=!b,a&&a(b)})}}),b.promise},siesta.ext||(siesta.ext={}),siesta.ext.storage={changes:g,pouch:h,Pouch:h,query:i,index:j,store:k,Index:j.Index,RawQuery:i.RawQuery}}()},{"./changes":1,"./index":2,"./pouch":3,"./query":4,"./store":6}],6:[function(a,b,c){function d(a,b){n.getPouch().get(a._id).then(function(a){var c=n.toSiesta([a]);b&&b(null,c.length?c[0]:null)},h(b))}function e(a,b){var c=l.defer();return b=i.constructCallbackAndPromiseHandler(b,c),n.getPouch().allDocs({keys:a.notCached,include_docs:!0},function(c,d){if(c)b(c);else{var e=j.pluck(d.rows,"doc"),f=n.toSiesta(e);j.each(f,function(b){b&&(a.cached[b._id]=b)}),b()}}),c.promise}function f(a,b,c,d){m.trace.isEnabled&&m.trace("getMultipleRemoteFrompouch("+a.type+"):",b);var e=l.defer();d=i.constructCallbackAndPromiseHandler(d,e);var f=new p(a.collection,a.type,[a.id]),g=f._getName();return n.getPouch().query(g,{keys:j.map(b,function(a){return a.toString()}),include_docs:!0},function(b,e){if(b)d(b);else{var f=j.pluck(e.rows,"value");m.trace.isEnabled&&m.trace("[ROWS] getMultipleRemoteFrompouch("+a.type+"):",f);var g=n.toSiesta(f);j.each(g,function(b){var d=b[a.id];c.cached[d]=b;var e=c.notCached.indexOf(d);c.notCached.splice(e,1)}),m.trace.isEnabled&&m.trace("[RESULTS] getMultipleRemoteFrompouch("+a.type+"):",c),d()}}),e.promise}var g=siesta._internal,h=g.misc.wrappedCallback,i=g.util,j=i._,k=(g.cache,g.error.InternalSiestaError,g.log),l=(g.store,g.q),m=k.loggerWithName("Store");m.setLevel(k.Level.warn);var n=a("./pouch"),o=a("./index"),p=o.Index;c.getFromPouch=d,c.getMultipleLocalFromCouch=e,c.getMultipleRemoteFrompouch=f},{"./index":2,"./pouch":3}]},{},[5]);