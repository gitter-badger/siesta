!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){var d=a("./src/collection"),e=a("./src/util"),f=a("./src/collectionRegistry").CollectionRegistry,g=d.Collection,h=a("./src/cache"),i=a("./src/mapping").Mapping,j=a("./src/notificationCentre").notificationCentre,k=a("./vendor/operations.js/src/operation").Operation,l=a("./vendor/operations.js/src/queue").OperationQueue,m=a("./src/relationship").RelationshipType,n=a("./vendor/operations.js/src/log"),o=a("q"),p=e._;k.logLevel=n.Level.warn,l.logLevel=n.Level.warn;var q;q="undefined"!=typeof b?b.exports:{},q.reset=function(){h.reset(),f.reset(),q.ext.http.DescriptorRegistry.reset()},q.on=p.bind(j.on,j),q.addListener=q.on,q.off=p.bind(j.removeListener,j),q.removeListener=q.off,q.once=p.bind(j.once,j),q.removeAllListeners=p.bind(j.removeAllListeners,j),q.Collection=g,q.RelationshipType=m;var r=a("./src/changes");q._internal={log:n,Mapping:i,mapping:a("./src/mapping"),error:a("./src/error"),ChangeType:r.ChangeType,object:a("./src/object"),extend:a("extend"),notificationCentre:a("./src/notificationCentre"),cache:a("./src/cache"),misc:a("./src/misc"),Operation:k,OperationQueue:l,coreChanges:r,CollectionRegistry:a("./src/collectionRegistry").CollectionRegistry,Collection:d.Collection,collection:d,utils:e,util:e,_:e._,query:a("./src/query"),store:a("./src/store"),q:a("q")},q.performanceMonitoringEnabled=!1,q.httpEnabled=!1,q.storageEnabled=!1,q.ext={},Object.defineProperty(q.ext,"httpEnabled",{get:function(){return void 0!==q.ext._httpEnabled?q.ext._httpEnabled:!!q.ext.http},set:function(a){q.ext._httpEnabled=a}}),q.collection=function(a,b){return new g(a,b)},q.setAjax=function(a){if(!q.ext.httpEnabled)throw new Error("http module not installed correctly (have you included siesta.http.js?)");q.ext.http.ajax=a},q.getAjax=function(){return q.ext.http.ajax},q.notify=e.next,q.LogLevel=n.Level,q.setLogLevel=function(a,b){var c=n.loggerWithName(a);c.setLevel(b)},q.serialisers={},q.serializers=q.serialisers,Object.defineProperty(q.serialisers,"id",{get:function(){return q.ext.httpEnabled?q.ext.http.Serialiser.idSerialiser:null}}),Object.defineProperty(q.serialisers,"depth",{get:function(){return q.ext.httpEnabled?q.ext.http.Serialiser.depthSerializer:null}}),q.map=e._.map,q.each=e._.each,q.partial=e._.partial,q.bind=e._.bind,q.pluck=e._.pluck,q.property=e._.pluck,q.sortBy=e._.sortBy,q.series=e.series,q.parallel=e.parallel,q.q=o,"undefined"!=typeof window&&(window.siesta=q),c.siesta=q},{"./src/cache":6,"./src/changes":7,"./src/collection":8,"./src/collectionRegistry":9,"./src/error":10,"./src/mapping":12,"./src/misc":14,"./src/notificationCentre":15,"./src/object":16,"./src/query":20,"./src/relationship":21,"./src/store":22,"./src/util":23,"./vendor/operations.js/src/log":25,"./vendor/operations.js/src/operation":26,"./vendor/operations.js/src/queue":27,extend:4,q:5}],2:[function(a,b){function c(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function d(a){return"function"==typeof a}function e(a){return"number"==typeof a}function f(a){return"object"==typeof a&&null!==a}function g(a){return void 0===a}b.exports=c,c.EventEmitter=c,c.prototype._events=void 0,c.prototype._maxListeners=void 0,c.defaultMaxListeners=10,c.prototype.setMaxListeners=function(a){if(!e(a)||0>a||isNaN(a))throw TypeError("n must be a positive number");return this._maxListeners=a,this},c.prototype.emit=function(a){var b,c,e,h,i,j;if(this._events||(this._events={}),"error"===a&&(!this._events.error||f(this._events.error)&&!this._events.error.length)){if(b=arguments[1],b instanceof Error)throw b;throw TypeError('Uncaught, unspecified "error" event.')}if(c=this._events[a],g(c))return!1;if(d(c))switch(arguments.length){case 1:c.call(this);break;case 2:c.call(this,arguments[1]);break;case 3:c.call(this,arguments[1],arguments[2]);break;default:for(e=arguments.length,h=new Array(e-1),i=1;e>i;i++)h[i-1]=arguments[i];c.apply(this,h)}else if(f(c)){for(e=arguments.length,h=new Array(e-1),i=1;e>i;i++)h[i-1]=arguments[i];for(j=c.slice(),e=j.length,i=0;e>i;i++)j[i].apply(this,h)}return!0},c.prototype.addListener=function(a,b){var e;if(!d(b))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",a,d(b.listener)?b.listener:b),this._events[a]?f(this._events[a])?this._events[a].push(b):this._events[a]=[this._events[a],b]:this._events[a]=b,f(this._events[a])&&!this._events[a].warned){var e;e=g(this._maxListeners)?c.defaultMaxListeners:this._maxListeners,e&&e>0&&this._events[a].length>e&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),"function"==typeof console.trace&&console.trace())}return this},c.prototype.on=c.prototype.addListener,c.prototype.once=function(a,b){function c(){this.removeListener(a,c),e||(e=!0,b.apply(this,arguments))}if(!d(b))throw TypeError("listener must be a function");var e=!1;return c.listener=b,this.on(a,c),this},c.prototype.removeListener=function(a,b){var c,e,g,h;if(!d(b))throw TypeError("listener must be a function");if(!this._events||!this._events[a])return this;if(c=this._events[a],g=c.length,e=-1,c===b||d(c.listener)&&c.listener===b)delete this._events[a],this._events.removeListener&&this.emit("removeListener",a,b);else if(f(c)){for(h=g;h-->0;)if(c[h]===b||c[h].listener&&c[h].listener===b){e=h;break}if(0>e)return this;1===c.length?(c.length=0,delete this._events[a]):c.splice(e,1),this._events.removeListener&&this.emit("removeListener",a,b)}return this},c.prototype.removeAllListeners=function(a){var b,c;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[a]&&delete this._events[a],this;if(0===arguments.length){for(b in this._events)"removeListener"!==b&&this.removeAllListeners(b);return this.removeAllListeners("removeListener"),this._events={},this}if(c=this._events[a],d(c))this.removeListener(a,c);else for(;c.length;)this.removeListener(a,c[c.length-1]);return delete this._events[a],this},c.prototype.listeners=function(a){var b;return b=this._events&&this._events[a]?d(this._events[a])?[this._events[a]]:this._events[a].slice():[]},c.listenerCount=function(a,b){var c;return c=a._events&&a._events[b]?d(a._events[b])?1:a._events[b].length:0}},{}],3:[function(a,b){function c(){}var d=b.exports={};d.nextTick=function(){var a="undefined"!=typeof window&&window.setImmediate,b="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(a)return function(a){return window.setImmediate(a)};if(b){var c=[];return window.addEventListener("message",function(a){var b=a.source;if((b===window||null===b)&&"process-tick"===a.data&&(a.stopPropagation(),c.length>0)){var d=c.shift();d()}},!0),function(a){c.push(a),window.postMessage("process-tick","*")}}return function(a){setTimeout(a,0)}}(),d.title="browser",d.browser=!0,d.env={},d.argv=[],d.on=c,d.addListener=c,d.once=c,d.off=c,d.removeListener=c,d.removeAllListeners=c,d.emit=c,d.binding=function(){throw new Error("process.binding is not supported")},d.cwd=function(){return"/"},d.chdir=function(){throw new Error("process.chdir is not supported")}},{}],4:[function(a,b){var c,d=Object.prototype.hasOwnProperty,e=Object.prototype.toString,f=function(a){"use strict";if(!a||"[object Object]"!==e.call(a)||a.nodeType||a.setInterval)return!1;var b=d.call(a,"constructor"),f=a.constructor&&a.constructor.prototype&&d.call(a.constructor.prototype,"isPrototypeOf");if(a.constructor&&!b&&!f)return!1;var g;for(g in a);return g===c||d.call(a,g)};b.exports=function g(){"use strict";var a,b,d,e,h,i,j=arguments[0],k=1,l=arguments.length,m=!1;for("boolean"==typeof j?(m=j,j=arguments[1]||{},k=2):("object"!=typeof j&&"function"!=typeof j||j==c)&&(j={});l>k;++k)if(null!=(a=arguments[k]))for(b in a)d=j[b],e=a[b],j!==e&&(m&&e&&(f(e)||(h=Array.isArray(e)))?(h?(h=!1,i=d&&Array.isArray(d)?d:[]):i=d&&f(d)?d:{},j[b]=g(m,i,e)):e!==c&&(j[b]=e));return j}},{}],5:[function(a,b,c){(function(a){!function(a){if("function"==typeof bootstrap)bootstrap("promise",a);else if("object"==typeof c)b.exports=a();else if("function"==typeof define&&define.amd)define(a);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeQ=a}else Q=a()}(function(){"use strict";function b(a){return function(){return W.apply(a,arguments)}}function c(a){return a===Object(a)}function d(a){return"[object StopIteration]"===cb(a)||a instanceof S}function e(a,b){if(P&&b.stack&&"object"==typeof a&&null!==a&&a.stack&&-1===a.stack.indexOf(db)){for(var c=[],d=b;d;d=d.source)d.stack&&c.unshift(d.stack);c.unshift(a.stack);var e=c.join("\n"+db+"\n");a.stack=f(e)}}function f(a){for(var b=a.split("\n"),c=[],d=0;d<b.length;++d){var e=b[d];i(e)||g(e)||!e||c.push(e)}return c.join("\n")}function g(a){return-1!==a.indexOf("(module.js:")||-1!==a.indexOf("(node.js:")}function h(a){var b=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(a);if(b)return[b[1],Number(b[2])];var c=/at ([^ ]+):(\d+):(?:\d+)$/.exec(a);if(c)return[c[1],Number(c[2])];var d=/.*@(.+):(\d+)$/.exec(a);return d?[d[1],Number(d[2])]:void 0}function i(a){var b=h(a);if(!b)return!1;var c=b[0],d=b[1];return c===R&&d>=T&&hb>=d}function j(){if(P)try{throw new Error}catch(a){var b=a.stack.split("\n"),c=b[0].indexOf("@")>0?b[1]:b[2],d=h(c);if(!d)return;return R=d[0],d[1]}}function k(a,b,c){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(b+" is deprecated, use "+c+" instead.",new Error("").stack),a.apply(a,arguments)}}function l(a){return s(a)?a:t(a)?C(a):B(a)}function m(){function a(a){b=a,f.source=a,Y(c,function(b,c){V(function(){a.promiseDispatch.apply(a,c)})},void 0),c=void 0,d=void 0}var b,c=[],d=[],e=_(m.prototype),f=_(p.prototype);if(f.promiseDispatch=function(a,e,f){var g=X(arguments);c?(c.push(g),"when"===e&&f[1]&&d.push(f[1])):V(function(){b.promiseDispatch.apply(b,g)})},f.valueOf=function(){if(c)return f;var a=r(b);return s(a)&&(b=a),a},f.inspect=function(){return b?b.inspect():{state:"pending"}},l.longStackSupport&&P)try{throw new Error}catch(g){f.stack=g.stack.substring(g.stack.indexOf("\n")+1)}return e.promise=f,e.resolve=function(c){b||a(l(c))},e.fulfill=function(c){b||a(B(c))},e.reject=function(c){b||a(A(c))},e.notify=function(a){b||Y(d,function(b,c){V(function(){c(a)})},void 0)},e}function n(a){if("function"!=typeof a)throw new TypeError("resolver must be a function.");var b=m();try{a(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}return b.promise}function o(a){return n(function(b,c){for(var d=0,e=a.length;e>d;d++)l(a[d]).then(b,c)})}function p(a,b,c){void 0===b&&(b=function(a){return A(new Error("Promise does not support operation: "+a))}),void 0===c&&(c=function(){return{state:"unknown"}});var d=_(p.prototype);if(d.promiseDispatch=function(c,e,f){var g;try{g=a[e]?a[e].apply(d,f):b.call(d,e,f)}catch(h){g=A(h)}c&&c(g)},d.inspect=c,c){var e=c();"rejected"===e.state&&(d.exception=e.reason),d.valueOf=function(){var a=c();return"pending"===a.state||"rejected"===a.state?d:a.value}}return d}function q(a,b,c,d){return l(a).then(b,c,d)}function r(a){if(s(a)){var b=a.inspect();if("fulfilled"===b.state)return b.value}return a}function s(a){return c(a)&&"function"==typeof a.promiseDispatch&&"function"==typeof a.inspect}function t(a){return c(a)&&"function"==typeof a.then}function u(a){return s(a)&&"pending"===a.inspect().state}function v(a){return!s(a)||"fulfilled"===a.inspect().state}function w(a){return s(a)&&"rejected"===a.inspect().state}function x(){eb.length=0,fb.length=0,gb||(gb=!0)}function y(a,b){gb&&(fb.push(a),eb.push(b&&"undefined"!=typeof b.stack?b.stack:"(no stack) "+b))}function z(a){if(gb){var b=Z(fb,a);-1!==b&&(fb.splice(b,1),eb.splice(b,1))}}function A(a){var b=p({when:function(b){return b&&z(this),b?b(a):this}},function(){return this},function(){return{state:"rejected",reason:a}});return y(b,a),b}function B(a){return p({when:function(){return a},get:function(b){return a[b]},set:function(b,c){a[b]=c},"delete":function(b){delete a[b]},post:function(b,c){return null===b||void 0===b?a.apply(void 0,c):a[b].apply(a,c)},apply:function(b,c){return a.apply(b,c)},keys:function(){return bb(a)}},void 0,function(){return{state:"fulfilled",value:a}})}function C(a){var b=m();return V(function(){try{a.then(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}}),b.promise}function D(a){return p({isDef:function(){}},function(b,c){return J(a,b,c)},function(){return l(a).inspect()})}function E(a,b,c){return l(a).spread(b,c)}function F(a){return function(){function b(a,b){var g;if("undefined"==typeof StopIteration){try{g=c[a](b)}catch(h){return A(h)}return g.done?g.value:q(g.value,e,f)}try{g=c[a](b)}catch(h){return d(h)?h.value:A(h)}return q(g,e,f)}var c=a.apply(this,arguments),e=b.bind(b,"next"),f=b.bind(b,"throw");return e()}}function G(a){l.done(l.async(a)())}function H(a){throw new S(a)}function I(a){return function(){return E([this,K(arguments)],function(b,c){return a.apply(b,c)})}}function J(a,b,c){return l(a).dispatch(b,c)}function K(a){return q(a,function(a){var b=0,c=m();return Y(a,function(d,e,f){var g;s(e)&&"fulfilled"===(g=e.inspect()).state?a[f]=g.value:(++b,q(e,function(d){a[f]=d,0===--b&&c.resolve(a)},c.reject,function(a){c.notify({index:f,value:a})}))},void 0),0===b&&c.resolve(a),c.promise})}function L(a){return q(a,function(a){return a=$(a,l),q(K($(a,function(a){return q(a,U,U)})),function(){return a})})}function M(a){return l(a).allSettled()}function N(a,b){return l(a).then(void 0,void 0,b)}function O(a,b){return l(a).nodeify(b)}var P=!1;try{throw new Error}catch(Q){P=!!Q.stack}var R,S,T=j(),U=function(){},V=function(){function b(){for(;c.next;){c=c.next;var a=c.task;c.task=void 0;var d=c.domain;d&&(c.domain=void 0,d.enter());try{a()}catch(f){if(g)throw d&&d.exit(),setTimeout(b,0),d&&d.enter(),f;setTimeout(function(){throw f},0)}d&&d.exit()}e=!1}var c={task:void 0,next:null},d=c,e=!1,f=void 0,g=!1;if(V=function(b){d=d.next={task:b,domain:g&&a.domain,next:null},e||(e=!0,f())},"undefined"!=typeof a&&a.nextTick)g=!0,f=function(){a.nextTick(b)};else if("function"==typeof setImmediate)f="undefined"!=typeof window?setImmediate.bind(window,b):function(){setImmediate(b)};else if("undefined"!=typeof MessageChannel){var h=new MessageChannel;h.port1.onmessage=function(){f=i,h.port1.onmessage=b,b()};var i=function(){h.port2.postMessage(0)};f=function(){setTimeout(b,0),i()}}else f=function(){setTimeout(b,0)};return V}(),W=Function.call,X=b(Array.prototype.slice),Y=b(Array.prototype.reduce||function(a,b){var c=0,d=this.length;if(1===arguments.length)for(;;){if(c in this){b=this[c++];break}if(++c>=d)throw new TypeError}for(;d>c;c++)c in this&&(b=a(b,this[c],c));return b}),Z=b(Array.prototype.indexOf||function(a){for(var b=0;b<this.length;b++)if(this[b]===a)return b;return-1}),$=b(Array.prototype.map||function(a,b){var c=this,d=[];return Y(c,function(e,f,g){d.push(a.call(b,f,g,c))},void 0),d}),_=Object.create||function(a){function b(){}return b.prototype=a,new b},ab=b(Object.prototype.hasOwnProperty),bb=Object.keys||function(a){var b=[];for(var c in a)ab(a,c)&&b.push(c);return b},cb=b(Object.prototype.toString);S="undefined"!=typeof ReturnValue?ReturnValue:function(a){this.value=a};var db="From previous event:";l.resolve=l,l.nextTick=V,l.longStackSupport=!1,l.defer=m,m.prototype.makeNodeResolver=function(){var a=this;return function(b,c){b?a.reject(b):a.resolve(arguments.length>2?X(arguments,1):c)}},l.Promise=n,l.promise=n,n.race=o,n.all=K,n.reject=A,n.resolve=l,l.passByCopy=function(a){return a},p.prototype.passByCopy=function(){return this},l.join=function(a,b){return l(a).join(b)},p.prototype.join=function(a){return l([this,a]).spread(function(a,b){if(a===b)return a;throw new Error("Can't join: not the same: "+a+" "+b)})},l.race=o,p.prototype.race=function(){return this.then(l.race)},l.makePromise=p,p.prototype.toString=function(){return"[object Promise]"},p.prototype.then=function(a,b,c){function d(b){try{return"function"==typeof a?a(b):b}catch(c){return A(c)}}function f(a){if("function"==typeof b){e(a,h);try{return b(a)}catch(c){return A(c)}}return A(a)}function g(a){return"function"==typeof c?c(a):a}var h=this,i=m(),j=!1;return V(function(){h.promiseDispatch(function(a){j||(j=!0,i.resolve(d(a)))},"when",[function(a){j||(j=!0,i.resolve(f(a)))}])}),h.promiseDispatch(void 0,"when",[void 0,function(a){var b,c=!1;try{b=g(a)}catch(d){if(c=!0,!l.onerror)throw d;l.onerror(d)}c||i.notify(b)}]),i.promise},l.when=q,p.prototype.thenResolve=function(a){return this.then(function(){return a})},l.thenResolve=function(a,b){return l(a).thenResolve(b)},p.prototype.thenReject=function(a){return this.then(function(){throw a})},l.thenReject=function(a,b){return l(a).thenReject(b)},l.nearer=r,l.isPromise=s,l.isPromiseAlike=t,l.isPending=u,p.prototype.isPending=function(){return"pending"===this.inspect().state},l.isFulfilled=v,p.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state},l.isRejected=w,p.prototype.isRejected=function(){return"rejected"===this.inspect().state};var eb=[],fb=[],gb=!0;l.resetUnhandledRejections=x,l.getUnhandledReasons=function(){return eb.slice()},l.stopUnhandledRejectionTracking=function(){x(),gb=!1},x(),l.reject=A,l.fulfill=B,l.master=D,l.spread=E,p.prototype.spread=function(a,b){return this.all().then(function(b){return a.apply(void 0,b)},b)},l.async=F,l.spawn=G,l["return"]=H,l.promised=I,l.dispatch=J,p.prototype.dispatch=function(a,b){var c=this,d=m();return V(function(){c.promiseDispatch(d.resolve,a,b)}),d.promise},l.get=function(a,b){return l(a).dispatch("get",[b])},p.prototype.get=function(a){return this.dispatch("get",[a])},l.set=function(a,b,c){return l(a).dispatch("set",[b,c])},p.prototype.set=function(a,b){return this.dispatch("set",[a,b])},l.del=l["delete"]=function(a,b){return l(a).dispatch("delete",[b])},p.prototype.del=p.prototype["delete"]=function(a){return this.dispatch("delete",[a])},l.mapply=l.post=function(a,b,c){return l(a).dispatch("post",[b,c])},p.prototype.mapply=p.prototype.post=function(a,b){return this.dispatch("post",[a,b])},l.send=l.mcall=l.invoke=function(a,b){return l(a).dispatch("post",[b,X(arguments,2)])},p.prototype.send=p.prototype.mcall=p.prototype.invoke=function(a){return this.dispatch("post",[a,X(arguments,1)])},l.fapply=function(a,b){return l(a).dispatch("apply",[void 0,b])},p.prototype.fapply=function(a){return this.dispatch("apply",[void 0,a])},l["try"]=l.fcall=function(a){return l(a).dispatch("apply",[void 0,X(arguments,1)])},p.prototype.fcall=function(){return this.dispatch("apply",[void 0,X(arguments)])},l.fbind=function(a){var b=l(a),c=X(arguments,1);return function(){return b.dispatch("apply",[this,c.concat(X(arguments))])}},p.prototype.fbind=function(){var a=this,b=X(arguments);return function(){return a.dispatch("apply",[this,b.concat(X(arguments))])}},l.keys=function(a){return l(a).dispatch("keys",[])},p.prototype.keys=function(){return this.dispatch("keys",[])},l.all=K,p.prototype.all=function(){return K(this)},l.allResolved=k(L,"allResolved","allSettled"),p.prototype.allResolved=function(){return L(this)},l.allSettled=M,p.prototype.allSettled=function(){return this.then(function(a){return K($(a,function(a){function b(){return a.inspect()}return a=l(a),a.then(b,b)}))})},l.fail=l["catch"]=function(a,b){return l(a).then(void 0,b)},p.prototype.fail=p.prototype["catch"]=function(a){return this.then(void 0,a)},l.progress=N,p.prototype.progress=function(a){return this.then(void 0,void 0,a)},l.fin=l["finally"]=function(a,b){return l(a)["finally"](b)},p.prototype.fin=p.prototype["finally"]=function(a){return a=l(a),this.then(function(b){return a.fcall().then(function(){return b})},function(b){return a.fcall().then(function(){throw b})})},l.done=function(a,b,c,d){return l(a).done(b,c,d)},p.prototype.done=function(b,c,d){var f=function(a){V(function(){if(e(a,g),!l.onerror)throw a;l.onerror(a)})},g=b||c||d?this.then(b,c,d):this;"object"==typeof a&&a&&a.domain&&(f=a.domain.bind(f)),g.then(void 0,f)},l.timeout=function(a,b,c){return l(a).timeout(b,c)},p.prototype.timeout=function(a,b){var c=m(),d=setTimeout(function(){c.reject(new Error(b||"Timed out after "+a+" ms"))},a);return this.then(function(a){clearTimeout(d),c.resolve(a)},function(a){clearTimeout(d),c.reject(a)},c.notify),c.promise},l.delay=function(a,b){return void 0===b&&(b=a,a=void 0),l(a).delay(b)},p.prototype.delay=function(a){return this.then(function(b){var c=m();return setTimeout(function(){c.resolve(b)},a),c.promise})},l.nfapply=function(a,b){return l(a).nfapply(b)},p.prototype.nfapply=function(a){var b=m(),c=X(a);return c.push(b.makeNodeResolver()),this.fapply(c).fail(b.reject),b.promise},l.nfcall=function(a){var b=X(arguments,1);return l(a).nfapply(b)},p.prototype.nfcall=function(){var a=X(arguments),b=m();return a.push(b.makeNodeResolver()),this.fapply(a).fail(b.reject),b.promise},l.nfbind=l.denodeify=function(a){var b=X(arguments,1);return function(){var c=b.concat(X(arguments)),d=m();return c.push(d.makeNodeResolver()),l(a).fapply(c).fail(d.reject),d.promise}},p.prototype.nfbind=p.prototype.denodeify=function(){var a=X(arguments);return a.unshift(this),l.denodeify.apply(void 0,a)},l.nbind=function(a,b){var c=X(arguments,2);return function(){function d(){return a.apply(b,arguments)}var e=c.concat(X(arguments)),f=m();return e.push(f.makeNodeResolver()),l(d).fapply(e).fail(f.reject),f.promise}},p.prototype.nbind=function(){var a=X(arguments,0);return a.unshift(this),l.nbind.apply(void 0,a)},l.nmapply=l.npost=function(a,b,c){return l(a).npost(b,c)},p.prototype.nmapply=p.prototype.npost=function(a,b){var c=X(b||[]),d=m();return c.push(d.makeNodeResolver()),this.dispatch("post",[a,c]).fail(d.reject),d.promise},l.nsend=l.nmcall=l.ninvoke=function(a,b){var c=X(arguments,2),d=m();return c.push(d.makeNodeResolver()),l(a).dispatch("post",[b,c]).fail(d.reject),d.promise},p.prototype.nsend=p.prototype.nmcall=p.prototype.ninvoke=function(a){var b=X(arguments,1),c=m();return b.push(c.makeNodeResolver()),this.dispatch("post",[a,b]).fail(c.reject),c.promise},l.nodeify=O,p.prototype.nodeify=function(a){return a?void this.then(function(b){V(function(){a(null,b)})},function(b){V(function(){a(b)})}):this};var hb=j();return l})}).call(this,a("_process"))},{_process:3}],6:[function(a,b,c){function d(){y={},w={},x={}}function e(a){var b=w[a];return b?s.debug.isEnabled&&s.debug("Local cache hit: "+b._dump(!0)):s.debug.isEnabled&&s.debug("Local cache miss: "+a),b}function f(a){var b=a.type,c=a.collection,d=x[c];if(d){var e=d[b];if(e){var f=[];for(var g in e)e.hasOwnProperty(g)&&f.push(e[g]);if(f.length>1)throw new u("A singleton mapping has more than 1 object in the cache! This is a serious error. Either a mapping has been modified after objects have already been created, or something has gonevery wrong. Please file a bug report if the latter.");if(f.length)return f[0]}}return null}function g(a,b){var c=b.mapping.type,d=b.mapping.collection,e=y[d];if(e){var f=y[d][c];if(f){var g=f[a];return g?t.debug.isEnabled&&t.debug("Remote cache hit: "+g._dump(!0)):t.debug.isEnabled&&t.debug("Remote cache miss: "+a),g}}return t.debug.isEnabled&&t.debug("Remote cache miss: "+a),null}function h(a,b,c){if(!a){var d="Must pass an object when inserting to cache";throw t.error(d),new u(d)}var e=a.mapping.collection;if(!e)throw new u("Mapping has no collection",{mapping:a.mapping,obj:a});y[e]||(y[e]={});var f=a.mapping.type;if(!f)throw new u("Mapping has no type",{mapping:a.mapping,obj:a});y[e][f]||(y[e][f]={}),c&&(y[e][f][c]=null);var g=y[e][f][b];if(g){if(a!=g){var h="Object "+e.toString()+":"+f.toString()+"["+a.mapping.id+'="'+b+'"] already exists in the cache. This is a serious error, please file a bug report if you are experiencing this out in the wild';throw t.error(h,{obj:a,cachedObject:g}),v.printStackTrace(),new u(h)}t.debug.isEnabled&&t.debug("Object has already been inserted: "+a._dump(!0))}else y[e][f][b]=a,t.debug.isEnabled&&t.debug("Remote cache insert: "+a._dump(!0)),t.trace.isEnabled&&t.trace("Remote cache now looks like: "+i(!0))}function i(a){var b={};for(var c in y)if(y.hasOwnProperty(c)){var d={};b[c]=d;var e=y[c];for(var f in e)if(e.hasOwnProperty(f)){var g={};d[f]=g;var h=e[f];for(var i in h)h.hasOwnProperty(i)&&h[i]&&(g[i]=h[i]._dump())}}return a?JSON.stringify(b,null,4):b}function j(a){var b={};for(var c in w)w.hasOwnProperty(c)&&(b[c]=w[c]._dump());return a?JSON.stringify(b,null,4):b}function k(a){var b={localCache:j(),remoteCache:i()};return a?JSON.stringify(b,null,4):b}function l(){return y}function m(){return w}function n(a){s.debug.isEnabled&&s.debug("get",a);var b,c,d,h=a._id;if(h)return b=e(h),b?b:a.mapping?(c=a.mapping.id,d=a[c],s.debug.isEnabled&&s.debug(c+"="+d),g(d,a)):null;if(a.mapping){if(c=a.mapping.id,d=a[c])return g(d,a);if(a.mapping.singleton)return f(a.mapping)}else s.warn("Invalid opts to cache",{opts:a});return null}function o(a){var b=a._id;if(b){var c=a.mapping.collection,d=a.mapping.type;if(w[b]){if(w[b]!=a){var e='Object with _id="'+b.toString()+'" is already in the cache. This is a serious error. Please file a bug report if you are experiencing this out in the wild';throw s.error(e),new u(e)}}else s.debug.isEnabled&&s.debug("Local cache insert: "+a._dump(!0)),w[b]=a,s.trace.isEnabled&&s.trace("Local cache now looks like: "+j(!0)),x[c]||(x[c]={}),x[c][d]||(x[c][d]={}),x[c][a.type][b]=a}var f=a.idField,g=a[f];g?h(a,g):t.debug.isEnabled&&t.debug('No remote id ("'+f+'") so wont be placing in the remote cache',a)}function p(a){var b={_id:a._id},c=a.mapping;return c.id&&a[c.id]&&(b.mapping=c,b[c.id]=a[c.id]),!!n(b)}function q(a){if(!p(a))throw new u("Object was not in cache.");var b=a.mapping.collection,c=a.mapping.type,d=a._id;if(!c)throw u("No mapping name");if(!b)throw u("No collection name");if(!d)throw u("No _id");if(delete x[b][c][d],delete w[d],a.mapping.id){var e=a[a.mapping.id];delete y[b][c][e]}}function k(a){var b={localCache:j(),remoteCache:i()};return a?JSON.stringify(b,null,4):b}var r=a("../vendor/operations.js/src/log"),s=r.loggerWithName("LocalCache");s.setLevel(r.Level.warn);var t=r.loggerWithName("RemoteCache");t.setLevel(r.Level.warn);var u=a("./error").InternalSiestaError,v=a("./util"),w={},x={},y={};d(),c._remoteCache=l,c._localCache=m,Object.defineProperty(c,"_localCacheByType",{get:function(){return x}}),c.get=n,c.insert=o,c.remoteInsert=h,c.reset=d,c._dump=k,c.contains=p,c.remove=q},{"../vendor/operations.js/src/log":25,"./error":10,"./util":23}],7:[function(a,b,c){function d(a){this._opts=a,this._opts||(this._opts={}),h.call(this,"collection",this._opts),h.call(this,"mapping",this._opts),h.call(this,"_id",this._opts),h.call(this,"field",this._opts),h.call(this,"type",this._opts),h.call(this,"index",this._opts),h.call(this,"added",this._opts),h.call(this,"addedId",this._opts),h.call(this,"removed",this._opts),h.call(this,"removedId",this._opts),h.call(this,"new",this._opts),h.call(this,"newId",this._opts),h.call(this,"old",this._opts),h.call(this,"oldId",this._opts),h.call(this,"obj",this._opts)}function e(a,b,c){m.trace.isEnabled&&m.trace('Sending notification "'+a+'" of type '+c.type),i.emit(a,c);var d=a+":"+b;m.trace.isEnabled&&m.trace('Sending notification "'+d+'" of type '+c.type),i.emit(d,c);var e="Siesta";m.trace.isEnabled&&m.trace('Sending notification "'+e+'" of type '+c.type),i.emit(e,c);var f=c._id;m.trace.isEnabled&&m.trace('Sending notification "'+f+'" of type '+c.type),i.emit(f,c);var g=l[a];if(!g){var h='No such collection "'+a+'"';throw m.error(h,l),new j(h)}var k=g[b];if(!k){var h='No such mapping "'+b+'"';throw m.error(h,l),new j(h)}if(k.id&&c.obj[k.id]){var n=a+":"+b+":"+c.obj[k.id];m.trace.isEnabled&&m.trace('Sending notification "'+n+'" of type '+c.type),i.emit(n,c)}}function f(a){if(!a.mapping)throw new j("Must pass a mapping");if(!a.collection)throw new j("Must pass a collection");if(!a._id)throw new j("Must pass a local identifier");if(!a.obj)throw new j("Must pass the object")}function g(a){f(a);var b=a.collection,c=a.mapping,g=new d(a);return e(b,c,g),g}var h=a("./misc").defineSubProperty,i=a("./notificationCentre").notificationCentre,j=a("./error").InternalSiestaError,k=a("../vendor/operations.js/src/log"),l=a("./collectionRegistry").CollectionRegistry,m=k.loggerWithName("changes");m.setLevel(k.Level.warn);var n={Set:"Set",Splice:"Splice",Delete:"Delete",New:"New",Remove:"Remove"};d.prototype._dump=function(a){var b={};return b.collection="string"==typeof this.collection?this.collection:this.collection._dump(),b.mapping="string"==typeof this.mapping?this.mapping:this.mapping.type,b._id=this._id,b.field=this.field,b.type=this.type,this.index&&(b.index=this.index),this.added&&(b.added=_.map(this.added,function(a){return a._dump()})),this.removed&&(b.removed=_.map(this.removed,function(a){return a._dump()})),this.old&&(b.old=this.old),this.new&&(b.new=this.new),a?JSON.stringify(b,null,4):b},c.Change=d,c.registerChange=g,c.validateChange=f,c.ChangeType=n},{"../vendor/operations.js/src/log":25,"./collectionRegistry":9,"./error":10,"./misc":14,"./notificationCentre":15}],8:[function(a,b,c){function d(a){var b=this;if(!this)return new d(a);if(!a)throw new i("Collection must have a name");this._name=a,this._docId="Collection_"+this._name,this._rawMappings={},this._mappings={},this.baseURL="",this.installed=!1,g.register(this),Object.defineProperty(this,"name",{get:function(){return b._name}})}var e=a("../vendor/operations.js/src/log"),f=e.loggerWithName("Collection");f.setLevel(e.Level.warn);var g=a("./collectionRegistry").CollectionRegistry,h=a("../vendor/operations.js/src/operation").Operation,i=a("./error").InternalSiestaError,j=a("./mapping").Mapping,k=a("extend"),l=(a("../vendor/observe-js/src/observe").Platform,a("./util")),m=l._,n=a("q"),o=(a("./cache"),["PUT","PATCH","POST","DELETE"]);d.prototype.install=function(a){var b=n.defer(),c=this;if(this.installed){var d=new i('Collection "'+this._name+'" has already been installed');c._finaliseInstallation(d,a)}else{var e=[];for(var g in this._mappings)if(this._mappings.hasOwnProperty(g)){var j=this._mappings[g];e.push(j)}if(f.info.isEnabled&&f.info("There are "+e.length.toString()+" mappings to install"),e.length){var k=m.map(e,function(a){return new h("Install Mapping",m.bind(a.install,a))}),l=new h("Install Mappings",k);l.completion=function(){if(l.failed)f.error("Failed to install collection",l.error),c._finaliseInstallation(l.error,a);else{c.installed=!0;var b=[];m.each(e,function(a){f.info.isEnabled&&f.info('Installing relationships for mapping with name "'+a.type+'"');var c=a.installRelationships();c&&b.push(c)}),b.length||m.each(e,function(a){f.info.isEnabled&&f.info('Installing reverse relationships for mapping with name "'+a.type+'"');var c=a.installReverseRelationships();c&&b.push(c)});var d;1==b.length?d=b[0]:b.length&&(d=b),c._finaliseInstallation(d,a)}},l.start()}else c._finaliseInstallation(null,a)}return b.promise},d.prototype._finaliseInstallation=function(b,c){if(!b){this.installed=!0;var d=a("../index");d[this._name]=this}c&&c(b)},d.prototype._mapping=function(a,b){if(a){this._rawMappings[a]=b;var b=k(!0,{},b);b.type=a,b.collection=this._name;var c=new j(b);return this._mappings[a]=c,this[a]=c,c}throw new i("No name specified when creating mapping")},d.prototype.mapping=function(){var a=this;return arguments.length?1==arguments.length?l.isArray(arguments[0])?m.map(arguments[0],function(b){return a._mapping(b.name,b)}):this._mapping(arguments[0].name,arguments[0]):"string"==typeof arguments[0]?this._mapping(arguments[0],arguments[1]):m.map(arguments,function(b){return a._mapping(b.name,b)
}):null},d.prototype.descriptor=function(a){var b=[];if(!siesta.ext.httpEnabled)throw new i("HTTP module not installed");for(var c=siesta.ext.http._resolveMethod(a.method),d=[],e=[],f=0;f<c.length;f++){var g=c[f];o.indexOf(g)>-1?d.push(g):e.push(g)}if(d.length){var h=k({},a);h.method=d,h=new siesta.ext.http.RequestDescriptor(h),siesta.ext.http.DescriptorRegistry.registerRequestDescriptor(h),b.push(h)}if(e.length){var j=k({},a);j.method=e,j=new siesta.ext.http.ResponseDescriptor(j),siesta.ext.http.DescriptorRegistry.registerResponseDescriptor(j),b.push(j)}return b},d.prototype._dump=function(a){var b={};return b.installed=this.installed,b.docId=this._docId,b.name=this._name,b.baseURL=this.baseURL,a?JSON.stringify(b,null,4):b},d.prototype._http=function(a){if(!siesta.ext.httpEnabled)throw i("HTTP module not enabled");var b=Array.prototype.slice.call(arguments,1);b.unshift(this);var c=siesta.ext.http[a];c.apply(c,b)},d.prototype.GET=function(){m.partial(this._http,"GET").apply(this,arguments)},d.prototype.OPTIONS=function(){m.partial(this._http,"OPTIONS").apply(this,arguments)},d.prototype.TRACE=function(){m.partial(this._http,"TRACE").apply(this,arguments)},d.prototype.HEAD=function(){m.partial(this._http,"HEAD").apply(this,arguments)},d.prototype.POST=function(){m.partial(this._http,"POST").apply(this,arguments)},d.prototype.PUT=function(){m.partial(this._http,"PUT").apply(this,arguments)},d.prototype.PATCH=function(){m.partial(this._http,"PATCH").apply(this,arguments)},d.prototype.DELETE=function(){m.partial(this._http,"DELETE").apply(this,arguments)},d.prototype.count=function(a){var b=n.defer();a=l.constructCallbackAndPromiseHandler(a,b);var c=m.map(this._mappings,function(a){return m.bind(a.count,a)});return l.parallel(c,function(b,c){var d;b||(d=m.reduce(c,function(a,b){return a+b},0)),a(b,d)}),b.promise},c.Collection=d},{"../index":1,"../vendor/observe-js/src/observe":24,"../vendor/operations.js/src/log":25,"../vendor/operations.js/src/operation":26,"./cache":6,"./collectionRegistry":9,"./error":10,"./mapping":12,"./util":23,extend:4,q:5}],9:[function(a,b,c){function d(){return this?void(this.collectionNames=[]):new d}var e=a("./util")._;d.prototype.register=function(a){var b=a._name;this[b]=a,this.collectionNames.push(b)},d.prototype.reset=function(){var a=this;e.each(this.collectionNames,function(b){delete a[b]}),this.collectionNames=[]},c.CollectionRegistry=new d},{"./util":23}],10:[function(a,b,c){function d(a,b,c){this.message=a,this.context=b,c=c||arguments.callee,c&&Error.captureStackTrace&&Error.captureStackTrace(this,c)}d.prototype=Object.create(Error.prototype),d.prototype.name="InternalSiestaError",d.prototype.constructor=d,c.InternalSiestaError=d},{}],11:[function(a,b,c){function d(a){j.call(this,a);var b=this;Object.defineProperty(this,"isFault",{get:function(){return b._id?!b.related:!0},set:function(a){a?(b._id=void 0,b.related=null):b._id||(b._id=[],b.related=[],g.call(b,b.related))}}),this._reverseIsArray=!0}function e(a){var b=this;m.each(a,function(a){var c=i.getReverseProxyForObject.call(b,a),d=c._id.indexOf(b.object._id);i.makeChangesToRelatedWithoutObservations.call(c,function(){i.splice.call(c,d,1)})})}function f(a){var b=this;m.each(a,function(a){var c=i.getReverseProxyForObject.call(b,a);i.makeChangesToRelatedWithoutObservations.call(c,function(){i.splice.call(c,0,0,b.object)})})}function g(a){var b=this;if(p(a,this.reverseName,this.object),!a.oneToManyObserver){a.oneToManyObserver=new q(a);var c=function(c){c.forEach(function(c){var d=c.addedCount?a.slice(c.index,c.index+c.addedCount):[],g=c.removed;e.call(b,g),f.call(b,d);var h=i.getForwardMapping.call(b);n.registerChange({collection:h.collection,mapping:h.type,_id:b.object._id,field:i.getForwardName.call(b),removed:g,added:d,removedId:m.pluck(g,"_id"),addedId:m.pluck(d,"_id"),type:r.Splice,index:c.index,obj:b.object})})};a.oneToManyObserver.open(c)}}function h(a){return"[object Array]"!=Object.prototype.toString.call(a)?"Cannot assign scalar to many to many":null}var i=a("./proxy"),j=i.RelationshipProxy,k=a("./store"),l=a("./util"),m=l._,n=(a("./error").InternalSiestaError,a("./changes")),o=a("./notificationCentre"),p=o.wrapArray,q=(a("./object").SiestaModel,a("../vendor/observe-js/src/observe").ArrayObserver),r=a("./changes").ChangeType,s=a("q");d.prototype=Object.create(j.prototype),d.prototype.get=function(a){var b=s.defer();a=l.constructCallbackAndPromiseHandler(a,b);var c=this;return this.isFault?k.get({_id:this._id},function(b,d){b?a&&a(b):(c.related=d,a&&a(null,d))}):a&&a(null,this.related),b.promise},d.prototype.set=function(a){i.checkInstalled.call(this);var b=this;if(a){var c;if(c=h.call(this,a))return c;i.clearReverseRelated.call(this),i.set.call(b,a),g.call(b,a),i.setReverse.call(b,a)}else i.clearReverseRelated.call(this),i.set.call(b,a)},d.prototype.install=function(a){j.prototype.install.call(this,a),a["splice"+l.capitaliseFirstLetter(this.reverseName)]=m.bind(i.splice,this)},c.ManyToManyProxy=d},{"../vendor/observe-js/src/observe":24,"./changes":7,"./error":10,"./notificationCentre":15,"./object":16,"./proxy":19,"./store":22,"./util":23,q:5}],12:[function(a,b,c){function d(a){var b=this;this._opts=a,Object.defineProperty(this,"_fields",{get:function(){var a=[];return b._opts.id&&a.push(b._opts.id),b._opts.attributes&&D.each(b._opts.attributes,function(b){a.push(b)}),a},enumerable:!0,configurable:!0}),l.call(this,"type",b._opts),l.call(this,"id",b._opts),l.call(this,"collection",b._opts),l.call(this,"attributes",b._opts),l.call(this,"relationships",b._opts),l.call(this,"indexes",b._opts),l.call(this,"subclass",b._opts),l.call(this,"singleton",b._opts),this.relationships||(this.relationships=[]),this.indexes||(this.indexes=[]),this._validateSubclass(),this._installed=!1,this._relationshipsInstalled=!1,this._reverseRelationshipsInstalled=!1,Object.defineProperty(this,"installed",{get:function(){return b._installed&&b._relationshipsInstalled&&b._reverseRelationshipsInstalled},enumerable:!0,configurable:!0})}function e(){var a=u._localCacheByType[this.collection]||{},b=a[this.type]||{};return D.reduce(Object.keys(b),function(a,b){return a[b]={},a},{})}function f(a,b,c){return this?(this.message=a,this.context=b,c=c||arguments.callee,void(c&&n.captureStackTrace&&n.captureStackTrace(this,c))):new f(a,b)}function g(a){var b=D.reduce(a,function(a,b){return a+'"'+b+'",'},"");return b=b.substring(0,b.length-1),"["+b+"]"}function h(a,b,c){var d,e=1==c.length&&!c[0].length,f=!c.length||e,h=g(c);return f?d=function(a){var b="$2",c="$3";a.type==b&&a.collection==c&&emit(a.type,a)}.toString():(d=function(a){var b="$2",c="$3";if(a.type==b&&a.collection==c){var d=$1,e="";for(var f in d){var g=d[f],h=a[g];e+=null!==h&&void 0!==h?h.toString()+"_":null===h?"null_":"undefined_"}e=e.substring(0,e.length-1),emit(e,a)}}.toString(),d=d.replace("$1",h)),d=d.replace("$2",b),d=d.replace("$3",a)}function i(a,b,c){var d,e=1==c.length&&!c[0].length,f=!c.length||e;return d=f?function(c){c.type==b&&c.collection==a&&emit(c.type,c)}:function(d){if(d.type==b&&d.collection==a){var e="";for(var f in c){var g=c[f],h=d[g];e+=null!==h&&void 0!==h?h.toString()+"_":null===h?"null_":"undefined_"}e=e.substring(0,e.length-1),emit(e,d)}}}var j=a("../vendor/operations.js/src/log"),k=j.loggerWithName("Mapping");k.setLevel(j.Level.warn);var l=a("./misc").defineSubProperty,m=a("./collectionRegistry").CollectionRegistry,n=a("./error").InternalSiestaError,o=a("./relationship"),p=o.RelationshipType,q=a("./query").Query,r=(a("../vendor/operations.js/src/operation").Operation,a("./mappingOperation").BulkMappingOperation),s=a("./object").SiestaModel,t=a("./misc").guid,u=a("./cache"),v=(a("./store"),a("extend")),w=a("./changes"),x=w.ChangeType,y=a("./notificationCentre").wrapArray,z=a("./oneToManyProxy").OneToManyProxy,A=a("./oneToOneProxy").OneToOneProxy,B=a("./manyToManyProxy").ManyToManyProxy,C=a("./util"),D=C._,E=a("q");d.prototype._validateSubclass=function(){if(this.subclass&&this.subclass!==s){var a=new this.subclass(this);if(!a.mapping)throw new n('Subclass for mapping "'+this.type+'" has not been configured correctly. Did you call super?');if(this.subclass.prototype==s.prototype)throw new n('Subclass for mapping "'+this.type+'" has not been configured correctly. You should use Object.create on SiestaModel prototype.')}},d.prototype.installRelationships=function(){if(this._relationshipsInstalled)throw new n('Relationships for "'+this.type+'" have already been installed');var a=this;if(a._relationships=[],a._opts.relationships)for(var b in a._opts.relationships)if(k.debug.isEnabled&&k.debug(a.type+": configuring relationship "+b),a._opts.relationships.hasOwnProperty(b)){var c=a._opts.relationships[b];if(c.type!=p.OneToMany&&c.type!=p.OneToOne&&c.type!=p.ManyToMany)return"Relationship type "+c.type+" does not exist";var d=c.mapping;if(k.debug.isEnabled&&k.debug("reverseMappingName",d),!a.collection)throw new n("Mapping must have collection");var e=m[a.collection];if(!e)throw new n("Collection "+a.collection+" not registered");var f=e[d];if(!f){var g=d.split(".");if(2==g.length){var h=g[0];d=g[1];var i=m[h];if(!i){var j='Collection with name "'+h+'" does not exist.';return console.error(j,{registry:m}),j}f=i[d]}}if(k.debug.isEnabled&&k.debug("reverseMapping",f),!f)return'Mapping with name "'+d.toString()+'" does not exist';c.reverseMapping=f,c.forwardMapping=this,c.forwardName=b,c.reverseName=c.reverse,c.isReverse=!1}return this._relationshipsInstalled=!0,null},d.prototype.installReverseRelationships=function(){if(this._reverseRelationshipsInstalled)throw new n('Reverse relationships for "'+this.type+'" have already been installed.');for(var a in this.relationships)if(this.relationships.hasOwnProperty(a)){var b=this.relationships[a];b=v(!0,{},b),b.isReverse=!0;var c=b.reverseMapping,d=b.reverseName;k.debug.isEnabled&&k.debug(self.type+": configuring  reverse relationship "+name),c.relationships[d]=b}this._reverseRelationshipsInstalled=!0},d.prototype.query=function(a,b){var c=E.defer();b=C.constructCallbackAndPromiseHandler(b,c);var d=new q(this,a);return d.execute(b),c.promise},d.prototype.get=function(a,b){function c(a,c){b&&b(a,c)}var d=E.defer();if(b=C.constructCallbackAndPromiseHandler(b,d),this.singleton)"function"==typeof a&&(b=a),this.all(function(a,b){if(a&&c(a),b.length>1)throw new n("Somehow more than one object has been created for a singleton mapping! This is a serious error, please file a bug report.");b.length?c(null,b[0]):c(null,b[0])});else{var e={};e[this.id]=a,e.mapping=this;var f=u.get(e);if(f)c(null,f);else{delete e.mapping;var g=new q(this,e);g.execute(function(b,d){var e=null;!b&&d.length&&(d.length>1?b="More than one object with id="+a.toString():e=d[0]),c(b,e)})}}return d.promise},d.prototype.all=function(a){var b=E.defer();a=C.constructCallbackAndPromiseHandler(a,b);var c=new q(this,{});return c.execute(a),b.promise},d.prototype.install=function(a){k.info.isEnabled&&k.info("Installing mapping "+this.type);var b=E.defer();if(a=C.constructCallbackAndPromiseHandler(a,b),this._installed)throw new n('Mapping "'+this.type+'" has already been installed');var c=this._validate();return this._installed=!0,k.info.isEnabled&&(c.length?k.error("Errors installing mapping "+this.type+": "+c):k.info("Installed mapping "+this.type)),a&&a(c.length?c:null),b.promise},d.prototype._validate=function(){var a=[];return this.type||a.push("Must specify a type"),this.collection||a.push("A mapping must belong to an collection"),a},d.prototype.map=function(a,b,c){var d=E.defer();if(b=C.constructCallbackAndPromiseHandler(b,d),!this.installed)throw new n("Mapping must be fully installed before creating any models");return C.isArray(a)?this._mapBulk(a,b,c):this._mapBulk([a],function(a,c){if(b){var d;c&&c.length&&(d=c[0]),b(a?a[0]:null,d)}},c?[c]:void 0),d.promise},d.prototype._mapBulk=function(a,b,c){var d=E.defer();b=C.constructCallbackAndPromiseHandler(b,d);var e={mapping:this,data:a};c&&(e.objects=c);var f=new r(e);return f.onCompletion(function(){var a=f.error;if(a)b&&b(a);else{var c=f.result;b(null,c)}}),f.start(),d.promise},d.prototype.count=function(a){var b=E.defer();a=C.constructCallbackAndPromiseHandler(a,b);var c=e.call(this);if(siesta.ext.storageEnabled){var d=siesta.ext.storage.Pouch.getPouch(),f=new siesta.ext.storage.Index(this.collection,this.type)._getName()+"_";d.query(f,{include_docs:!1},function(b,d){var e;b||(D.each(D.pluck(d.rows,"id"),function(a){c[a]={}}),e=Object.keys(c).length),a(b,e)})}else a(null,Object.keys(c).length);return b.promise},d.prototype._new=function(a){if(this.installed){var b,c=this;b=a&&a._id?a._id:t();var d;d=this.subclass?new this.subclass(this):new s(this),k.info.isEnabled&&k.info('New object created _id="'+b.toString()+'", type='+this.type,a),d._id=b,d.__values=a||{};var e=this._fields,f=e.indexOf(this.id);f>-1&&e.splice(f,1),D.each(e,function(a){Object.defineProperty(d,a,{get:function(){return d.__values[a]||null},set:function(b){var e=d.__values[a];d.__values[a]=b,w.registerChange({collection:c.collection,mapping:c.type,_id:d._id,"new":b,old:e,type:x.Set,field:a,obj:d}),C.isArray(b)&&y(b,a,d)},enumerable:!0,configurable:!0})}),Object.defineProperty(d,this.id,{get:function(){return d.__values[c.id]||null},set:function(a){var b=d[c.id];d.__values[c.id]=a,w.registerChange({collection:c.collection,mapping:c.type,_id:d._id,"new":a,old:b,type:x.Set,field:c.id,obj:d}),u.remoteInsert(d,a,b)},enumerable:!0,configurable:!0});for(var g in this.relationships){var h;if(this.relationships.hasOwnProperty(g)){var i=this.relationships[g];if(i.type==p.OneToMany)h=new z(i);else if(i.type==p.OneToOne)h=new A(i);else{if(i.type!=p.ManyToMany)throw new n("No such relationship type: "+i.type);h=new B(i)}}h.install(d),h.isFault=!1}return u.insert(d),w.registerChange({collection:this.collection,mapping:this.type,_id:d._id,newId:d._id,"new":d,type:x.New,obj:d}),d}throw C.printStackTrace(),new n("Mapping must be fully installed before creating any models")},d.prototype._dump=function(a){var b={};return b.name=this.type,b.attributes=this.attributes,b.id=this.id,b.collection=this.collection,b.relationships=D.map(this.relationships,function(a){return a.isForward?a.forwardName:a.reverseName}),a?JSON.stringify(b,null,4):b},d.prototype.toString=function(){return"Mapping["+this.type+"]"},f.prototype=Object.create(n.prototype),f.prototype.name="MappingError",f.prototype.constructor=f,c.Mapping=d,c.MappingError=f,c.constructMapFunction2=i,c.constructMapFunction=h},{"../vendor/operations.js/src/log":25,"../vendor/operations.js/src/operation":26,"./cache":6,"./changes":7,"./collectionRegistry":9,"./error":10,"./manyToManyProxy":11,"./mappingOperation":13,"./misc":14,"./notificationCentre":15,"./object":16,"./oneToManyProxy":17,"./oneToOneProxy":18,"./query":20,"./relationship":21,"./store":22,"./util":23,extend:4,q:5}],13:[function(a,b,c){function d(a){return s.reduce(a,function(a,b){return r.isArray(b)?a=a.concat(b):a.push(b),a},[])}function e(a,b){for(var c=0,d=[],e=0;e<b.length;e++)if(r.isArray(b[e])){var f=[];d[e]=f;for(var g=0;g<b[e].length;g++)f.push(a[c]),c++}else d[e]=a[c],c++;return d}function f(a){m.call(this),this._opts=a,t.call(this,"mapping",this._opts),t.call(this,"data",this._opts),t.call(this,"objects",this._opts),this.objects||(this.objects=[]),this.errors=[],this.name="Mapping Operation",this.work=s.bind(this._start,this),this.subOps={}}function g(){for(var a=0;a<this.data.length;a++){var b=this.data[a],c=this.objects[a];if(b!=c&&c){var d=this.mapping._fields;s.each(d,function(a){void 0!==b[a]&&(c[a]=b[a])})}}}function h(a){for(var b=[],c=[],d=0;d<this.data.length;d++){var e=this.data[d];e&&e[a]&&(b.push(d),c.push(e[a]))}return{indexes:b,relatedData:c}}function i(){var a=this,b=s.keys(this.subOps);s.each(b,function(b){var c=a.subOps[b].op,d=a.subOps[b].indexes,f=c.errors;if(f.length)for(var g=h.call(a,b).relatedData,i=e(f,g),j=0;j<i.length;j++){var k=d[j],l=i[j],m=l;r.isArray(l)&&(m=s.reduce(l,function(a,b){return a||b},!1)),m&&(a.errors[k]||(a.errors[k]={}),a.errors[k][b]=l)}})}var j=a("./store"),k=a("./object").SiestaModel,l=a("../vendor/operations.js/src/log"),m=a("../vendor/operations.js/src/operation").Operation,n=a("../src/error").InternalSiestaError,o=a("./query").Query,p=l.loggerWithName("MappingOperation");p.setLevel(l.Level.warn);var q=a("./cache"),r=a("./util"),s=r._,t=a("./misc").defineSubProperty,u=(a("./changes").ChangeType,a("q"));f.prototype=Object.create(m.prototype),f.prototype._map=function(){var a=this,b=(g.call(this),s.keys(a.subOps));s.each(b,function(b){for(var c=a.subOps[b].op,d=a.subOps[b].indexes,f=h.call(a,b).relatedData,g=e(c.objects,f),i=0;i<g.length;i++){var j=d[i],k=a.errors[j],l=k?k[b]:null;if(!l){var m=g[i],n=a.objects[j];if(n){var l=n[b+"Proxy"].set(m);l&&(a.errors[j]||(a.errors[j]={}),a.errors[j][b]=l)}}}})},f.prototype._lookup=function(a){var b=u.defer();a=r.constructCallbackAndPromiseHandler(a,b);for(var c=this,d=[],e=[],f=0;f<this.data.length;f++)if(!this.objects[f]){var g,h=this.data[f],i="string"==typeof h||"number"==typeof h||h instanceof String;if(h)if(i)g={index:f,datum:{}},g.datum[c.mapping.id]=h,d.push(g);else if(h instanceof k)this.objects[f]=h;else if(h._id)e.push({index:f,datum:h});else if(h[c.mapping.id])d.push({index:f,datum:h});else{for(var l=Object.keys(h),m=s.reduce(Object.keys(c.mapping.relationships).concat(c.mapping._fields),function(a,b){return a[b]={},a},{}),n=!1,o=0;o<l.length;o++)if(m[l[o]]){n=!0;break}n&&(this.objects[f]=c.mapping._new())}else this.objects[f]=null}return r.parallel([function(a){var b=s.pluck(s.pluck(e,"datum"),"_id");b.length?j.getMultipleLocal(b,function(d,f){if(!d)for(var g=0;g<b.length;g++){var h=f[g],i=b[g],j=e[g];h?c.objects[j.index]=h:c.errors[j.index]={_id:'No object with _id="'+i.toString()+'"'}}a(d)}):a()},function(a){var b=s.pluck(s.pluck(d,"datum"),c.mapping.id);b.length?(p.trace.isEnabled&&p.trace("Looking up remoteIdentifiers: "+JSON.stringify(b,null,4)),j.getMultipleRemote(b,c.mapping,function(e,g){if(!e){if(p.trace.isEnabled){var h={};for(f=0;f<g.length;f++)h[b[f]]=g[f]?g[f]._id:null;p.trace("Results for remoteIdentifiers: "+JSON.stringify(h,null,4))}for(f=0;f<g.length;f++){var i=g[f],j=d[f];if(i)c.objects[j.index]=i;else{var k={},l=b[f];k[c.mapping.id]=l;var m={mapping:c.mapping};m[c.mapping.id]=l;var n=q.get(m);n?c.objects[j.index]=n:(c.objects[j.index]=c.mapping._new(),c.objects[j.index][c.mapping.id]=l)}}}a(e)})):a()}],a),b.promise},f.prototype._lookupSingleton=function(a){var b=u.defer();a=r.constructCallbackAndPromiseHandler(a,b);var c=this,d=q.get({mapping:this.mapping});if(d){for(var e=0;e<c.data.length;e++)c.objects[e]=d;a()}else{var f=new o(this.mapping);f.execute(function(b,d){if(!b){var e;if(d.length){if(1!=d.length)throw new n;e=d[0]}else e=c.mapping._new();for(var f=0;f<c.data.length;f++)c.objects[f]=e}a(b)})}return b.promise},f.prototype._start=function(a){if(this.data.length){var b=this,c=[],d=this.mapping.singleton?this._lookupSingleton:this._lookup;c.push(s.bind(d,this)),c.push(s.bind(this._executeSubOperations,this)),r.parallel(c,function(){b._map(),a(b.errors.length?b.errors:null,b.objects)})}else a(null,[])},f.prototype._constructSubOperations=function(){var a=this.subOps,b=this.mapping.relationships;for(var c in b)if(b.hasOwnProperty(c)){var e=b[c],g=e.forwardName==c?e.reverseMapping:e.forwardMapping,i=h.call(this,c),j=i.indexes,k=i.relatedData;if(k.length){var l=d(k),m=new f({mapping:g,data:l});m.__relationshipName=c,a[c]={op:m,indexes:j}}}},f.prototype._executeSubOperations=function(a){var b=this;this._constructSubOperations();var c=s.keys(this.subOps);if(c.length){var d=s.map(c,function(a){return b.subOps[a].op}),e=new m(d);e.onCompletion(function(){i.call(b,c),a()}),e.start()}else a()},c.BulkMappingOperation=f,c.flattenArray=d,c.unflattenArray=e},{"../src/error":10,"../vendor/operations.js/src/log":25,"../vendor/operations.js/src/operation":26,"./cache":6,"./changes":7,"./misc":14,"./object":16,"./query":20,"./store":22,"./util":23,q:5}],14:[function(a,b,c){function d(a,b,c){if(!a)throw b=b||"Assertion failed",c=c||{},new g(b,c)}function e(a,b,c){return Object.defineProperty(this,a,{get:function(){return c?b[c]:b[a]},set:function(d){c?b[c]=d:b[a]=d},enumerable:!0,configurable:!0})}function f(a){return function(b,c){a&&a(b,c)}}var g=a("./error").InternalSiestaError,h=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}();c.assert=d,c.defineSubProperty=e,c.guid=h,c.wrappedCallback=f},{"./error":10}],15:[function(a,b,c){function d(a,b,c){a.observer||(a.observer=new g(a),a.observer.open(function(d){var e=c._fields.indexOf(b)>-1;e&&d.forEach(function(d){h.registerChange({collection:c.collection,mapping:c.mapping.type,_id:c._id,index:d.index,removed:d.removed,added:d.addedCount?a.slice(d.index,d.index+d.addedCount):[],type:h.ChangeType.Splice,field:b,obj:c})})}),a.isFault=!1)}var e=a("events").EventEmitter,f=new e;f.setMaxListeners(100);{var g=a("../vendor/observe-js/src/observe").ArrayObserver,h=a("./changes");h.ChangeType,a("../vendor/operations.js/src/log")}c.notificationCentre=f,c.wrapArray=d},{"../vendor/observe-js/src/observe":24,"../vendor/operations.js/src/log":25,"./changes":7,events:2}],16:[function(a,b,c){function d(a){if(!this)return new d(a);var b=this;this.mapping=a,Object.defineProperty(this,"idField",{get:function(){return b.mapping.id?b.mapping.id:"id"},enumerable:!0,configurable:!0}),g.call(this,"type",this.mapping),g.call(this,"collection",this.mapping),g.call(this,"_fields",this.mapping),Object.defineProperty(this,"_relationshipFields",{get:function(){return i.map(b._proxies,function(a){return a.isForward?a.forwardName:a.reverseName})},enumerable:!0,configurable:!0}),this.isFault=!1,Object.defineProperty(this,"isSaved",{get:function(){return!!b._rev},enumerable:!0,configurable:!0}),this._rev=null,this.removed=!1}var e=a("../vendor/operations.js/src/log"),f=e.loggerWithName("SiestaModel");f.setLevel(e.Level.warn);var g=a("./misc").defineSubProperty,h=a("./util"),i=h._,j=a("./error"),k=(j.InternalSiestaError,a("./changes")),l=a("q"),m=a("./cache");d.prototype._dump=function(a){var b=this,c={};return c.mapping=this.mapping.type,c.collection=this.collection,c._id=this._id,c=i.reduce(this._fields,function(a,c){return b[c]&&(a[c]=b[c]),a},c),c=i.reduce(this._relationshipFields,function(a,c){return b[c+"Proxy"]&&(b[c+"Proxy"].hasOwnProperty("_id")?h.isArray(b[c+"Proxy"]._id)?b[c].length&&(a[c]=b[c+"Proxy"]._id):b[c+"Proxy"]._id&&(a[c]=b[c+"Proxy"]._id):a[c]=b[c]),a},c),a?JSON.stringify(c,null,4):c},d.prototype.get=function(a){var b=l.defer();return a=h.constructCallbackAndPromiseHandler(a,b),a(null,this),b.promise},d.prototype.remove=function(a){var b=l.defer();return a=h.constructCallbackAndPromiseHandler(a,b),m.remove(this),this.removed=!0,k.registerChange({collection:this.collection,mapping:this.mapping.type,_id:this._id,oldId:this._id,old:this,type:k.ChangeType.Remove,obj:this}),a(null,this),b.promise},d.prototype.restore=function(a){var b=l.defer();return a=h.constructCallbackAndPromiseHandler(a,b),this.removed&&(m.insert(this),this.removed=!1),k.registerChange({collection:this.collection,mapping:this.mapping.type,_id:this._id,newId:this._id,"new":this,type:k.ChangeType.New,obj:this}),a(null,this),b.promise},c.SiestaModel=d,c.dumpSaveQueues=function(){var a={};for(var b in queues)if(queues.hasOwnProperty(b)){var c=queues[b];a[b]={numRunning:c.numRunningOperations,queued:c._queuedOperations.length}}return a}},{"../vendor/operations.js/src/log":25,"./cache":6,"./changes":7,"./error":10,"./misc":14,"./util":23,q:5}],17:[function(a,b,c){function d(a){k.call(this,a);var b=this;Object.defineProperty(this,"isFault",{get:function(){return b.isForward?b._id?!b.related:null===b._id?!1:!0:b._id&&b.related?b._id.length!=b.related.length?(i.call(this),!0):!1:!0},set:function(a){a?(b._id=void 0,b.related=null):b._id||(b.isForward?b._id=null:(b._id=[],b.related=[],g.call(b,b.related)))}}),this._reverseIsArray=!0,this._forwardIsArray=!1}function e(a){var b=this;n.each(a,function(a){var c=j.getReverseProxyForObject.call(b,a);j.set.call(c,null)})}function f(a){var b=this;n.each(a,function(a){var c=j.getReverseProxyForObject.call(b,a);j.set.call(c,b.object)})}function g(a){var b=this;if(r(a,this.reverseName,this.object),!a.oneToManyObserver){a.oneToManyObserver=new s(a);var c=function(c){c.forEach(function(c){var d=c.addedCount?a.slice(c.index,c.index+c.addedCount):[],g=c.removed;e.call(b,g),f.call(b,d);var h=j.getForwardMapping.call(b);p.registerChange({collection:h.collection,mapping:h.type,_id:b.object._id,field:j.getForwardName.call(b),removed:g,added:d,removedId:n.pluck(g,"_id"),addedId:n.pluck(d,"_id"),type:t.Splice,index:c.index,obj:b.object})})};a.oneToManyObserver.open(c)}}function h(a){var b=Object.prototype.toString.call(a);if(this.isForward){if("[object Array]"==b)return"Cannot assign array forward oneToMany ("+b+"): "+this.forwardName}else if("[object Array]"!=b)return"Cannot scalar to reverse oneToMany ("+b+"): "+this.reverseName;return null}function i(){var a=this;if(a._id&&a.related&&a._id.length!=a.related.length&&a.related.length>0)throw new o("_id and related are somehow out of sync")}var j=a("./proxy"),k=j.RelationshipProxy,l=a("./store"),m=a("./util"),n=m._,o=a("./error").InternalSiestaError,p=a("./changes"),q=(a("./object").SiestaModel,a("./notificationCentre")),r=q.wrapArray,s=a("../vendor/observe-js/src/observe").ArrayObserver,t=a("./changes").ChangeType,u=a("q");d.prototype=Object.create(k.prototype),d.prototype.get=function(a){var b=u.defer();a=m.constructCallbackAndPromiseHandler(a,b);var c=this;if(this.isFault)if(this._id.length){var d={_id:this._id};l.get(d,function(b,d){b?a&&a(b):(c.related=d,a&&a(null,d))})}else a&&a(null,this.related);else a&&a(null,this.related);return b.promise},d.prototype.set=function(a){j.checkInstalled.call(this);var b=this;if(a){var c;if(c=h.call(this,a))return c;j.clearReverseRelated.call(this),j.set.call(b,a),b.isReverse&&g.call(this,b.related),j.setReverse.call(b,a)}else j.clearReverseRelated.call(this),j.set.call(b,a)},d.prototype.install=function(a){k.prototype.install.call(this,a),this.isReverse&&(a["splice"+m.capitaliseFirstLetter(this.reverseName)]=n.bind(j.splice,this))},c.OneToManyProxy=d},{"../vendor/observe-js/src/observe":24,"./changes":7,"./error":10,"./notificationCentre":15,"./object":16,"./proxy":19,"./store":22,"./util":23,q:5}],18:[function(a,b,c){function d(a){g.call(this,a),this._reverseIsArray=!1,this._forwardIsArray=!1}function e(a){return"[object Array]"==Object.prototype.toString.call(a)?"Cannot assign array to one to one relationship":null}{var f=a("./proxy"),g=f.RelationshipProxy,h=a("./store"),i=a("./util"),j=(a("./error").InternalSiestaError,a("q"));a("./object").SiestaModel}d.prototype=Object.create(g.prototype),d.prototype.set=function(a){f.checkInstalled.call(this);var b=this;if(a){var c;if(c=e(a))return c;f.clearReverseRelated.call(this),f.set.call(b,a),f.setReverse.call(b,a)}else f.clearReverseRelated.call(this),f.set.call(b,a)},d.prototype.get=function(a){var b=j.defer();a=i.constructCallbackAndPromiseHandler(a,b);var c=this;return this._id&&h.get({_id:this._id},function(b,d){b?a&&a(b):(c.related=d,a&&a(null,d))}),b.promise},c.OneToOneProxy=d},{"./error":10,"./object":16,"./proxy":19,"./store":22,"./util":23,q:5}],19:[function(a,b,c){function d(a){var b=this;this.proxy=a,Object.defineProperty(this,"isFault",{get:function(){return b.proxy.isFault},enumerable:!0,configurable:!0})}function e(a){if(this._opts=a,!this)return new e(a);var b=this;if(this.fault=new d(this),this.object=null,this._id=void 0,this.related=null,Object.defineProperty(this,"isFault",{get:function(){return b._id?!b.related:null===b._id?!1:!0},set:function(a){a?(b._id=void 0,b.related=null):b._id||(b._id=null)},enumerable:!0,configurable:!0}),w.call(this,"reverseMapping",this._opts),w.call(this,"forwardMapping",this._opts),w.call(this,"forwardName",this._opts),w.call(this,"reverseName",this._opts),w.call(this,"isReverse",this._opts),Object.defineProperty(this,"isForward",{get:function(){return!b.isReverse},set:function(a){b.isReverse=!a},enumerable:!0,configurable:!0}),void 0===this._opts.isReverse&&void 0!==this._opts.isForward)this.isReverse=!this._opts.isForward;else if(void 0===this._opts.isReverse&&void 0===this._opts.isForward)throw v("Must specify either isReverse or isForward when configuring relationship proxy.")}function f(a){var b=h.call(this),c=b+"Proxy",d=this.reverseMapping;if(x.isArray(a))return y.pluck(a,c);var e=a[c];if(!e){var f='No proxy with name "'+c+'" on mapping '+d.type;throw new v(f)}return e}function g(a){var b=i.call(this),c=b+"Proxy",d=this.forwardMapping;if(x.isArray(a))return y.pluck(a,c);var e=a[c];if(!e){var f='No proxy with name "'+c+'" on mapping '+d.type;throw new v(f)}return e}function h(){return this.isForward?this.reverseName:this.forwardName}function i(){return this.isForward?this.forwardName:this.reverseName}function j(){return this.isForward?this.reverseMapping:this.forwardMapping}function k(){return this.isForward?this.forwardMapping:this.reverseMapping}function l(){if(!this.object)throw new v("Proxy must be installed on an object before can use it.")}function m(a){s.call(this,a),a?x.isArray(a)?(this._id=y.pluck(a,"_id"),this.related=a):(this._id=a._id,this.related=a):(this._id=null,this.related=null)}function n(a,b){t.apply(this,arguments);var c=Array.prototype.slice.call(arguments,2),d=y.partial(this._id.splice,a,b).apply(this._id,y.pluck(c,"_id"));return this.related&&y.partial(this.related.splice,a,b).apply(this.related,c),d}function o(a){function b(a){if(a){var b=a.mapping,c=b.type,d=a._id;return"string"==typeof d&&(d='"'+d+'"'),c+"[_id="+d+"]"}return void 0===a?"undefined":null===a?"null":void 0}return x.isArray(a)?y.map(b,a).join(", "):b(a)}function p(){var a=this;if(a.isFault){if(!a._id)throw new Error(i.call(this)+" has no _id");var b=h.call(this),c=j.call(this),d=x.isArray(a._id)?a._id:[a._id];this._reverseIsArray?y.each(d,function(d){C.registerChange({collection:c.collection,mapping:c.type,_id:d,field:b,removedId:[a.object._id],removed:[a.object],type:D.Delete,obj:a.object})}):y.each(d,function(d){C.registerChange({collection:c.collection,mapping:c.type,_id:d,field:b,"new":null,newId:null,oldId:a.object._id,old:a.object,type:D.Set,obj:a.object})})}else if(this.related){var e=f.call(this,this.related),g=x.isArray(e)?e:[e];y.each(g,function(b){if(x.isArray(b._id)){var c=b._id.indexOf(a.object._id);q.call(b,function(){n.call(b,c,1)})}else m.call(b,null)})}}function q(a){this.related?(this.related.oneToManyObserver.close(),this.related.oneToManyObserver=null,a(),u.call(this,this.related)):a()}function r(a){var b=this,c=f.call(this,a),d=x.isArray(c)?c:[c];y.each(d,function(a){x.isArray(a._id)?q.call(a,function(){n.call(a,a._id.length,0,b.object)}):(p.call(a),m.call(a,b.object))})}function s(a){var b=this.object;if(!b)throw new v("Proxy must have an object associated");var c,d=b.mapping.type,e=b.collection;c=x.isArray(a)?y.pluck(a,"_id"):a?a._id:a;var f=this._id;x.isArray(f)&&!f.length&&(f=null);var g=this.related;x.isArray(g)&&!g.length&&(g=null),C.registerChange({collection:e,mapping:d,_id:b._id,field:i.call(this),newId:c,oldId:f,old:g,"new":a,type:D.Set,obj:b})}function t(a,b){var c=Array.prototype.slice.call(arguments,2),d=this.object.mapping.type,e=this.object.collection;C.registerChange({collection:e,mapping:d,_id:this.object._id,field:i.call(this),index:a,removedId:this._id.slice(a,a+b),removed:this.related?this.related.slice(a,a+b):null,addedId:c.length?y.pluck(c,"_id"):[],added:c.length?c:[],type:D.Splice,obj:this.object})}function u(a){var b=this;if(A(a,this.reverseName,this.object),!a.oneToManyObserver){a.oneToManyObserver=new B(a);var c=function(c){c.forEach(function(c){var d=c.addedCount?a.slice(c.index,c.index+c.addedCount):[],e=k.call(b);C.registerChange({collection:e.collection,mapping:e.type,_id:b.object._id,field:i.call(b),removed:c.removed,added:d,removedId:y.pluck(c.removed,"_id"),addedId:y.pluck(c.added,"_id"),type:D.Splice,obj:b.object})
})};a.oneToManyObserver.open(c)}}var v=a("./error").InternalSiestaError,w=(a("./store"),a("./misc").defineSubProperty),x=(a("../vendor/operations.js/src/operation").Operation,a("./util")),y=x._,z=(a("./query").Query,a("../vendor/operations.js/src/log"),a("./notificationCentre")),A=z.wrapArray,B=a("../vendor/observe-js/src/observe").ArrayObserver,C=a("./changes"),D=C.ChangeType;d.prototype.get=function(){this.proxy.get.apply(this.proxy,arguments)},d.prototype.set=function(){this.proxy.set.apply(this.proxy,arguments)},e.prototype._dump=function(){},e.prototype.install=function(a){if(!a)throw new v("No object passed to relationship install");if(this.object)throw new v("Already installed.");this.object=a;var b=this,c=i.call(this);Object.defineProperty(a,c,{get:function(){return b.isFault?b.fault:b.related},set:function(a){b.set(a)},configurable:!0,enumerable:!0}),a["get"+x.capitaliseFirstLetter(c)]=y.bind(this.get,this),a["set"+x.capitaliseFirstLetter(c)]=y.bind(this.set,this),a[c+"Proxy"]=this,a._proxies||(a._proxies=[]),a._proxies.push(this)},e.prototype.set=function(){throw new v("Must subclass RelationshipProxy")},e.prototype.get=function(){throw new v("Must subclass RelationshipProxy")},c.RelationshipProxy=e,c.Fault=d,c.getReverseProxyForObject=f,c.getForwardProxyForObject=g,c.getReverseName=h,c.getForwardName=i,c.getReverseMapping=j,c.getForwardMapping=k,c.checkInstalled=l,c.set=m,c.registerSetChange=s,c.splice=n,c.clearReverseRelated=p,c.setReverse=r,c.objAsString=o,c.wrapArray=u,c.registerSpliceChange=t,c.makeChangesToRelatedWithoutObservations=q},{"../vendor/observe-js/src/observe":24,"../vendor/operations.js/src/log":25,"../vendor/operations.js/src/operation":26,"./changes":7,"./error":10,"./misc":14,"./notificationCentre":15,"./query":20,"./store":22,"./util":23}],20:[function(a,b,c){function d(a,b){this.mapping=a,this.query=b}function e(a){for(var b=Object.keys(this.query),c=0;c<b.length;c++){var d,e=b[c],f=e.split("__"),g="e";2==f.length?(d=f[0],g=f[1]):d=e;var h=this.query[e],i=a[d];if("e"==g){if(i!=h)return!1}else if("lt"==g){if(i>=h)return!1}else if("lte"==g){if(i>h)return!1}else if("gt"==g){if(h>=i)return!1}else{if("gte"!=g)return'Query operator "'+g+'" does not exist';if(h>i)return!1}}return!0}function f(a){var b=j.defer();a=k.constructCallbackAndPromiseHandler(a,b);var c,d=h._localCacheByType,f=this.mapping.type,g=this.mapping.collection,i=d[g];if(i&&(c=i[f]),c){for(var l,m=Object.keys(c),n=this,o=[],p=0;p<m.length;p++){var q=m[p],r=c[q],s=e.call(n,r);if("string"==typeof s){l=s;break}s&&o.push(r)}a(l,l?null:o)}else a&&a(null,[]);return b.promise}var g=a("../vendor/operations.js/src/log"),h=a("./cache"),i=g.loggerWithName("Query"),j=a("q"),k=a("./util");i.setLevel(g.Level.warn),d.prototype.execute=function(a){var b=j.defer();return a=k.constructCallbackAndPromiseHandler(a,b),f.call(this,a),b.promise},d.prototype._dump=function(a){return a?"{}":{}},c.Query=d},{"../vendor/operations.js/src/log":25,"./cache":6,"./util":23,q:5}],21:[function(a,b,c){RelationshipType={OneToMany:"OneToMany",OneToOne:"OneToOne",ManyToMany:"ManyToMany"},c.RelationshipType=RelationshipType},{}],22:[function(a,b,c){function d(a,b){var c=o.defer();b=l.constructCallbackAndPromiseHandler(b,c),k.debug.isEnabled&&k.debug("get",a);var d;if(a._id){if(l.isArray(a._id))e(m.map(a._id,function(a){return{_id:a}}),b);else if(d=n.get(a))k.debug.isEnabled&&k.debug("Had cached object",{opts:a,obj:d}),h(b)(null,d);else if(l.isArray(a._id))e(m.map(a._id,function(a){return{_id:a}}),b);else if(b){var f=siesta.ext.storage;if(!f)throw"Storage module not installed";f.store.getFromPouch(a,b)}}else if(a.mapping)if(l.isArray(a[a.mapping.id]))e(m.map(a[a.mapping.id],function(b){var c={};return c[a.mapping.id]=b,c.mapping=a.mapping,c}),b);else if(d=n.get(a))k.debug.isEnabled&&k.debug("Had cached object",{opts:a,obj:d}),h(b)(null,d);else{var g=a.mapping;if(g.singleton)g.get(b);else{var j=g.id,p=a[j];p?g.get(p,function(a,c){a?b(a):c?b(null,c):b(null,null)}):h(b)(new i('Invalid options given to store. Missing "'+j.toString()+'."',{opts:a}))}}else{var q={opts:a},r="Invalid options given to store";k.error(r,q),h(b)(new i(r,q))}return c.promise}function e(a,b){var c=o.defer();b=l.constructCallbackAndPromiseHandler(b,c);var e=[],f=[];return m.each(a,function(c){d(c,function(c,d){c?f.push(c):e.push(d),e.length+f.length==a.length&&b&&(f.length?b(f):b(null,e))})}),c.promise}function f(a,b){function c(c){b&&(c?b(c):b(null,m.map(a,function(a){return e.cached[a]})))}var d=o.defer();b=l.constructCallbackAndPromiseHandler(b,d);var e=m.reduce(a,function(a,b){var c=n.get({_id:b});return c?a.cached[b]=c:a.notCached.push(b),a},{cached:{},notCached:[]});return siesta.ext.storageEnabled&&e.notCached.length?siesta.ext.storage.store.getMultipleLocalFromCouch(e,c):c(),d.promise}function g(a,b,c){function d(b){c&&(b?c(b):c(null,m.map(a,function(a){return f.cached[a]})))}var e=o.defer();c=l.constructCallbackAndPromiseHandler(c,e);var f=m.reduce(a,function(a,c){var d={mapping:b};d[b.id]=c;var e=n.get(d);return e?a.cached[c]=e:a.notCached.push(c),a},{cached:{},notCached:[]});return siesta.ext.storageEnabled&&f.notCached.length?siesta.ext.storage.store.getMultipleRemoteFrompouch(b,a,f,d):d(),e.promise}var h=a("./misc").wrappedCallback,i=a("./error").InternalSiestaError,j=a("../vendor/operations.js/src/log"),k=j.loggerWithName("Store");k.setLevel(j.Level.warn);var l=a("./util"),m=l._,n=a("./cache"),o=a("q");c.get=d,c.getMultiple=e,c.getMultipleLocal=f,c.getMultipleRemote=g},{"../vendor/operations.js/src/log":25,"./cache":6,"./error":10,"./misc":14,"./util":23,q:5}],23:[function(a,b,c){function d(){var a=new Error("printStackTrace"),b=a.stack;console.log(b)}function e(a){return a.charAt(0).toUpperCase()+a.slice(1)}function f(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[l].concat(b))}}function g(a,b){if(a.map)return a.map(b);var c=[];return l(a,function(a,d,e){c.push(b(a,d,e))}),c}function h(a,b,c,d){if(b=g(b,function(a,b){return{index:b,value:a}}),d){var e=[];a(b,function(a,b){c(a.value,function(c,d){e[a.index]=d,b(c)})},function(a){d(a,e)})}else a(b,function(a,b){c(a.value,function(a){b(a)})})}function i(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[j].concat(b))}}function j(a,b,c){if(c=c||function(){},!a.length)return c();var d=0,e=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d>=a.length?c():e())})};e()}function k(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)}function l(a,b,c){function d(b){b?(c(b),c=function(){}):(e+=1,e>=a.length&&c())}if(c=c||function(){},!a.length)return c();var e=0;k(a,function(a){b(a,o(d))})}function m(a){if(Object.keys)return Object.keys(a);var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b}function n(a,b){if(b=b||function(){},_isArray(a))u(a,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},b);else{var c={};j(_keys(a),function(b,d){a[b](function(a){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),c[b]=e,d(a)})},function(a){b(a,c)})}}function o(a){var b=!1;return function(){if(b)throw new Error("Callback was already called.");b=!0,a.apply(r,arguments)}}function p(a,b){v({map:t,each:l},a,b)}function q(a){I.performMicrotaskCheckpoint(),setTimeout(a)}c.printStackTrace=d,c.capitaliseFirstLetter=e;var r={},s=Array.isArray||function(a){return"[object Array]"===_toString.call(a)},t=f(h),u=i(h),v=function(a,b,c){if(c=c||function(){},s(b))a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};a.each(m(b),function(a,c){b[a](function(b){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),d[a]=e,c(b)})},function(a){c(a,d)})}};c.series=n,c.parallel=p,c.isArray=s;var w={},x=Array.prototype,y=Function.prototype,z=x.forEach,A=x.map,B=x.reduce,C=y.bind,D=x.slice,E={};w.keys=m,w.each=w.forEach=function(a,b,c){if(null==a)return a;if(z&&a.forEach===z)a.forEach(b,c);else if(a.length===+a.length){for(var d=0,e=a.length;e>d;d++)if(b.call(c,a[d],d,a)===E)return}else for(var f=w.keys(a),d=0,e=f.length;e>d;d++)if(b.call(c,a[f[d]],f[d],a)===E)return;return a},w.map=w.collect=function(a,b,c){var d=[];return null==a?d:A&&a.map===A?a.map(b,c):(w.each(a,function(a,e,f){d.push(b.call(c,a,e,f))}),d)},w.partial=function(a){var b=D.call(arguments,1);return function(){for(var c=0,d=b.slice(),e=0,f=d.length;f>e;e++)d[e]===w&&(d[e]=arguments[c++]);for(;c<arguments.length;)d.push(arguments[c++]);return a.apply(this,d)}},w.pluck=function(a,b){return w.map(a,w.property(b))};var F="Reduce of empty array with no initial value";w.reduce=w.foldl=w.inject=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),B&&a.reduce===B)return d&&(b=w.bind(b,d)),e?a.reduce(b,c):a.reduce(b);if(w.each(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)}),!e)throw new TypeError(F);return c},w.property=function(a){return function(b){return b[a]}},"function"!=typeof/./&&(w.isFunction=function(a){return"function"==typeof a});var G=function(a){return null==a?w.identity:w.isFunction(a)?a:w.property(a)};w.sortBy=function(a,b,c){return b=G(b),w.pluck(w.map(a,function(a,d,e){return{value:a,index:d,criteria:b.call(c,a,d,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(d>c||void 0===d)return-1}return a.index-b.index}),"value")};var H=function(){};w.bind=function(a,b){var c,d;if(C&&a.bind===C)return C.apply(a,D.call(arguments,1));if(!w.isFunction(a))throw new TypeError;return c=D.call(arguments,2),d=function(){if(!(this instanceof d))return a.apply(b,c.concat(D.call(arguments)));H.prototype=a.prototype;var e=new H;H.prototype=null;var f=a.apply(e,c.concat(D.call(arguments)));return Object(f)===f?f:e}},c._=w;var I=a("../vendor/observe-js/src/observe").Platform;c.next=q,c.constructCallbackAndPromiseHandler=function(a,b){return function(c){a&&a.apply(a,arguments),b&&(c?b.reject(c):b.resolve.apply(b,Array.prototype.slice.call(arguments,1)))}}},{"../vendor/observe-js/src/observe":24}],24:[function(require,module,exports){(function(global){!function(global){"use strict";function detectObjectObserve(){function a(a){b=a}if("function"!=typeof Object.observe||"function"!=typeof Array.observe)return!1;var b=[],c={},d=[];return Object.observe(c,a),Array.observe(d,a),c.id=1,c.id=2,delete c.id,d.push(1,2),d.length=0,Object.deliverChangeRecords(a),5!==b.length?!1:"add"!=b[0].type||"update"!=b[1].type||"delete"!=b[2].type||"splice"!=b[3].type||"splice"!=b[4].type?!1:(Object.unobserve(c,a),Array.unobserve(d,a),!0)}function detectEval(){if("undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime)return!1;if(navigator.getDeviceStorage)return!1;try{var a=new Function("","return true;");return a()}catch(b){return!1}}function isIndex(a){return+a===a>>>0&&""!==a}function toNumber(a){return+a}function isObject(a){return a===Object(a)}function areSameValue(a,b){return a===b?0!==a||1/a===1/b:numberIsNaN(a)&&numberIsNaN(b)?!0:a!==a&&b!==b}function getPathCharType(a){if(void 0===a)return"eof";var b=a.charCodeAt(0);switch(b){case 91:case 93:case 46:case 34:case 39:case 48:return a;case 95:case 36:return"ident";case 32:case 9:case 10:case 13:case 160:case 65279:case 8232:case 8233:return"ws"}return b>=97&&122>=b||b>=65&&90>=b?"ident":b>=49&&57>=b?"number":"else"}function noop(){}function parsePath(a){function b(){if(!(k>=a.length)){var b=a[k+1];return"inSingleQuote"==l&&"'"==b||"inDoubleQuote"==l&&'"'==b?(k++,d=b,m.append(),!0):void 0}}for(var c,d,e,f,g,h,i,j=[],k=-1,l="beforePath",m={push:function(){void 0!==e&&(j.push(e),e=void 0)},append:function(){void 0===e?e=d:e+=d}};l;)if(k++,c=a[k],"\\"!=c||!b(l)){if(f=getPathCharType(c),i=pathStateMachine[l],g=i[f]||i["else"]||"error","error"==g)return;if(l=g[0],h=m[g[1]]||noop,d=void 0===g[2]?c:g[2],h(),"afterPath"===l)return j}}function isIdent(a){return identRegExp.test(a)}function Path(a,b){if(b!==constructorIsPrivate)throw Error("Use Path.get to retrieve path objects");for(var c=0;c<a.length;c++)this.push(String(a[c]));hasEval&&this.length&&(this.getValueFrom=this.compiledGetValueFromFn())}function getPath(a){if(a instanceof Path)return a;if((null==a||0==a.length)&&(a=""),"string"!=typeof a){if(isIndex(a.length))return new Path(a,constructorIsPrivate);a=String(a)}var b=pathCache[a];if(b)return b;var c=parsePath(a);if(!c)return invalidPath;var b=new Path(c,constructorIsPrivate);return pathCache[a]=b,b}function formatAccessor(a){return isIndex(a)?"["+a+"]":'["'+a.replace(/"/g,'\\"')+'"]'}function dirtyCheck(a){for(var b=0;MAX_DIRTY_CHECK_CYCLES>b&&a.check_();)b++;return testingExposeCycleCount&&(global.dirtyCheckCycleCount=b),b>0}function objectIsEmpty(a){for(var b in a)return!1;return!0}function diffIsEmpty(a){return objectIsEmpty(a.added)&&objectIsEmpty(a.removed)&&objectIsEmpty(a.changed)}function diffObjectFromOldObject(a,b){var c={},d={},e={};for(var f in b){var g=a[f];(void 0===g||g!==b[f])&&(f in a?g!==b[f]&&(e[f]=g):d[f]=void 0)}for(var f in a)f in b||(c[f]=a[f]);return Array.isArray(a)&&a.length!==b.length&&(e.length=a.length),{added:c,removed:d,changed:e}}function runEOMTasks(){if(!eomTasks.length)return!1;for(var a=0;a<eomTasks.length;a++)eomTasks[a]();return eomTasks.length=0,!0}function newObservedObject(){function a(a){b&&b.state_===OPENED&&!d&&b.check_(a)}var b,c,d=!1,e=!0;return{open:function(c){if(b)throw Error("ObservedObject in use");e||Object.deliverChangeRecords(a),b=c,e=!1},observe:function(b,d){c=b,d?Array.observe(c,a):Object.observe(c,a)},deliver:function(b){d=b,Object.deliverChangeRecords(a),d=!1},close:function(){b=void 0,Object.unobserve(c,a),observedObjectCache.push(this)}}}function getObservedObject(a,b,c){var d=observedObjectCache.pop()||newObservedObject();return d.open(a),d.observe(b,c),d}function newObservedSet(){function a(b,f){b&&(b===d&&(e[f]=!0),h.indexOf(b)<0&&(h.push(b),Object.observe(b,c)),a(Object.getPrototypeOf(b),f))}function b(a){for(var b=0;b<a.length;b++){var c=a[b];if(c.object!==d||e[c.name]||"setPrototype"===c.type)return!1}return!0}function c(c){if(!b(c)){for(var d,e=0;e<g.length;e++)d=g[e],d.state_==OPENED&&d.iterateObjects_(a);for(var e=0;e<g.length;e++)d=g[e],d.state_==OPENED&&d.check_()}}var d,e,f=0,g=[],h=[],i={object:void 0,objects:h,open:function(b,c){d||(d=c,e={}),g.push(b),f++,b.iterateObjects_(a)},close:function(){if(f--,!(f>0)){for(var a=0;a<h.length;a++)Object.unobserve(h[a],c),Observer.unobservedCount++;g.length=0,h.length=0,d=void 0,e=void 0,observedSetCache.push(this)}}};return i}function getObservedSet(a,b){return lastObservedSet&&lastObservedSet.object===b||(lastObservedSet=observedSetCache.pop()||newObservedSet(),lastObservedSet.object=b),lastObservedSet.open(a,b),lastObservedSet}function Observer(){this.state_=UNOPENED,this.callback_=void 0,this.target_=void 0,this.directObserver_=void 0,this.value_=void 0,this.id_=nextObserverId++}function addToAll(a){Observer._allObserversCount++,collectObservers&&allObservers.push(a)}function removeFromAll(){Observer._allObserversCount--}function ObjectObserver(a){Observer.call(this),this.value_=a,this.oldObject_=void 0}function ArrayObserver(a){if(!Array.isArray(a))throw Error("Provided object is not an Array");ObjectObserver.call(this,a)}function PathObserver(a,b){Observer.call(this),this.object_=a,this.path_=getPath(b),this.directObserver_=void 0}function CompoundObserver(a){Observer.call(this),this.reportChangesOnOpen_=a,this.value_=[],this.directObserver_=void 0,this.observed_=[]}function identFn(a){return a}function ObserverTransform(a,b,c,d){this.callback_=void 0,this.target_=void 0,this.value_=void 0,this.observable_=a,this.getValueFn_=b||identFn,this.setValueFn_=c||identFn,this.dontPassThroughSet_=d}function diffObjectFromChangeRecords(a,b,c){for(var d={},e={},f=0;f<b.length;f++){var g=b[f];expectedRecordTypes[g.type]?(g.name in c||(c[g.name]=g.oldValue),"update"!=g.type&&("add"!=g.type?g.name in d?(delete d[g.name],delete c[g.name]):e[g.name]=!0:g.name in e?delete e[g.name]:d[g.name]=!0)):(console.error("Unknown changeRecord type: "+g.type),console.error(g))}for(var h in d)d[h]=a[h];for(var h in e)e[h]=void 0;var i={};for(var h in c)if(!(h in d||h in e)){var j=a[h];c[h]!==j&&(i[h]=j)}return{added:d,removed:e,changed:i}}function newSplice(a,b,c){return{index:a,removed:b,addedCount:c}}function ArraySplice(){}function calcSplices(a,b,c,d,e,f){return arraySplice.calcSplices(a,b,c,d,e,f)}function intersect(a,b,c,d){return c>b||a>d?-1:b==c||d==a?0:c>a?d>b?b-c:d-c:b>d?d-a:b-a}function mergeSplice(a,b,c,d){for(var e=newSplice(b,c,d),f=!1,g=0,h=0;h<a.length;h++){var i=a[h];if(i.index+=g,!f){var j=intersect(e.index,e.index+e.removed.length,i.index,i.index+i.addedCount);if(j>=0){a.splice(h,1),h--,g-=i.addedCount-i.removed.length,e.addedCount+=i.addedCount-j;var k=e.removed.length+i.removed.length-j;if(e.addedCount||k){var c=i.removed;if(e.index<i.index){var l=e.removed.slice(0,i.index-e.index);Array.prototype.push.apply(l,c),c=l}if(e.index+e.removed.length>i.index+i.addedCount){var m=e.removed.slice(i.index+i.addedCount-e.index);Array.prototype.push.apply(c,m)}e.removed=c,i.index<e.index&&(e.index=i.index)}else f=!0}else if(e.index<i.index){f=!0,a.splice(h,0,e),h++;var n=e.addedCount-e.removed.length;i.index+=n,g+=n}}}f||a.push(e)}function createInitialSplices(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d];switch(e.type){case"splice":mergeSplice(c,e.index,e.removed.slice(),e.addedCount);break;case"add":case"update":case"delete":if(!isIndex(e.name))continue;var f=toNumber(e.name);if(0>f)continue;mergeSplice(c,f,[e.oldValue],1);break;default:console.error("Unexpected record type: "+JSON.stringify(e))}}return c}function projectArraySplices(a,b){var c=[];return createInitialSplices(a,b).forEach(function(b){return 1==b.addedCount&&1==b.removed.length?void(b.removed[0]!==a[b.index]&&c.push(b)):void(c=c.concat(calcSplices(a,b.index,b.index+b.addedCount,b.removed,0,b.removed.length)))}),c}var testingExposeCycleCount=global.testingExposeCycleCount,hasObserve=detectObjectObserve(),hasEval=detectEval(),numberIsNaN=global.Number.isNaN||function(a){return"number"==typeof a&&global.isNaN(a)},createObject="__proto__"in{}?function(a){return a}:function(a){var b=a.__proto__;if(!b)return a;var c=Object.create(b);return Object.getOwnPropertyNames(a).forEach(function(b){Object.defineProperty(c,b,Object.getOwnPropertyDescriptor(a,b))}),c},identStart="[$_a-zA-Z]",identPart="[$_a-zA-Z0-9]",identRegExp=new RegExp("^"+identStart+"+"+identPart+"*$"),pathStateMachine={beforePath:{ws:["beforePath"],ident:["inIdent","append"],"[":["beforeElement"],eof:["afterPath"]},inPath:{ws:["inPath"],".":["beforeIdent"],"[":["beforeElement"],eof:["afterPath"]},beforeIdent:{ws:["beforeIdent"],ident:["inIdent","append"]},inIdent:{ident:["inIdent","append"],0:["inIdent","append"],number:["inIdent","append"],ws:["inPath","push"],".":["beforeIdent","push"],"[":["beforeElement","push"],eof:["afterPath","push"]},beforeElement:{ws:["beforeElement"],0:["afterZero","append"],number:["inIndex","append"],"'":["inSingleQuote","append",""],'"':["inDoubleQuote","append",""]},afterZero:{ws:["afterElement","push"],"]":["inPath","push"]},inIndex:{0:["inIndex","append"],number:["inIndex","append"],ws:["afterElement"],"]":["inPath","push"]},inSingleQuote:{"'":["afterElement"],eof:["error"],"else":["inSingleQuote","append"]},inDoubleQuote:{'"':["afterElement"],eof:["error"],"else":["inDoubleQuote","append"]},afterElement:{ws:["afterElement"],"]":["inPath","push"]}},constructorIsPrivate={},pathCache={};Path.get=getPath,Path.prototype=createObject({__proto__:[],valid:!0,toString:function(){for(var a="",b=0;b<this.length;b++){var c=this[b];a+=isIdent(c)?b?"."+c:c:formatAccessor(c)}return a},getValueFrom:function(a){for(var b=0;b<this.length;b++){if(null==a)return;a=a[this[b]]}return a},iterateObjects:function(a,b){for(var c=0;c<this.length;c++){if(c&&(a=a[this[c-1]]),!isObject(a))return;b(a,this[0])}},compiledGetValueFromFn:function(){var a="",b="obj";a+="if (obj != null";for(var c,d=0;d<this.length-1;d++)c=this[d],b+=isIdent(c)?"."+c:formatAccessor(c),a+=" &&\n     "+b+" != null";a+=")\n";var c=this[d];return b+=isIdent(c)?"."+c:formatAccessor(c),a+="  return "+b+";\nelse\n  return undefined;",new Function("obj",a)},setValueFrom:function(a,b){if(!this.length)return!1;for(var c=0;c<this.length-1;c++){if(!isObject(a))return!1;a=a[this[c]]}return isObject(a)?(a[this[c]]=b,!0):!1}});var invalidPath=new Path("",constructorIsPrivate);invalidPath.valid=!1,invalidPath.getValueFrom=invalidPath.setValueFrom=function(){};var MAX_DIRTY_CHECK_CYCLES=1e3,eomTasks=[],runEOM=hasObserve?function(){var a={pingPong:!0},b=!1;return Object.observe(a,function(){runEOMTasks(),b=!1}),function(c){eomTasks.push(c),b||(b=!0,a.pingPong=!a.pingPong)}}():function(){return function(a){eomTasks.push(a)}}(),observedObjectCache=[],observedSetCache=[],lastObservedSet,UNOPENED=0,OPENED=1,CLOSED=2,RESETTING=3,nextObserverId=1;Observer.prototype={open:function(a,b){if(this.state_!=UNOPENED)throw Error("Observer has already been opened.");return addToAll(this),this.callback_=a,this.target_=b,this.connect_(),this.state_=OPENED,this.value_},close:function(){this.state_==OPENED&&(removeFromAll(this),this.disconnect_(),this.value_=void 0,this.callback_=void 0,this.target_=void 0,this.state_=CLOSED)},deliver:function(){this.state_==OPENED&&dirtyCheck(this)},report_:function(a){try{this.callback_.apply(this.target_,a)}catch(b){Observer._errorThrownDuringCallback=!0,console.error("Exception caught during observer callback: "+(b.stack||b))}},discardChanges:function(){return this.check_(void 0,!0),this.value_}};var collectObservers=!hasObserve,allObservers;Observer._allObserversCount=0,collectObservers&&(allObservers=[]);var runningMicrotaskCheckpoint=!1,hasDebugForceFullDelivery=hasObserve&&hasEval&&function(){try{return eval("%RunMicrotasks()"),!0}catch(ex){return!1}}();global.Platform=global.Platform||{},global.Platform.performMicrotaskCheckpoint=function(){if(!runningMicrotaskCheckpoint){if(hasDebugForceFullDelivery)return void eval("%RunMicrotasks()");if(collectObservers){runningMicrotaskCheckpoint=!0;var cycles=0,anyChanged,toCheck;do{cycles++,toCheck=allObservers,allObservers=[],anyChanged=!1;for(var i=0;i<toCheck.length;i++){var observer=toCheck[i];observer.state_==OPENED&&(observer.check_()&&(anyChanged=!0),allObservers.push(observer))}runEOMTasks()&&(anyChanged=!0)}while(MAX_DIRTY_CHECK_CYCLES>cycles&&anyChanged);testingExposeCycleCount&&(global.dirtyCheckCycleCount=cycles),runningMicrotaskCheckpoint=!1}}},collectObservers&&(global.Platform.clearObservers=function(){allObservers=[]}),ObjectObserver.prototype=createObject({__proto__:Observer.prototype,arrayObserve:!1,connect_:function(){hasObserve?this.directObserver_=getObservedObject(this,this.value_,this.arrayObserve):this.oldObject_=this.copyObject(this.value_)},copyObject:function(a){var b=Array.isArray(a)?[]:{};for(var c in a)b[c]=a[c];return Array.isArray(a)&&(b.length=a.length),b},check_:function(a){var b,c;if(hasObserve){if(!a)return!1;c={},b=diffObjectFromChangeRecords(this.value_,a,c)}else c=this.oldObject_,b=diffObjectFromOldObject(this.value_,this.oldObject_);return diffIsEmpty(b)?!1:(hasObserve||(this.oldObject_=this.copyObject(this.value_)),this.report_([b.added||{},b.removed||{},b.changed||{},function(a){return c[a]}]),!0)},disconnect_:function(){hasObserve?(this.directObserver_.close(),this.directObserver_=void 0):this.oldObject_=void 0},deliver:function(){this.state_==OPENED&&(hasObserve?this.directObserver_.deliver(!1):dirtyCheck(this))},discardChanges:function(){return this.directObserver_?this.directObserver_.deliver(!0):this.oldObject_=this.copyObject(this.value_),this.value_}}),ArrayObserver.prototype=createObject({__proto__:ObjectObserver.prototype,arrayObserve:!0,copyObject:function(a){return a.slice()},check_:function(a){var b;if(hasObserve){if(!a)return!1;b=projectArraySplices(this.value_,a)}else b=calcSplices(this.value_,0,this.value_.length,this.oldObject_,0,this.oldObject_.length);return b&&b.length?(hasObserve||(this.oldObject_=this.copyObject(this.value_)),this.report_([b]),!0):!1}}),ArrayObserver.applySplices=function(a,b,c){c.forEach(function(c){for(var d=[c.index,c.removed.length],e=c.index;e<c.index+c.addedCount;)d.push(b[e]),e++;Array.prototype.splice.apply(a,d)})},PathObserver.prototype=createObject({__proto__:Observer.prototype,get path(){return this.path_},connect_:function(){hasObserve&&(this.directObserver_=getObservedSet(this,this.object_)),this.check_(void 0,!0)},disconnect_:function(){this.value_=void 0,this.directObserver_&&(this.directObserver_.close(this),this.directObserver_=void 0)},iterateObjects_:function(a){this.path_.iterateObjects(this.object_,a)},check_:function(a,b){var c=this.value_;return this.value_=this.path_.getValueFrom(this.object_),b||areSameValue(this.value_,c)?!1:(this.report_([this.value_,c,this]),!0)},setValue:function(a){this.path_&&this.path_.setValueFrom(this.object_,a)}});var observerSentinel={};CompoundObserver.prototype=createObject({__proto__:Observer.prototype,connect_:function(){if(hasObserve){for(var a,b=!1,c=0;c<this.observed_.length;c+=2)if(a=this.observed_[c],a!==observerSentinel){b=!0;break}b&&(this.directObserver_=getObservedSet(this,a))}this.check_(void 0,!this.reportChangesOnOpen_)},disconnect_:function(){for(var a=0;a<this.observed_.length;a+=2)this.observed_[a]===observerSentinel&&this.observed_[a+1].close();this.observed_.length=0,this.value_.length=0,this.directObserver_&&(this.directObserver_.close(this),this.directObserver_=void 0)},addPath:function(a,b){if(this.state_!=UNOPENED&&this.state_!=RESETTING)throw Error("Cannot add paths once started.");var b=getPath(b);if(this.observed_.push(a,b),this.reportChangesOnOpen_){var c=this.observed_.length/2-1;this.value_[c]=b.getValueFrom(a)}},addObserver:function(a){if(this.state_!=UNOPENED&&this.state_!=RESETTING)throw Error("Cannot add observers once started.");if(this.observed_.push(observerSentinel,a),this.reportChangesOnOpen_){var b=this.observed_.length/2-1;this.value_[b]=a.open(this.deliver,this)}},startReset:function(){if(this.state_!=OPENED)throw Error("Can only reset while open");this.state_=RESETTING,this.disconnect_()},finishReset:function(){if(this.state_!=RESETTING)throw Error("Can only finishReset after startReset");return this.state_=OPENED,this.connect_(),this.value_},iterateObjects_:function(a){for(var b,c=0;c<this.observed_.length;c+=2)b=this.observed_[c],b!==observerSentinel&&this.observed_[c+1].iterateObjects(b,a)},check_:function(a,b){for(var c,d=0;d<this.observed_.length;d+=2){var e,f=this.observed_[d],g=this.observed_[d+1];if(f===observerSentinel){var h=g;e=this.state_===UNOPENED?h.open(this.deliver,this):h.discardChanges()}else e=g.getValueFrom(f);b?this.value_[d/2]=e:areSameValue(e,this.value_[d/2])||(c=c||[],c[d/2]=this.value_[d/2],this.value_[d/2]=e)}return c?(this.report_([this.value_,c,this.observed_]),!0):!1}}),ObserverTransform.prototype={open:function(a,b){return this.callback_=a,this.target_=b,this.value_=this.getValueFn_(this.observable_.open(this.observedCallback_,this)),this.value_},observedCallback_:function(a){if(a=this.getValueFn_(a),!areSameValue(a,this.value_)){var b=this.value_;this.value_=a,this.callback_.call(this.target_,this.value_,b)}},discardChanges:function(){return this.value_=this.getValueFn_(this.observable_.discardChanges()),this.value_},deliver:function(){return this.observable_.deliver()},setValue:function(a){return a=this.setValueFn_(a),!this.dontPassThroughSet_&&this.observable_.setValue?this.observable_.setValue(a):void 0},close:function(){this.observable_&&this.observable_.close(),this.callback_=void 0,this.target_=void 0,this.observable_=void 0,this.value_=void 0,this.getValueFn_=void 0,this.setValueFn_=void 0}};var expectedRecordTypes={add:!0,update:!0,"delete":!0},EDIT_LEAVE=0,EDIT_UPDATE=1,EDIT_ADD=2,EDIT_DELETE=3;ArraySplice.prototype={calcEditDistances:function(a,b,c,d,e,f){for(var g=f-e+1,h=c-b+1,i=new Array(g),j=0;g>j;j++)i[j]=new Array(h),i[j][0]=j;for(var k=0;h>k;k++)i[0][k]=k;for(var j=1;g>j;j++)for(var k=1;h>k;k++)if(this.equals(a[b+k-1],d[e+j-1]))i[j][k]=i[j-1][k-1];else{var l=i[j-1][k]+1,m=i[j][k-1]+1;i[j][k]=m>l?l:m}return i},spliceOperationsFromEditDistances:function(a){for(var b=a.length-1,c=a[0].length-1,d=a[b][c],e=[];b>0||c>0;)if(0!=b)if(0!=c){var f,g=a[b-1][c-1],h=a[b-1][c],i=a[b][c-1];f=i>h?g>h?h:g:g>i?i:g,f==g?(g==d?e.push(EDIT_LEAVE):(e.push(EDIT_UPDATE),d=g),b--,c--):f==h?(e.push(EDIT_DELETE),b--,d=h):(e.push(EDIT_ADD),c--,d=i)}else e.push(EDIT_DELETE),b--;else e.push(EDIT_ADD),c--;return e.reverse(),e},calcSplices:function(a,b,c,d,e,f){var g=0,h=0,i=Math.min(c-b,f-e);if(0==b&&0==e&&(g=this.sharedPrefix(a,d,i)),c==a.length&&f==d.length&&(h=this.sharedSuffix(a,d,i-g)),b+=g,e+=g,c-=h,f-=h,c-b==0&&f-e==0)return[];if(b==c){for(var j=newSplice(b,[],0);f>e;)j.removed.push(d[e++]);return[j]}if(e==f)return[newSplice(b,[],c-b)];for(var k=this.spliceOperationsFromEditDistances(this.calcEditDistances(a,b,c,d,e,f)),j=void 0,l=[],m=b,n=e,o=0;o<k.length;o++)switch(k[o]){case EDIT_LEAVE:j&&(l.push(j),j=void 0),m++,n++;break;case EDIT_UPDATE:j||(j=newSplice(m,[],0)),j.addedCount++,m++,j.removed.push(d[n]),n++;break;case EDIT_ADD:j||(j=newSplice(m,[],0)),j.addedCount++,m++;break;case EDIT_DELETE:j||(j=newSplice(m,[],0)),j.removed.push(d[n]),n++}return j&&l.push(j),l},sharedPrefix:function(a,b,c){for(var d=0;c>d;d++)if(!this.equals(a[d],b[d]))return d;return c},sharedSuffix:function(a,b,c){for(var d=a.length,e=b.length,f=0;c>f&&this.equals(a[--d],b[--e]);)f++;return f},calculateSplices:function(a,b){return this.calcSplices(a,0,a.length,b,0,b.length)},equals:function(a,b){return a===b}};var arraySplice=new ArraySplice,expose=global;"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(expose=exports=module.exports),expose=exports),expose.Observer=Observer,expose.Observer.runEOM_=runEOM,expose.Observer.observerSentinel_=observerSentinel,expose.Observer.hasObjectObserve=hasObserve,expose.ArrayObserver=ArrayObserver,expose.ArrayObserver.calculateSplices=function(a,b){return arraySplice.calculateSplices(a,b)},expose.Platform=global.Platform,expose.ArraySplice=ArraySplice,expose.ObjectObserver=ObjectObserver,expose.PathObserver=PathObserver,expose.CompoundObserver=CompoundObserver,expose.Path=Path,expose.ObserverTransform=ObserverTransform}("undefined"!=typeof global&&global&&"undefined"!=typeof module&&module?global:this||window)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],25:[function(a,b){function c(a){return this?(this.name=a,this.trace=d(this,_.bind(console.debug?console.debug:console.log,console),c.Level.trace),this.debug=d(this,_.bind(console.debug?console.debug:console.log,console),c.Level.debug),this.info=d(this,_.bind(console.info?console.info:console.log,console),c.Level.info),this.log=d(this,_.bind(console.log?console.log:console.log,console),c.Level.info),this.warn=d(this,_.bind(console.warn?console.warn:console.log,console),c.Level.warning),this.error=d(this,_.bind(console.error?console.error:console.log,console),c.Level.error),void(this.fatal=d(this,_.bind(console.error?console.error:console.log,console),c.Level.fatal))):new c(a)}function d(a,b,c){var d=function(d){a.performLog(b,c,d,arguments)};return Object.defineProperty(d,"isEnabled",{get:function(){var b=a.currentLevel();return c>=b},enumerable:!0,configurable:!0}),d.f=b,d.logger=a,d.level=c,d}var e={};c.Level={trace:0,debug:1,info:2,warning:3,warn:3,error:4,fatal:5},c.LevelText={},c.LevelText[c.Level.trace]="TRACE",c.LevelText[c.Level.debug]="DEBUG",c.LevelText[c.Level.info]="INFO ",c.LevelText[c.Level.warning]="WARN ",c.LevelText[c.Level.error]="ERROR",c.levelAsText=function(a){return this.LevelText[a]},c.loggerWithName=function(a){return new c(a)},c.prototype.currentLevel=function(){var a=e[this.name];
return a?a:c.Level.trace},c.prototype.setLevel=function(a){e[this.name]=a},c.prototype.override=function(a,b,d){var e=c.levelAsText(a),f=this[e.trim().toLowerCase()],g=f.f,h=Array.prototype.slice.call(arguments,3,arguments.length);this.performLog(g,a,d,h,b)},c.prototype.performLog=function(a,b,d,e,f){var g=this,h=void 0!==f?f:this.currentLevel();if(b>=h){a=_.partial(a,c.levelAsText(b)+" ["+g.name+"]: "+d);for(var i=[],j=0;j<e.length;j++)i[j]=e[j];i.splice(0,1),a.apply(a,i)}},b.exports=c},{}],26:[function(a,b){function c(){if(!this)return new(Function.prototype.bind.apply(c,arguments));var a=this;arguments.length&&("string"==typeof arguments[0]?(this.name=arguments[0],this.work=arguments[1],this.completion=arguments[2]):("function"==typeof arguments[0]||"[object Array]"===Object.prototype.toString.call(arguments[0])||arguments[0]instanceof c)&&(this.work=arguments[0],this.completion=arguments[1])),this.error=null,this.completed=!1,this.result=null,this.running=!1,this.cancelled=!1,this.dependencies=[],this._mustSucceed=[],this._onCompletion=[],this.logLevel=null,Object.defineProperty(this,"failed",{get:function(){return!!a.error||a.failedDueToDependency},enumerable:!0,configurable:!0}),Object.defineProperty(this,"composite",{get:function(){return a.work instanceof c||"[object Array]"===Object.prototype.toString.call(a.work)},enumerable:!0,configurable:!0}),Object.defineProperty(this,"numOperationsRemaining",{get:function(){return a.work instanceof c?a.work.completed?0:1:"[object Array]"===Object.prototype.toString.call(a.work)?_.reduce(a.work,function(a,b){return b.completed?a:a+1},0):null},enumerable:!0,configurable:!0}),Object.defineProperty(this,"canRun",{get:function(){return a.dependencies.length?_.reduce(a.dependencies,function(b,c){var d=a._mustSucceed.indexOf(c)>-1,e=b&&c.completed;return d&&e&&(e=e&&!(c.failed||c.cancelled)),e},!0):!0},enumerable:!0,configurable:!0}),Object.defineProperty(this,"failedDueToDependency",{get:function(){if(a.dependencies.length){var b=_.reduce(a.dependencies,function(b,c){var d=a._mustSucceed.indexOf(c)>-1,e=(c.failed||c.cancelled)&&d;return e&&b.push(c),b},[]);return b.length?b:!1}return!1},enumerable:!0,configurable:!0}),Object.defineProperty(this,"failedDueToCancellationOfDependency",{get:function(){if(a.dependencies.length){var b=_.reduce(a.dependencies,function(b,c){var d=a._mustSucceed.indexOf(c)>-1;return d&&c.cancelled&&b.push(c),b},[]);return b.length?b:!1}return!1},enumerable:!0,configurable:!0}),Object.defineProperty(this,"loggingOveridden",{get:function(){return a.logLevel?a.logLevel<=d.Level.info:!1},enumerable:!0,configurable:!0})}var d=a("./log"),e=d.loggerWithName("Operation");c.running=[],c.prototype._startSingle=function(){var a=this;this.work(function(b,c){a.result=c,a.error=b,a.completed=!0,a.running=!1,a._complete()})},c.prototype._startComposite=function(){var a=this,b=a.work instanceof c?[a.work]:a.work;_.each(b,function(c){c.onCompletion(function(){var c=a.numOperationsRemaining,d=a.name||"Unnamed";if(e.debug(d+" has "+c.toString()+" operations remaining"),!c){var f=_.pluck(b,"error"),g=_.pluck(b,"result");a.result=_.some(g)?g:null,a.error=_.some(f)?f:null,a.completed=!0,a.running=!1,a._complete()}}),c.start()})},c.prototype._logCompletion=function(){var a=this._getLogFunc();if(e.info.isEnabled||this.loggingOveridden){var b=this.name||"Unnamed",c=this.failedDueToDependency;if(c)a('"'+b+'" failed due to failure/cancellation of dependencies: '+_.pluck(c,"name").join(", "));else if(this.failed){var d=this.error;d="[object Array]"===Object.prototype.toString.call(d)?_.filter(d,function(a){return a}):[this.error],a('"'+b+'" failed due to errors:',d)}else a(this.cancelled?'"'+b+'" has been cancelled.':'"'+b+'" has succeeded.')}},c.prototype._getLogFunc=function(){return this.logLevel?_.bind(e.override,e,d.Level.info,this.logLevel):e.info},c.prototype._logStart=function(){if(e.info.isEnabled||this.loggingOveridden){var a=this.name||"Unnamed",b=this._getLogFunc();b('"'+a+'" has started.')}},c.prototype._complete=function(){var a=this;this.completed=!0;var b=c.running.indexOf(this);c.running.splice(b,1),this.completion&&_.bind(this.completion,this)(),this._logCompletion(),_.each(this._onCompletion,function(b){_.bind(b,a)()})},c.prototype.__start=function(){this._logStart(),this.work?(this.composite?this._startComposite():this._startSingle(),c.running.push(this)):(this.result=null,this.error=null,this.running=!1,this._complete())},c.prototype.start=function(){var a=this,b=!this.running&&!this.completed,c=b&&this.failed;c?this._complete():b&&(this.running=!0,this.canRun?this.__start():_.each(this.dependencies,function(b){b.onCompletion(function(){a.canRun&&a.__start()})}))},c.prototype.addDependency=function(){var a=this;if(1==arguments.length)this.dependencies.push(arguments[0]);else if(arguments.length){var b=arguments,c=b[b.length-1],d=!1;"boolean"==typeof c&&(b=Array.prototype.slice.call(b,0,b.length-1),d=c),_.each(b,function(b){a.dependencies.push(b)}),d&&_.each(b,function(b){a._mustSucceed.push(b)})}},c.prototype.onCompletion=function(a){this.completed?_.bind(a,this)():this._onCompletion.push(a)},c.prototype.cancel=function(a){this.cancelled||(this.cancelled=!0,e.debug("Cancelling "+this.name,this),this.composite&&_.each(this.work,function(a){a.cancel()}),this.onCompletion(function(){this.running=!1,a&&a()}))},Object.defineProperty(c,"logLevel",{get:function(){return e.currentLevel()},set:function(a){e.setLevel(a)},configurable:!0,enumerable:!0}),b.exports.Operation=c},{"./log":25}],27:[function(a,b){function c(){if(!this)return new(Function.prototype.bind.apply(c,arguments));var a=this;arguments.length&&("number"==typeof arguments[0]?this.maxConcurrentOperations=arguments[0]:(this.name=arguments[0],this.maxConcurrentOperations=arguments[1])),this._queuedOperations=[],this._runningOperations=[],this._running=!1,this._onStart=[],this._onStop=[],this.logLevel=null,Object.defineProperty(this,"numRunningOperations",{get:function(){return a._runningOperations.length},configurable:!0,enumerable:!0}),Object.defineProperty(this,"loggingOveridden",{get:function(){return a.logLevel?a.logLevel<=d.Level.info:!1},enumerable:!0,configurable:!0})}var d=a("./log"),e=d.loggerWithName("OperationQueue");c.prototype._nextOperations=function(){for(var a=this;a._runningOperations.length<a.maxConcurrentOperations&&a._queuedOperations.length;){var b=a._queuedOperations[0];a._queuedOperations.splice(0,1),a._runOperation(b)}},c.prototype._runOperation=function(a){for(var b=this,c=0;c<this._queuedOperations.length;c++)if(this._queuedOperations[c]==a){this._queuedOperations.splice(c,1);break}this._runningOperations.push(a),a.completion=function(){var c=b._runningOperations.indexOf(a);b._runningOperations.splice(c,1),b._running&&b._nextOperations(),b._logStatus()},a.start(),this._logStatus()},c.prototype._logStatus=function(){var a=this._getLogFunc();if(e.info.isEnabled||this.loggingOveridden){var b=this.numRunningOperations,c=this._queuedOperations.length,d=this.name||"Unnamed Queue";a(b&&c?'"'+d+'" now has '+b.toString()+" operations running and "+c.toString()+" operations queued":b?'"'+d+'" now has '+b.toString()+" operations running":c?'"'+d+'" now has '+c.toString()+" operations queued":'"'+d+'" has no operations running or queued')}},c.prototype._logStart=function(){var a=this._getLogFunc();if(e.info.isEnabled||this.loggingOveridden){var b=this.name||"Unnamed Queue";a('"'+b+'" is now running')}},c.prototype._getLogFunc=function(){return this.logLevel?_.bind(e.override,e,d.Level.info,this.logLevel):e.info},c.prototype._logStop=function(){var a=this._getLogFunc();if(e.info.isEnabled||this.loggingOveridden){var b=this.name||"Unnamed Queue";a('"'+b+'" is no longer running')}},c.prototype._addOperation=function(a){this.numRunningOperations<this.maxConcurrentOperations&&this._running?this._runOperation(a):this._queuedOperations.push(a),this._logStatus()},c.prototype.addOperation=function(a){var b=this;"[object Array]"===Object.prototype.toString.call(a)?_.each(a,function(a){b._addOperation(a)}):this._addOperation(a)},c.prototype.start=function(){var a=this,b=this._running;this._running=!0,b||(_.each(a._onStart,function(b){_.bind(b,a)()}),a._nextOperations(),a._logStart())},c.prototype.stop=function(a){var b=this,c=this._running;if(this._running=!1,c){if(a){var d=this._runningOperations.slice(0);_.each(d,function(a){a.cancel()})}b._logStop(),_.each(b._onStop,function(a){_.bind(a,b)()})}},c.prototype.onStart=function(a){this._onStart.push(a)},c.prototype.onStop=function(a){this._onStop.push(a)},Object.defineProperty(c,"logLevel",{get:function(){return e.currentLevel()},set:function(a){e.setLevel(a)},configurable:!0,enumerable:!0}),b.exports.OperationQueue=c},{"./log":25}]},{},[1]);