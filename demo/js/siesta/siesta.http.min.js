!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){function d(a){return a?"*"==a||a.indexOf("*")>-1?a=p:i.isArray(a)||(a=[a]):a=["GET"],n.map(a,function(a){return a.toUpperCase()})}function e(a){if(!this)return new e(a);this._rawOpts=m(!0,{},a),this._opts=a;var b=function(a){return a instanceof RegExp||(a=new RegExp(a,"g")),a}.bind(this);if(this._opts.path){var c=this._opts.path;i.isArray(c)||(c=[c]),this._opts.path=[],n.each(c,function(a){this._opts.path.push(b.call(this,a))}.bind(this))}else this._opts.path=[""];if(this._opts.method=d(this._opts.method),!this._opts.mapping)throw new Error("Descriptors must be initialised with a mapping",{opts:a,descriptor:this});if("string"==typeof this._opts.mapping){if(!this._opts.collection)throw new Error("Passed mapping as string, but did not specify the collection it belongs to",{opts:a,descriptor:this});var f;if(f="string"==typeof this._opts.collection?l[this._opts.collection]:this._opts.collection,!f)throw new Error("Collection "+this._opts.collection+" does not exist",{opts:a,descriptor:this});var g=f[this._opts.mapping];if(!g)throw new Error("Mapping "+this._opts.mapping+" does not exist",{opts:a,descriptor:this});this._opts.mapping=g}var h=this._opts.data;if(h&&h.length){var j,o=h.split(".");if(1==o.length)j=o[0];else{var p={};j=p;for(var q=o[0],r=1;r<o.length;r++){var s=o[r];if(r==o.length-1)p[q]=s;else{var t={};p[q]=t,p=t,q=s}}}this._opts.data=j}k.call(this,"path",this._opts),k.call(this,"method",this._opts),k.call(this,"mapping",this._opts),k.call(this,"data",this._opts),k.call(this,"transforms",this._opts)}var f=siesta._internal,g=f.log,h=f.error.InternalSiestaError,i=f.util,j=i.assert,k=i.defineSubProperty,l=f.CollectionRegistry,m=f.extend,n=i._,o=g.loggerWithName("Descriptor");o.setLevel(g.Level.trace);var p=["POST","PATCH","PUT","HEAD","GET","DELETE","OPTIONS","TRACE","CONNECT"];n.extend(e.prototype,{httpMethods:p,_matchPath:function(a){var b;for(b=0;b<this._opts.path.length;b++){var c=this._opts.path[b];o.trace.isEnabled&&o.trace("Matching path",a,c.toString());var d=c.exec(a);if(o.trace.isEnabled&&(d?o.trace("Matched path successfully",a,c.toString()):o.trace("Failed to match path",a,c.toString())),d)return!0}return!1},_matchMethod:function(a){for(var b=0;b<this.method.length;b++)if(a.toUpperCase()==this.method[b])return!0;return!1},bury:function(a,b){var c=b,d=Object.keys(b);j(1==d.length);for(var e=d[0],f=b;"string"!=typeof f[e];)f=f[e],d=Object.keys(f),j(1==d.length),e=d[0];var g=f[e],h={};return f[e]=h,h[g]=a,c},_embedData:function(a){if(this.data){var b;return"string"==typeof this.data?(b={},b[this.data]=a):b=this.bury(a,m(!0,{},this.data)),b}return a},_extractData:function(a){if(o.debug.isEnabled&&o.debug("_extractData",a),this.data){if("string"==typeof this.data)return a[this.data];var b=Object.keys(this.data);j(1==b.length);for(var c=a,d=this.data;"string"!=typeof d;){b=Object.keys(d),j(1==b.length);var e=b[0];if(d=d[e],c=c[e],!c)break}return c?c[d]:null}return a},_matchConfig:function(a){var b=a.type?this._matchMethod(a.type):{};return b&&(b=a.url?this._matchPath(a.url):{}),b},_matchData:function(a){var b=null;return this.data?a&&(b=this._extractData(a)):b=a,b},match:function(a,b){var c=this._matchConfig(a),d=!!c,e=!1;return d&&(e=this._matchData(b)),e},_transformData:function(a){var b=this.transforms;if("function"==typeof b)a=b(a);else for(var c in b)if(b.hasOwnProperty(c)&&a[c]){var d=b[c],e=a[c];if("string"==typeof d){var f=d.split(".");if(delete a[c],1==f.length)a[f[0]]=e;else{a[f[0]]={};for(var g=a[f[0]],j=1;j<f.length-1;j++){var k=f[j];g[k]={},g=g[k]}g[f[f.length-1]]=e}}else{if("function"!=typeof d)throw new h("Invalid transformer");var l=d(e);i.isArray(l)?(delete a[c],a[l[0]]=l[1]):a[c]=l}}return a}}),c.Descriptor=e,c.resolveMethod=d},{}],2:[function(a,b,c){function d(){return this?(this.requestDescriptors={},void(this.responseDescriptors={})):new d(opts)}function e(a,b){var c=b.mapping,d=c.collection;i(c),i(d),i("string"==typeof d),a[d]||(a[d]=[]),a[d].push(b)}function f(a,b){var c;return c="string"==typeof b?a[b]||[]:a[b._name]||[]}var g=siesta._internal,h=g.util,i=h.assert,j=h._,k=g.log,l=k.loggerWithName("DescriptorRegistry");l.setLevel(k.Level.warn),console.log("_",j),j.extend(d.prototype,{registerRequestDescriptor:function(a){e(this.requestDescriptors,a)},registerResponseDescriptor:function(a){l.trace.isEnabled&&l.trace("registerResponseDescriptor"),e(this.responseDescriptors,a)},requestDescriptorsForCollection:function(a){return f(this.requestDescriptors,a)},responseDescriptorsForCollection:function(a){var b=f(this.responseDescriptors,a);return b.length||l.debug.isEnabled&&l.debug("No response descriptors for collection ",this.responseDescriptors),b},reset:function(){this.requestDescriptors={},this.responseDescriptors={}}}),c.DescriptorRegistry=new d},{}],3:[function(a,b){function c(a,b,c){if(y.debug.isEnabled){var d=y.debug,e=a.type+" "+b.status+" "+a.url;y.trace.isEnabled&&c&&(d=y.trace,e+=": "+JSON.stringify(c,null,4)),d(e)}}function d(a){if(y.debug.isEnabled){var b=y.debug,c=a.type+" "+a.url;y.trace.isEnabled&&(b=y.trace),b(c)}}function e(a,b,e,f){var g=this,h=Array.prototype.slice.call(arguments,2),i={},j=this._name;"function"==typeof h[0]?f=h[0]:"object"==typeof h[0]&&(i=h[0],f=h[1]);var k=window.q?window.q.defer():null;if(f=s.constructCallbackAndPromiseHandler(f,k),i.type=a,!i.url){var l=this.baseURL;i.url=l+b}void 0===i.parseResponse&&(i.parseResponse=!0),i.success=function(a,b,d){c(i,d,a);var e={data:a,status:b,xhr:d};if(i.parseResponse){for(var h,k,l=x.responseDescriptorsForCollection(g),m=0;m<l.length;m++){var n=l[m];if(k=n.match(i,a)){h=n;break}}if(h)if(y.trace.isEnabled&&y.trace("Mapping extracted data: "+JSON.stringify(k,null,4)),"object"==typeof k){var o=h.mapping;o.map(k,function(a,b){f&&f(a,b,e)},i.obj)}else f(null,!0,e);else if(f){if(!j)throw new w("Unnamed collection");var p={},q=t.ErrorCode.NoDescriptorMatched;p[t.ErrorField.Code]=q,p[t.ErrorField.Message]=t.Message[q],f(p,null,e)}}else f(null,null,e)},i.error=function(a,b,c){var d={xhr:a,status:b,error:c};f&&f(d,null,d)},d(i),siesta.ext.http.ajax(i)}function f(a,b,c){this._serialise(b,function(b,d){var e=d;a.fields&&(e={},u.each(a.fields,function(a){e[a]=d[a]})),c(b,e)})}function g(a,b,c){var d,g=this,h=Array.prototype.slice.call(arguments,3),i={};"function"==typeof h[0]?d=h[0]:"object"==typeof h[0]&&(i=h[0],d=h[1]);var j=window.q?window.q.defer():null;d=s.constructCallbackAndPromiseHandler(d,j),h=Array.prototype.slice.call(h,2);var k,l=x.requestDescriptorsForCollection(this);i.type=a;var m=this.baseURL;i.url=m+b;for(var n=0;n<l.length;n++){var o=l[n];if(o._matchConfig(i)){k=o;break}}return k?(y.trace.isEnabled&&y.trace("Matched descriptor: "+k._dump(!0)),f.call(k,c,i,function(f,j){y.trace.isEnabled&&y.trace("_serialise",{err:f,data:j}),f?d&&d(f,null,null):(i.data=j,i.obj=c,u.partial(e,a,b,i,d).apply(g,h))})):d&&(y.trace.isEnabled&&y.trace("Did not match descriptor"),d("No descriptor matched",null,null)),j?j.promise:null}function h(a,b,c){var d,f=window.q?window.q.defer():null,g=Array.prototype.slice.call(arguments,3),h={};"function"==typeof g[0]?d=g[0]:"object"==typeof g[0]&&(h=g[0],d=g[1]),d=s.constructCallbackAndPromiseHandler(d,f);var i=h.deletionMode||"restore";return void 0===h.parseResponse&&(h.parseResponse=!1),e.call(a,"DELETE",b,h,function(a,b,e,f){a?"restore"==i&&c.restore():"success"==i&&c.remove(),d(a,b,e,f)}),("now"==i||"restore"==i)&&c.remove(),f?f.promise:null}function i(a,b,c){var d=Array.prototype.slice.call(arguments,3);return u.partial(b?g:e,c).apply(a,d)}function j(a){var b=Array.prototype.slice.call(arguments,1);return u.partial(i,a,!1,"GET").apply(this,b)}function k(a){var b=Array.prototype.slice.call(arguments,1);return u.partial(i,a,!1,"OPTIONS").apply(this,b)}function l(a){var b=Array.prototype.slice.call(arguments,1);return u.partial(i,a,!1,"TRACE").apply(this,b)}function m(a){var b=Array.prototype.slice.call(arguments,1);return u.partial(i,a,!1,"HEAD").apply(this,b)}function n(a){var b=Array.prototype.slice.call(arguments,1);return u.partial(i,a,!0,"POST").apply(this,b)}function o(a){var b=Array.prototype.slice.call(arguments,1);return u.partial(i,a,!0,"PUT").apply(this,b)}function p(a){var b=Array.prototype.slice.call(arguments,1);return u.partial(i,a,!0,"PATCH").apply(this,b)}if("undefined"==typeof siesta&&"undefined"==typeof b)throw new Error("Could not find window.siesta. Make sure you include siesta.core.js first.");var q=siesta._internal,r=(siesta.Collection,q.log),s=q.util,t=q.error,u=s._,v=a("./descriptor"),w=q.error.InternalSiestaError,x=a("./descriptorRegistry").DescriptorRegistry,y=r.loggerWithName("HTTP");y.setLevel(r.Level.trace);var z,A={RequestDescriptor:a("./requestDescriptor").RequestDescriptor,ResponseDescriptor:a("./responseDescriptor").ResponseDescriptor,Descriptor:v.Descriptor,_resolveMethod:v.resolveMethod,Serialiser:a("./serialiser"),DescriptorRegistry:a("./descriptorRegistry").DescriptorRegistry,setAjax:function(a){z=a},_httpResponse:e,_httpRequest:g,DELETE:h,HTTP_METHOD:i,GET:j,TRACE:l,OPTIONS:k,HEAD:m,POST:n,PUT:o,PATCH:p,_serialiseObject:f};Object.defineProperty(A,"ajax",{get:function(){var a=z||($?$.ajax:null)||(jQuery?jQuery.ajax:null);if(!a)throw new w("ajax has not been defined and could not find $.ajax or jQuery.ajax");return a},set:function(a){z=a}}),"undefined"!=typeof siesta&&(siesta.ext||(siesta.ext={}),siesta.ext.http=A),"undefined"!=typeof b&&(b.exports=A)},{"./descriptor":1,"./descriptorRegistry":2,"./requestDescriptor":4,"./responseDescriptor":5,"./serialiser":6}],4:[function(a,b,c){function d(a){return this?(e.call(this,a),this._opts.serializer&&(this._opts.serialiser=this._opts.serializer),this._opts.serialiser||(this._opts.serialiser=f.depthSerializer(0)),k.call(this,"serialiser",this._opts),void k.call(this,"serializer",this._opts,"serialiser")):new d(a)}var e=a("./descriptor").Descriptor,f=a("./serialiser"),g=siesta._internal,h=g.util,i=h._,j=g.log,k=h.defineSubProperty,l=j.loggerWithName("RequestDescriptor");l.setLevel(j.Level.warn),d.prototype=Object.create(e.prototype),i.extend(d.prototype,{_serialise:function(a,b){var c=window.q?window.q.defer():null;b=h.constructCallbackAndPromiseHandler(b,c);var d=this;l.trace.isEnabled&&l.trace("_serialise");var e,f=this.serialiser(a,function(a,c){e||(c=d._transformData(c),b&&b(a,d._embedData(c)))});return void 0!==f?(l.trace.isEnabled&&l.trace("serialiser doesnt use a callback"),e=!0,f=d._transformData(f),b&&b(null,d._embedData(f))):l.trace.isEnabled&&l.trace("serialiser uses a callback",this.serialiser),c?c.promise:null},_dump:function(a){var b={};b.methods=this.method,b.mapping=this.mapping.type,b.path=this._rawOpts.path;var c;c="function"==typeof this._rawOpts.serialiser?"function () { ... }":this._rawOpts.serialiser,b.serialiser=c;var d={};for(var e in this.transforms)if(this.transforms.hasOwnProperty(e)){var f=this.transforms[e];d[e]="function"==typeof f?"function () { ... }":this.transforms[e]}return b.transforms=d,a?JSON.stringify(b,null,4):b}}),c.RequestDescriptor=d},{"./descriptor":1,"./serialiser":6}],5:[function(a,b,c){function d(a){return this?void e.call(this,a):new d(a)}var e=a("./descriptor").Descriptor;d.prototype=Object.create(e.prototype),_.extend(d.prototype,{_extractData:function(a){var b=e.prototype._extractData.call(this,a);return b&&(b=this._transformData(b)),b},_matchData:function(a){var b=e.prototype._matchData.call(this,a);return b&&(b=this._transformData(b)),b},_dump:function(a){var b={};b.methods=this.method,b.mapping=this.mapping.type,b.path=this._rawOpts.path;var c={};for(var d in this.transforms)if(this.transforms.hasOwnProperty(d)){var e=this.transforms[d];c[d]="function"==typeof e?"function () { ... }":this.transforms[d]}return b.transforms=c,a?JSON.stringify(b,null,4):b}}),c.ResponseDescriptor=d},{"./descriptor":1}],6:[function(a,b,c){function d(a){var b=a.mapping.id;return b?a[b]?a[b]:null:void(i.debug.isEnabled&&i.debug("No idfield"))}function e(a,b,c){i.trace.isEnabled&&i.trace("depthSerialiser");var d={};j.each(b._fields,function(a){i.trace.isEnabled&&i.trace("field",a),b[a]&&(d[a]=b[a])});var f=[],g=[],h={},k=[];j.each(b._relationshipFields,function(j){i.trace.isEnabled&&i.trace("relationshipField",j);var l=b.__proxies[j];l.isForward&&(i.debug.isEnabled&&i.debug(j),f.push(j),l.get(function(l,m){i.trace.isEnabled&&i.trace("proxy.get",j),i.debug.isEnabled&&i.debug(j,m),l?(g.push(l),k.push(j),h[j]={err:l,v:m}):m?a?e(a-1,m,function(a,b,e){a?g.push(a):d[j]=b,k.push(j),h[j]={err:a,v:m,resp:e},f.length==k.length&&c&&c(g.length?g:null,d,h)}):(k.push(j),d[j]=m[b.__proxies[j].forwardMapping.id],h[j]={err:l,v:m},f.length==k.length&&c&&c(g.length?g:null,d,h)):(i.debug.isEnabled&&i.debug("no value for "+j),k.push(j),h[j]={err:l,v:m},f.length==k.length&&c&&c(g.length?g:null,d,h))}))}),f.length||c&&c(null,d,{})}var f=siesta._internal,g=f.log,h=f.util,i=g.loggerWithName("Serialiser");i.setLevel(g.Level.warn);var j=h._;c.depthSerialiser=function(a){return j.partial(e,a)},c.depthSerializer=function(a){return j.partial(e,a)},c.idSerializer=d,c.idSerialiser=d},{}]},{},[3]);