!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){function d(){y={},w={},x={}}function e(a){var b=w[a];return b?u.debug.isEnabled&&u.debug("Local cache hit: "+b._dump(!0)):u.debug.isEnabled&&u.debug("Local cache miss: "+a),b}function f(a){var b=a.type,c=a.collection,d=x[c];if(d){var e=d[b];if(e){var f=[];for(var g in e)e.hasOwnProperty(g)&&f.push(e[g]);if(f.length>1)throw new s("A singleton mapping has more than 1 object in the cache! This is a serious error. Either a mapping has been modified after objects have already been created, or something has gonevery wrong. Please file a bug report if the latter.");if(f.length)return f[0]}}return null}function g(a,b){var c=b.mapping.type,d=b.mapping.collection,e=y[d];if(e){var f=y[d][c];if(f){var g=f[a];return g?v.debug.isEnabled&&v.debug("Remote cache hit: "+g._dump(!0)):v.debug.isEnabled&&v.debug("Remote cache miss: "+a),g}}return v.debug.isEnabled&&v.debug("Remote cache miss: "+a),null}function h(a,b,c){if(!a){var d="Must pass an object when inserting to cache";throw v.error(d),new s(d)}var e=a.mapping.collection;if(!e)throw new s("Mapping has no collection",{mapping:a.mapping,obj:a});y[e]||(y[e]={});var f=a.mapping.type;if(!f)throw new s("Mapping has no type",{mapping:a.mapping,obj:a});y[e][f]||(y[e][f]={}),c&&(y[e][f][c]=null);var g=y[e][f][b];if(g){if(a!=g){var h="Object "+e.toString()+":"+f.toString()+"["+a.mapping.id+'="'+b+'"] already exists in the cache. This is a serious error, please file a bug report if you are experiencing this out in the wild';throw v.error(h,{obj:a,cachedObject:g}),t.printStackTrace(),new s(h)}v.debug.isEnabled&&v.debug("Object has already been inserted: "+a._dump(!0))}else y[e][f][b]=a,v.debug.isEnabled&&v.debug("Remote cache insert: "+a._dump(!0)),v.trace.isEnabled&&v.trace("Remote cache now looks like: "+i(!0))}function i(a){var b={};for(var c in y)if(y.hasOwnProperty(c)){var d={};b[c]=d;var e=y[c];for(var f in e)if(e.hasOwnProperty(f)){var g={};d[f]=g;var h=e[f];for(var i in h)h.hasOwnProperty(i)&&h[i]&&(g[i]=h[i]._dump())}}return a?JSON.stringify(b,null,4):b}function j(a){var b={};for(var c in w)w.hasOwnProperty(c)&&(b[c]=w[c]._dump());return a?JSON.stringify(b,null,4):b}function k(a){var b={localCache:j(),remoteCache:i()};return a?JSON.stringify(b,null,4):b}function l(){return y}function m(){return w}function n(a){u.debug.isEnabled&&u.debug("get",a);var b,c,d,h=a._id;if(h)return b=e(h),b?b:a.mapping?(c=a.mapping.id,d=a[c],u.debug.isEnabled&&u.debug(c+"="+d),g(d,a)):null;if(a.mapping){if(c=a.mapping.id,d=a[c])return g(d,a);if(a.mapping.singleton)return f(a.mapping)}else u.warn("Invalid opts to cache",{opts:a});return null}function o(a){var b=a._id;if(b){var c=a.mapping.collection,d=a.mapping.type;if(w[b]){if(w[b]!=a){var e='Object with _id="'+b.toString()+'" is already in the cache. This is a serious error. Please file a bug report if you are experiencing this out in the wild';throw u.error(e),new s(e)}}else u.debug.isEnabled&&u.debug("Local cache insert: "+a._dump(!0)),w[b]=a,u.trace.isEnabled&&u.trace("Local cache now looks like: "+j(!0)),x[c]||(x[c]={}),x[c][d]||(x[c][d]={}),x[c][d][b]=a}var f=a.idField,g=a[f];g?h(a,g):v.debug.isEnabled&&v.debug('No remote id ("'+f+'") so wont be placing in the remote cache',a)}function p(a){var b={_id:a._id},c=a.mapping;return c.id&&a[c.id]&&(b.mapping=c,b[c.id]=a[c.id]),!!n(b)}function q(a){if(!p(a))throw new s("Object was not in cache.");var b=a.mapping.collection,c=a.mapping.type,d=a._id;if(!c)throw s("No mapping name");if(!b)throw s("No collection name");if(!d)throw s("No _id");if(delete x[b][c][d],delete w[d],a.mapping.id){var e=a[a.mapping.id];delete y[b][c][e]}}var r=a("./operation/log"),s=a("./error").InternalSiestaError,t=a("./util"),u=r.loggerWithName("LocalCache"),v=r.loggerWithName("RemoteCache");v.setLevel(r.Level.warn),u.setLevel(r.Level.warn);var w,x,y;d(),c._remoteCache=l,c._localCache=m,Object.defineProperty(c,"_localCacheByType",{get:function(){return x}}),c.get=n,c.insert=o,c.remoteInsert=h,c.reset=d,c._dump=k,c.contains=p,c.remove=q},{"./error":5,"./operation/log":13,"./util":21}],2:[function(a,b,c){function d(a){this._opts=a,this._opts||(this._opts={}),h.call(this,"collection",this._opts),h.call(this,"mapping",this._opts),h.call(this,"_id",this._opts),h.call(this,"field",this._opts),h.call(this,"type",this._opts),h.call(this,"index",this._opts),h.call(this,"added",this._opts),h.call(this,"addedId",this._opts),h.call(this,"removed",this._opts),h.call(this,"removedId",this._opts),h.call(this,"new",this._opts),h.call(this,"newId",this._opts),h.call(this,"old",this._opts),h.call(this,"oldId",this._opts),h.call(this,"obj",this._opts)}function e(a,b,c){m.trace.isEnabled&&m.trace('Sending notification "'+a+'" of type '+c.type),i.emit(a,c);var d=a+":"+b;m.trace.isEnabled&&m.trace('Sending notification "'+d+'" of type '+c.type),i.emit(d,c);var e="Siesta";m.trace.isEnabled&&m.trace('Sending notification "'+e+'" of type '+c.type),i.emit(e,c);var f=c._id;m.trace.isEnabled&&m.trace('Sending notification "'+f+'" of type '+c.type),i.emit(f,c);var g,h=l[a];if(!h)throw g='No such collection "'+a+'"',m.error(g,l),new j(g);var k=h[b];if(!k)throw g='No such mapping "'+b+'"',m.error(g,l),new j(g);if(k.id&&c.obj[k.id]){var n=a+":"+b+":"+c.obj[k.id];m.trace.isEnabled&&m.trace('Sending notification "'+n+'" of type '+c.type),i.emit(n,c)}}function f(a){if(!a.mapping)throw new j("Must pass a mapping");if(!a.collection)throw new j("Must pass a collection");if(!a._id)throw new j("Must pass a local identifier");if(!a.obj)throw new j("Must pass the object")}function g(a){f(a);var b=a.collection,c=a.mapping,g=new d(a);return e(b,c,g),g}var h=a("./util").defineSubProperty,i=a("./notificationCentre").notificationCentre,j=a("./error").InternalSiestaError,k=a("./operation/log"),l=a("./collectionRegistry").CollectionRegistry,m=k.loggerWithName("changes");m.setLevel(k.Level.warn);var n={Set:"Set",Splice:"Splice",Delete:"Delete",New:"New",Remove:"Remove"};d.prototype._dump=function(a){var b={};return b.collection="string"==typeof this.collection?this.collection:this.collection._dump(),b.mapping="string"==typeof this.mapping?this.mapping:this.mapping.type,b._id=this._id,b.field=this.field,b.type=this.type,this.index&&(b.index=this.index),this.added&&(b.added=_.map(this.added,function(a){return a._dump()})),this.removed&&(b.removed=_.map(this.removed,function(a){return a._dump()})),this.old&&(b.old=this.old),this.new&&(b.new=this.new),a?JSON.stringify(b,null,4):b},c.Change=d,c.registerChange=g,c.validateChange=f,c.ChangeType=n},{"./collectionRegistry":4,"./error":5,"./notificationCentre":10,"./operation/log":13,"./util":21}],3:[function(a,b,c){function d(a){var b=this;if(!a)throw new Error("Collection must have a name");this._name=a,this._docId="Collection_"+this._name,this._rawMappings={},this._mappings={},this.baseURL="",this.installed=!1,g.register(this),Object.defineProperty(this,"name",{get:function(){return b._name}})}var e=a("./operation/log"),f=e.loggerWithName("Collection");f.setLevel(e.Level.warn);var g=a("./collectionRegistry").CollectionRegistry,h=a("./operation/operation").Operation,i=a("./error").InternalSiestaError,j=a("./mapping").Mapping,k=a("extend"),l=(a("../vendor/observe-js/src/observe").Platform,a("./util")),m=l._,n=(a("./cache"),["PUT","PATCH","POST","DELETE"]);m.extend(d.prototype,{install:function(a){var b=window.q?window.q.defer():null,c=this;if(this.installed){var d=new i('Collection "'+this._name+'" has already been installed');c._finaliseInstallation(d,a)}else{var e=[];for(var g in this._mappings)if(this._mappings.hasOwnProperty(g)){var j=this._mappings[g];e.push(j)}if(f.info.isEnabled&&f.info("There are "+e.length.toString()+" mappings to install"),e.length){var k=m.map(e,function(a){return new h("Install Mapping",m.bind(a.install,a))}),l=new h("Install Mappings",k);l.completion=function(){if(l.failed)f.error("Failed to install collection",l.error),c._finaliseInstallation(l.error,a);else{c.installed=!0;var b=[];m.each(e,function(a){f.info.isEnabled&&f.info('Installing relationships for mapping with name "'+a.type+'"');var c=a.installRelationships();c&&b.push(c)}),b.length||m.each(e,function(a){f.info.isEnabled&&f.info('Installing reverse relationships for mapping with name "'+a.type+'"');var c=a.installReverseRelationships();c&&b.push(c)});var d;1==b.length?d=b[0]:b.length&&(d=b),c._finaliseInstallation(d,a)}},l.start()}else c._finaliseInstallation(null,a)}return b?b.promise:null},_finaliseInstallation:function(b,c){if(!b){this.installed=!0;var d=a("./index");d[this._name]=this}c&&c(b)},_mapping:function(a,b){if(a){this._rawMappings[a]=b,b=k(!0,{},b),b.type=a,b.collection=this._name;var c=new j(b);return this._mappings[a]=c,this[a]=c,c}throw new Error("No name specified when creating mapping")},mapping:function(){var a=this;return arguments.length?1==arguments.length?l.isArray(arguments[0])?m.map(arguments[0],function(b){return a._mapping(b.name,b)}):this._mapping(arguments[0].name,arguments[0]):"string"==typeof arguments[0]?this._mapping(arguments[0],arguments[1]):m.map(arguments,function(b){return a._mapping(b.name,b)}):null},descriptor:function(a){var b=[];if(!siesta.ext.httpEnabled)throw new Error("HTTP module not installed.");a.collection=this;for(var c=siesta.ext.http._resolveMethod(a.method),d=[],e=[],f=0;f<c.length;f++){var g=c[f];n.indexOf(g)>-1?d.push(g):e.push(g)}if(d.length){var h=k({},a);h.method=d,h=new siesta.ext.http.RequestDescriptor(h),siesta.ext.http.DescriptorRegistry.registerRequestDescriptor(h),b.push(h)}if(e.length){var i=k({},a);i.method=e,i=new siesta.ext.http.ResponseDescriptor(i),siesta.ext.http.DescriptorRegistry.registerResponseDescriptor(i),b.push(i)}return b},_dump:function(a){var b={};return b.installed=this.installed,b.docId=this._docId,b.name=this._name,b.baseURL=this.baseURL,a?JSON.stringify(b,null,4):b},_http:function(a){if(!siesta.ext.httpEnabled)throw new Error("HTTP module not installed.");var b=Array.prototype.slice.call(arguments,1);b.unshift(this);var c=siesta.ext.http[a];c.apply(c,b)},GET:function(){return m.partial(this._http,"GET").apply(this,arguments)},OPTIONS:function(){return m.partial(this._http,"OPTIONS").apply(this,arguments)},TRACE:function(){return m.partial(this._http,"TRACE").apply(this,arguments)},HEAD:function(){return m.partial(this._http,"HEAD").apply(this,arguments)},POST:function(){return m.partial(this._http,"POST").apply(this,arguments)},PUT:function(){m.partial(this._http,"PUT").apply(this,arguments)},PATCH:function(){return m.partial(this._http,"PATCH").apply(this,arguments)},DELETE:function(){return m.partial(this._http,"DELETE").apply(this,arguments)},count:function(a){var b=window.q?window.q.defer():null;a=l.constructCallbackAndPromiseHandler(a,b);var c=m.map(this._mappings,function(a){return m.bind(a.count,a)});return l.parallel(c,function(b,c){var d;b||(d=m.reduce(c,function(a,b){return a+b},0)),a(b,d)}),b?b.promise:null}}),c.Collection=d},{"../vendor/observe-js/src/observe":24,"./cache":1,"./collectionRegistry":4,"./error":5,"./index":6,"./mapping":8,"./operation/log":13,"./operation/operation":14,"./util":21,extend:23}],4:[function(a,b,c){function d(){return this?void(this.collectionNames=[]):new d}var e=a("./util")._;e.extend(d.prototype,{register:function(a){var b=a._name;this[b]=a,this.collectionNames.push(b)},reset:function(){var a=this;e.each(this.collectionNames,function(b){delete a[b]}),this.collectionNames=[]}}),c.CollectionRegistry=new d},{"./util":21}],5:[function(a,b){function c(a,b,c){this.message=a,this.context=b,c=c||arguments.callee,c&&Error.captureStackTrace&&Error.captureStackTrace(this,c)}c.prototype=Object.create(Error.prototype),c.prototype.name="InternalSiestaError",c.prototype.constructor=c;var d={Message:"message",Code:"code"},e={Unknown:0,NoDescriptorMatched:1},f={};f[e.NoDescriptorMatched]="No descriptor matched the HTTP response/request.",b.exports={InternalSiestaError:c,ErrorCode:e,ErrorField:d,Message:f}},{}],6:[function(a,b){var c=a("./collection"),d=a("./util"),e=a("./collectionRegistry").CollectionRegistry,f=c.Collection,g=a("./cache"),h=a("./mapping").Mapping,i=a("./notificationCentre").notificationCentre,j=a("./operation/operation").Operation,k=a("./operation/queue").OperationQueue,l=a("./relationship").RelationshipType,m=a("./operation/log"),n=d._;window.Q&&(window.q=window.Q),j.logLevel=m.Level.warn,k.logLevel=m.Level.warn;var o=function(a){return o.ext||(o.ext={}),n.extend(o.ext,a||{}),o};o.reset=function(){g.reset(),e.reset(),o.ext.http.DescriptorRegistry.reset()},o.on=n.bind(i.on,i),o.addListener=o.on,o.off=n.bind(i.removeListener,i),o.removeListener=o.off,o.once=n.bind(i.once,i),o.removeAllListeners=n.bind(i.removeAllListeners,i),o.Collection=f,o.RelationshipType=l;var p=a("./changes");o._internal={log:m,Mapping:h,mapping:a("./mapping"),error:a("./error"),ChangeType:p.ChangeType,siestaModel:a("./siestaModel"),extend:a("extend"),notificationCentre:a("./notificationCentre"),cache:a("./cache"),Operation:j,OperationQueue:k,coreChanges:p,CollectionRegistry:a("./collectionRegistry").CollectionRegistry,Collection:c.Collection,collection:c,utils:d,util:d,_:d._,query:a("./query"),store:a("./store")},o.Collection=c.Collection,o.performanceMonitoringEnabled=!1,o.httpEnabled=!1,o.storageEnabled=!1,o.ext={},Object.defineProperty(o.ext,"httpEnabled",{get:function(){return void 0!==o.ext._httpEnabled?o.ext._httpEnabled:!!o.ext.http},set:function(a){o.ext._httpEnabled=a}}),o.collection=function(a,b){return new f(a,b)},o.setAjax=function(a){if(!o.ext.httpEnabled)throw new Error("http module not installed correctly (have you included siesta.http.js?)");o.ext.http.ajax=a},o.getAjax=function(){return o.ext.http.ajax},o.notify=d.next,o.LogLevel=m.Level,o.setLogLevel=function(a,b){var c=m.loggerWithName(a);c.setLevel(b)},o.serialisers={},o.serializers=o.serialisers,Object.defineProperty(o.serialisers,"id",{get:function(){return o.ext.httpEnabled?o.ext.http.Serialiser.idSerialiser:null}}),Object.defineProperty(o.serialisers,"depth",{get:function(){return o.ext.httpEnabled?o.ext.http.Serialiser.depthSerializer:null}}),o.map=d._.map,o.each=d._.each,o.partial=d._.partial,o.bind=d._.bind,o.pluck=d._.pluck,o.property=d._.pluck,o.sortBy=d._.sortBy,o.series=d.series,o.parallel=d.parallel,"undefined"!=typeof window&&(window.siesta=o),b.exports=o},{"./cache":1,"./changes":2,"./collection":3,"./collectionRegistry":4,"./error":5,"./mapping":8,"./notificationCentre":10,"./operation/log":13,"./operation/operation":14,"./operation/queue":15,"./query":17,"./relationship":18,"./siestaModel":19,"./store":20,"./util":21,extend:23}],7:[function(a,b){function c(a){e.call(this,a);var b=this;Object.defineProperty(this,"isFault",{get:function(){return b._id?!b.related:!0},set:function(a){a?(b._id=void 0,b.related=null):b._id||(b._id=[],b.related=[],b.wrapArray(b.related))}}),this._reverseIsArray=!0}var d=a("./proxy"),e=d.RelationshipProxy,f=a("./store"),g=a("./util"),h=g._,i=(a("./error").InternalSiestaError,a("./changes")),j=a("./notificationCentre"),k=j.wrapArray,l=(a("./siestaModel").SiestaModel,a("../vendor/observe-js/src/observe").ArrayObserver),m=a("./changes").ChangeType;c.prototype=Object.create(e.prototype),h.extend(c.prototype,{clearReverse:function(a){var b=this;h.each(a,function(a){var c=d.getReverseProxyForObject.call(b,a),e=c._id.indexOf(b.object._id);d.makeChangesToRelatedWithoutObservations.call(c,function(){d.splice.call(c,e,1)})})},setReverse:function(a){var b=this;h.each(a,function(a){var c=d.getReverseProxyForObject.call(b,a);d.makeChangesToRelatedWithoutObservations.call(c,function(){d.splice.call(c,0,0,b.object)})})},wrapArray:function(a){var b=this;if(k(a,this.reverseName,this.object),!a.oneToManyObserver){a.oneToManyObserver=new l(a);var c=function(c){c.forEach(function(c){var e=c.addedCount?a.slice(c.index,c.index+c.addedCount):[],f=c.removed;b.clearReverse(f),b.setReverse(e);var g=d.getForwardMapping.call(b);i.registerChange({collection:g.collection,mapping:g.type,_id:b.object._id,field:d.getForwardName.call(b),removed:f,added:e,removedId:h.pluck(f,"_id"),addedId:h.pluck(e,"_id"),type:m.Splice,index:c.index,obj:b.object})})};a.oneToManyObserver.open(c)}},get:function(a){var b=window.q?window.q.defer():null;a=g.constructCallbackAndPromiseHandler(a,b);var c=this;return this.isFault?f.get({_id:this._id},function(b,d){b?a&&a(b):(c.related=d,a&&a(null,d))}):a&&a(null,this.related),b?b.promise:null},validate:function(a){return"[object Array]"!=Object.prototype.toString.call(a)?"Cannot assign scalar to many to many":null},set:function(a){d.checkInstalled.call(this);var b=this;if(a){var c;if(c=this.validate(a))return c;d.clearReverseRelated.call(this),d.set.call(b,a),this.wrapArray(a),d.setReverse.call(b,a)}else d.clearReverseRelated.call(this),d.set.call(b,a)},install:function(a){e.prototype.install.call(this,a),a["splice"+g.capitaliseFirstLetter(this.reverseName)]=h.bind(d.splice,this)}}),b.exports=c},{"../vendor/observe-js/src/observe":24,"./changes":2,"./error":5,"./notificationCentre":10,"./proxy":16,"./siestaModel":19,"./store":20,"./util":21}],8:[function(a,b,c){function d(a){var b=this;this._opts=a,Object.defineProperty(this,"_fields",{get:function(){var a=[];return b.id&&a.push(b.id),b._opts.attributes&&u.each(b._opts.attributes,function(b){a.push(b)}),a},enumerable:!0,configurable:!0}),m.call(this,"type",b._opts),Object.defineProperty(this,"id",{get:function(){return b._opts.id||"id"},set:function(a){b._opts.id=a},enumerable:!0}),m.call(this,"collection",b._opts),m.call(this,"attributes",b._opts),m.call(this,"relationships",b._opts),m.call(this,"indexes",b._opts),m.call(this,"subclass",b._opts),m.call(this,"singleton",b._opts),this.relationships||(this.relationships=[]),this.indexes||(this.indexes=[]),this._validateSubclass(),this._installed=!1,this._relationshipsInstalled=!1,this._reverseRelationshipsInstalled=!1,Object.defineProperty(this,"installed",{get:function(){return b._installed&&b._relationshipsInstalled&&b._reverseRelationshipsInstalled},enumerable:!0,configurable:!0})}var e=a("./operation/log"),f=a("./collectionRegistry").CollectionRegistry,g=a("./error").InternalSiestaError,h=a("./relationship"),i=a("./query").Query,j=(a("./operation/operation").Operation,a("./mappingOperation").BulkMappingOperation),k=a("./siestaModel").SiestaModel,l=a("./util"),m=l.defineSubProperty,n=a("./cache"),o=(a("./store"),a("extend")),p=a("./changes"),q=a("./notificationCentre").wrapArray,r=a("./oneToManyProxy"),s=a("./oneToOneProxy"),t=a("./manyToManyProxy"),u=l._,v=h.RelationshipType,w=l.guid,x=p.ChangeType,y=e.loggerWithName("Mapping");y.setLevel(e.Level.warn),u.extend(d.prototype,{_validateSubclass:function(){if(this.subclass&&this.subclass!==k){var a=new this.subclass(this);if(!a.mapping)throw new g('Subclass for mapping "'+this.type+'" has not been configured correctly. Did you call super?');if(this.subclass.prototype==k.prototype)throw new g('Subclass for mapping "'+this.type+'" has not been configured correctly. You should use Object.create on SiestaModel prototype.')}},installRelationships:function(){if(this._relationshipsInstalled)throw new g('Relationships for "'+this.type+'" have already been installed');var a=this;if(a._relationships=[],a._opts.relationships)for(var b in a._opts.relationships)if(y.debug.isEnabled&&y.debug(a.type+": configuring relationship "+b),a._opts.relationships.hasOwnProperty(b)){var c=a._opts.relationships[b];if(c.type!=v.OneToMany&&c.type!=v.OneToOne&&c.type!=v.ManyToMany)return"Relationship type "+c.type+" does not exist";var d=c.mapping;if(y.debug.isEnabled&&y.debug("reverseMappingName",d),!a.collection)throw new g("Mapping must have collection");var e=f[a.collection];if(!e)throw new g("Collection "+a.collection+" not registered");var h=e[d];if(!h){var i=d.split(".");if(2==i.length){var j=i[0];d=i[1];var k=f[j];if(!k)return'Collection with name "'+j+'" does not exist.';h=k[d]}}if(y.debug.isEnabled&&y.debug("reverseMapping",h),!h)return'Mapping with name "'+d.toString()+'" does not exist';c.reverseMapping=h,c.forwardMapping=this,c.forwardName=b,c.reverseName=c.reverse,c.isReverse=!1}return this._relationshipsInstalled=!0,null},installReverseRelationships:function(){if(this._reverseRelationshipsInstalled)throw new g('Reverse relationships for "'+this.type+'" have already been installed.');for(var a in this.relationships)if(this.relationships.hasOwnProperty(a)){var b=this.relationships[a];b=o(!0,{},b),b.isReverse=!0;var c=b.reverseMapping,d=b.reverseName;y.debug.isEnabled&&y.debug(self.type+": configuring  reverse relationship "+name),c.relationships[d]=b}this._reverseRelationshipsInstalled=!0},query:function(a,b){var c=window.q?window.q.defer():null;b=l.constructCallbackAndPromiseHandler(b,c);var d=new i(this,a);return d.execute(b),c?c.promise:null},get:function(a,b){function c(a,c){b&&b(a,c)}var d=window.q?window.q.defer():null;if(b=l.constructCallbackAndPromiseHandler(b,d),this.singleton)"function"==typeof a&&(b=a),this.all(function(a,b){if(a&&c(a),b.length>1)throw new g("Somehow more than one object has been created for a singleton mapping! This is a serious error, please file a bug report.");b.length?c(null,b[0]):c(null,b[0])});else{var e={};e[this.id]=a,e.mapping=this;var f=n.get(e);if(f)c(null,f);else{delete e.mapping;var h=new i(this,e);h.execute(function(b,d){var e=null;if(!b&&d.length){if(d.length>1)throw new g("More than one object with id="+a.toString());e=d[0]}c(b,e)})}}return d?d.promise:null},all:function(a){var b=window.q?window.q.defer():null;a=l.constructCallbackAndPromiseHandler(a,b);var c=new i(this,{});return c.execute(a),b?b.promise:null},install:function(a){y.info.isEnabled&&y.info("Installing mapping "+this.type);var b=window.q?window.q.defer():null;if(a=l.constructCallbackAndPromiseHandler(a,b),this._installed)throw new g('Mapping "'+this.type+'" has already been installed');var c=this._validate();return this._installed=!0,y.info.isEnabled&&(c.length?y.error("Errors installing mapping "+this.type+": "+c):y.info("Installed mapping "+this.type)),a&&a(c.length?c:null),b?b.promise:null},_validate:function(){var a=[];return this.type||a.push("Must specify a type"),this.collection||a.push("A mapping must belong to an collection"),a},map:function(a,b,c){var d=window.q?window.q.defer():null;if(b=l.constructCallbackAndPromiseHandler(b,d),!this.installed)throw new g("Mapping must be fully installed before creating any models");return l.isArray(a)?this._mapBulk(a,b,c):this._mapBulk([a],function(a,c){if(b){var d;c&&c.length&&(d=c[0]),b(a?a[0]:null,d)}},c?[c]:void 0),d?d.promise:null},_mapBulk:function(a,b,c){var d=window.q?window.q.defer():null;b=l.constructCallbackAndPromiseHandler(b,d);var e={mapping:this,data:a};c&&(e.objects=c);var f=new j(e);return f.onCompletion(function(){var a=f.error;if(a)b&&b(a);else{var c=f.result;b(null,c)}}),f.start(),d?d.promise:null},_countCache:function(){var a=n._localCacheByType[this.collection]||{},b=a[this.type]||{};return u.reduce(Object.keys(b),function(a,b){return a[b]={},a},{})},count:function(a){var b=window.q?window.q.defer():null;a=l.constructCallbackAndPromiseHandler(a,b);var c=this._countCache();if(siesta.ext.storageEnabled){var d=siesta.ext.storage.Pouch.getPouch(),e=new siesta.ext.storage.Index(this.collection,this.type)._getName()+"_";d.query(e,{include_docs:!1},function(b,d){var e;b||(u.each(u.pluck(d.rows,"id"),function(a){c[a]={}}),e=Object.keys(c).length),a(b,e)})}else a(null,Object.keys(c).length);return b?b.promise:null},_new:function(a){if(this.installed){var b,c=this;b=a&&a._id?a._id:w();var d;d=this.subclass?new this.subclass(this):new k(this),y.info.isEnabled&&y.info('New object created _id="'+b.toString()+'", type='+this.type,a),d._id=b,d.__values=a||{};var e=this._fields,f=e.indexOf(this.id);f>-1&&e.splice(f,1),u.each(e,function(a){Object.defineProperty(d,a,{get:function(){return d.__values[a]||null},set:function(b){var e=d.__values[a];d.__values[a]=b,p.registerChange({collection:c.collection,mapping:c.type,_id:d._id,"new":b,old:e,type:x.Set,field:a,obj:d}),l.isArray(b)&&q(b,a,d)},enumerable:!0,configurable:!0})}),Object.defineProperty(d,this.id,{get:function(){return d.__values[c.id]||null},set:function(a){var b=d[c.id];d.__values[c.id]=a,p.registerChange({collection:c.collection,mapping:c.type,_id:d._id,"new":a,old:b,type:x.Set,field:c.id,obj:d}),n.remoteInsert(d,a,b)},enumerable:!0,configurable:!0});for(var h in this.relationships){var i;if(this.relationships.hasOwnProperty(h)){var j=this.relationships[h];if(j.type==v.OneToMany)i=new r(j);else if(j.type==v.OneToOne)i=new s(j);else{if(j.type!=v.ManyToMany)throw new g("No such relationship type: "+j.type);i=new t(j)}}i.install(d),i.isFault=!1}return n.insert(d),p.registerChange({collection:this.collection,mapping:this.type,_id:d._id,newId:d._id,"new":d,type:x.New,obj:d}),d}throw l.printStackTrace(),new g("Mapping must be fully installed before creating any models")},_dump:function(a){var b={};return b.name=this.type,b.attributes=this.attributes,b.id=this.id,b.collection=this.collection,b.relationships=u.map(this.relationships,function(a){return a.isForward?a.forwardName:a.reverseName}),a?JSON.stringify(b,null,4):b},toString:function(){return"Mapping["+this.type+"]"}}),c.Mapping=d},{"./cache":1,"./changes":2,"./collectionRegistry":4,"./error":5,"./manyToManyProxy":7,"./mappingOperation":9,"./notificationCentre":10,"./oneToManyProxy":11,"./oneToOneProxy":12,"./operation/log":13,"./operation/operation":14,"./query":17,"./relationship":18,"./siestaModel":19,"./store":20,"./util":21,extend:23}],9:[function(a,b,c){function d(a){return o.reduce(a,function(a,b){return n.isArray(b)?a=a.concat(b):a.push(b),a},[])}function e(a,b){for(var c=0,d=[],e=0;e<b.length;e++)if(n.isArray(b[e])){var f=[];d[e]=f;for(var g=0;g<b[e].length;g++)f.push(a[c]),c++}else d[e]=a[c],c++;return d}function f(a){j.call(this),this._opts=a,p.call(this,"mapping",this._opts),p.call(this,"data",this._opts),p.call(this,"objects",this._opts),this.objects||(this.objects=[]),this.errors=[],this.name="Mapping Operation",this.work=o.bind(this._start,this),this.subOps={}}var g=a("./store"),h=a("./siestaModel").SiestaModel,i=a("./operation/log"),j=a("./operation/operation").Operation,k=a("./error").InternalSiestaError,l=a("./query").Query,m=a("./cache"),n=a("./util"),o=n._,p=n.defineSubProperty,q=(a("./changes").ChangeType,i.loggerWithName("MappingOperation"));q.setLevel(i.Level.warn),f.prototype=Object.create(j.prototype),o.extend(f.prototype,{mapAttributes:function(){for(var a=0;a<this.data.length;a++){var b=this.data[a],c=this.objects[a];if(b!=c&&c){var d=this.mapping._fields;o.each(d,function(a){void 0!==b[a]&&(c[a]=b[a])})}}},_map:function(){var a,b=this,c=(this.mapAttributes(this),o.keys(b.subOps));o.each(c,function(c){for(var d=b.subOps[c].op,f=b.subOps[c].indexes,g=b.getRelatedData(c).relatedData,h=e(d.objects,g),i=0;i<h.length;i++){var j=f[i],k=b.errors[j];if(a=k?k[c]:null,!a){var l=h[i],m=b.objects[j];m&&(a=m.__proxies[c].set(l),a&&(b.errors[j]||(b.errors[j]={}),b.errors[j][c]=a))}}})},_lookup:function(a){var b=window.q?window.q.defer():null;a=n.constructCallbackAndPromiseHandler(a,b);for(var c=this,d=[],e=[],f=0;f<this.data.length;f++)if(!this.objects[f]){var i,j=this.data[f],k="string"==typeof j||"number"==typeof j||j instanceof String;if(j)if(k)i={index:f,datum:{}},i.datum[c.mapping.id]=j,d.push(i);else if(j instanceof h)this.objects[f]=j;else if(j._id)e.push({index:f,datum:j});else if(j[c.mapping.id])d.push({index:f,datum:j});else{for(var l=Object.keys(j),p=o.reduce(Object.keys(c.mapping.relationships).concat(c.mapping._fields),function(a,b){return a[b]={},a},{}),r=!1,s=0;s<l.length;s++)if(p[l[s]]){r=!0;break}r&&(this.objects[f]=c.mapping._new())}else this.objects[f]=null}return n.parallel([function(a){var b=o.pluck(o.pluck(e,"datum"),"_id");b.length?g.getMultipleLocal(b,function(d,f){if(!d)for(var g=0;g<b.length;g++){var h=f[g],i=b[g],j=e[g];h?c.objects[j.index]=h:c.errors[j.index]={_id:'No object with _id="'+i.toString()+'"'}}a(d)}):a()},function(a){var b=o.pluck(o.pluck(d,"datum"),c.mapping.id);b.length?(q.trace.isEnabled&&q.trace("Looking up remoteIdentifiers: "+JSON.stringify(b,null,4)),g.getMultipleRemote(b,c.mapping,function(e,g){if(!e){if(q.trace.isEnabled){var h={};for(f=0;f<g.length;f++)h[b[f]]=g[f]?g[f]._id:null;q.trace("Results for remoteIdentifiers: "+JSON.stringify(h,null,4))}for(f=0;f<g.length;f++){var i=g[f],j=d[f];if(i)c.objects[j.index]=i;else{var k={},l=b[f];k[c.mapping.id]=l;var n={mapping:c.mapping};n[c.mapping.id]=l;var o=m.get(n);o?c.objects[j.index]=o:(c.objects[j.index]=c.mapping._new(),c.objects[j.index][c.mapping.id]=l)}}}a(e)})):a()}],a),b?b.promise:null},_lookupSingleton:function(a){var b=window.q?window.q.defer():null;a=n.constructCallbackAndPromiseHandler(a,b);var c=this,d=m.get({mapping:this.mapping});if(d){for(var e=0;e<c.data.length;e++)c.objects[e]=d;a()}else{var f=new l(this.mapping);f.execute(function(b,d){if(!b){var e;if(d.length){if(1!=d.length)throw new k;e=d[0]}else e=c.mapping._new();for(var f=0;f<c.data.length;f++)c.objects[f]=e}a(b)})}return b?b.promise:null},_start:function(a){if(this.data.length){var b=this,c=[],d=this.mapping.singleton?this._lookupSingleton:this._lookup;c.push(o.bind(d,this)),c.push(o.bind(this._executeSubOperations,this)),n.parallel(c,function(){b._map(),a(b.errors.length?b.errors:null,b.objects)})}else a(null,[])},getRelatedData:function(a){for(var b=[],c=[],d=0;d<this.data.length;d++){var e=this.data[d];e&&e[a]&&(b.push(d),c.push(e[a]))}return{indexes:b,relatedData:c}},_constructSubOperations:function(){var a=this.subOps,b=this.mapping.relationships;for(var c in b)if(b.hasOwnProperty(c)){var e=b[c],g=e.forwardName==c?e.reverseMapping:e.forwardMapping,h=this.getRelatedData(c),i=h.indexes,j=h.relatedData;if(j.length){var k=d(j),l=new f({mapping:g,data:k});l.__relationshipName=c,a[c]={op:l,indexes:i}}}},gatherErrorsFromSubOperations:function(){var a=this,b=o.keys(this.subOps);o.each(b,function(b){var c=a.subOps[b].op,d=a.subOps[b].indexes,f=c.errors;if(f.length)for(var g=a.getRelatedData(b).relatedData,h=e(f,g),i=0;i<h.length;i++){var j=d[i],k=h[i],l=k;n.isArray(k)&&(l=o.reduce(k,function(a,b){return a||b},!1)),l&&(a.errors[j]||(a.errors[j]={}),a.errors[j][b]=k)}})},_executeSubOperations:function(a){var b=this;this._constructSubOperations();var c=o.keys(this.subOps);if(c.length){var d=o.map(c,function(a){return b.subOps[a].op}),e=new j(d);e.onCompletion(function(){b.gatherErrorsFromSubOperations(c),a()}),e.start()}else a()}}),c.BulkMappingOperation=f,c.flattenArray=d,c.unflattenArray=e},{"./cache":1,"./changes":2,"./error":5,"./operation/log":13,"./operation/operation":14,"./query":17,"./siestaModel":19,"./store":20,"./util":21}],10:[function(a,b,c){function d(a,b,c){a.observer||(a.observer=new g(a),a.observer.open(function(d){var e=c._fields.indexOf(b)>-1;e&&d.forEach(function(d){h.registerChange({collection:c.collection,mapping:c.mapping.type,_id:c._id,index:d.index,removed:d.removed,added:d.addedCount?a.slice(d.index,d.index+d.addedCount):[],type:h.ChangeType.Splice,field:b,obj:c})})}),a.isFault=!1)}var e=a("events").EventEmitter,f=new e;f.setMaxListeners(100);{var g=a("../vendor/observe-js/src/observe").ArrayObserver,h=a("./changes");h.ChangeType,a("./operation/log")}c.notificationCentre=f,c.wrapArray=d},{"../vendor/observe-js/src/observe":24,"./changes":2,"./operation/log":13,events:22}],11:[function(a,b){function c(a){e.call(this,a);var b=this;Object.defineProperty(this,"isFault",{get:function(){return b.isForward?b._id?!b.related:null===b._id?!1:!0:b._id&&b.related?b._id.length!=b.related.length?(b.validateRelated(),!0):!1:!0
},set:function(a){a?(b._id=void 0,b.related=null):b._id||(b.isForward?b._id=null:(b._id=[],b.related=[],this.wrapArray(b.related)))}}),this._reverseIsArray=!0,this._forwardIsArray=!1}var d=a("./proxy"),e=d.RelationshipProxy,f=a("./store"),g=a("./util"),h=g._,i=a("./error").InternalSiestaError,j=a("./changes"),k=(a("./siestaModel").SiestaModel,a("./notificationCentre")),l=k.wrapArray,m=a("../vendor/observe-js/src/observe").ArrayObserver,n=a("./changes").ChangeType;c.prototype=Object.create(e.prototype),h.extend(c.prototype,{clearReverse:function(a){var b=this;h.each(a,function(a){var c=d.getReverseProxyForObject.call(b,a);d.set.call(c,null)})},setReverse:function(a){var b=this;h.each(a,function(a){var c=d.getReverseProxyForObject.call(b,a);d.set.call(c,b.object)})},wrapArray:function(a){var b=this;if(l(a,this.reverseName,this.object),!a.oneToManyObserver){a.oneToManyObserver=new m(a);var c=function(c){c.forEach(function(c){var e=c.addedCount?a.slice(c.index,c.index+c.addedCount):[],f=c.removed;b.clearReverse(f),b.setReverse(e);var g=d.getForwardMapping.call(b);j.registerChange({collection:g.collection,mapping:g.type,_id:b.object._id,field:d.getForwardName.call(b),removed:f,added:e,removedId:h.pluck(f,"_id"),addedId:h.pluck(e,"_id"),type:n.Splice,index:c.index,obj:b.object})})};a.oneToManyObserver.open(c)}},get:function(a){var b=window.q?window.q.defer():null;a=g.constructCallbackAndPromiseHandler(a,b);var c=this;if(this.isFault)if(this._id.length){var d={_id:this._id};f.get(d,function(b,d){b?a&&a(b):(c.related=d,a&&a(null,d))})}else a&&a(null,this.related);else a&&a(null,this.related);return b?b.promise:null},validate:function(a){var b=Object.prototype.toString.call(a);if(this.isForward){if("[object Array]"==b)return"Cannot assign array forward oneToMany ("+b+"): "+this.forwardName}else if("[object Array]"!=b)return"Cannot scalar to reverse oneToMany ("+b+"): "+this.reverseName;return null},validateRelated:function(){var a=this;if(a._id&&a.related&&a._id.length!=a.related.length&&a.related.length>0)throw new i("_id and related are somehow out of sync")},set:function(a){d.checkInstalled.call(this);var b=this;if(a){var c;if(c=this.validate(a))return c;d.clearReverseRelated.call(this),d.set.call(b,a),b.isReverse&&this.wrapArray(b.related),d.setReverse.call(b,a)}else d.clearReverseRelated.call(this),d.set.call(b,a)},install:function(a){e.prototype.install.call(this,a),this.isReverse&&(a["splice"+g.capitaliseFirstLetter(this.reverseName)]=h.bind(d.splice,this))}}),b.exports=c},{"../vendor/observe-js/src/observe":24,"./changes":2,"./error":5,"./notificationCentre":10,"./proxy":16,"./siestaModel":19,"./store":20,"./util":21}],12:[function(a,b){function c(a){e.call(this,a),this._reverseIsArray=!1,this._forwardIsArray=!1}{var d=a("./proxy"),e=d.RelationshipProxy,f=a("./store"),g=a("./util");a("./error").InternalSiestaError,a("./siestaModel").SiestaModel}c.prototype=Object.create(e.prototype),_.extend(c.prototype,{validate:function(a){return"[object Array]"==Object.prototype.toString.call(a)?"Cannot assign array to one to one relationship":null},set:function(a){d.checkInstalled.call(this);var b=this;if(a){var c;if(c=b.validate(a))return c;d.clearReverseRelated.call(this),d.set.call(b,a),d.setReverse.call(b,a)}else d.clearReverseRelated.call(this),d.set.call(b,a)},get:function(a){var b=window.q?window.q.defer():null;a=g.constructCallbackAndPromiseHandler(a,b);var c=this;return this._id&&f.get({_id:this._id},function(b,d){b?a&&a(b):(c.related=d,a&&a(null,d))}),b?b.promise:null}}),b.exports=c},{"./error":5,"./proxy":16,"./siestaModel":19,"./store":20,"./util":21}],13:[function(a,b){function c(a){return this?(this.name=a,this.trace=d(this,e.bind(console.debug?console.debug:console.log,console),c.Level.trace),this.debug=d(this,e.bind(console.debug?console.debug:console.log,console),c.Level.debug),this.info=d(this,e.bind(console.info?console.info:console.log,console),c.Level.info),this.log=d(this,e.bind(console.log?console.log:console.log,console),c.Level.info),this.warn=d(this,e.bind(console.warn?console.warn:console.log,console),c.Level.warning),this.error=d(this,e.bind(console.error?console.error:console.log,console),c.Level.error),void(this.fatal=d(this,e.bind(console.error?console.error:console.log,console),c.Level.fatal))):new c(a)}function d(a,b,c){var d=function(d){a.performLog(b,c,d,arguments)};return Object.defineProperty(d,"isEnabled",{get:function(){var b=a.currentLevel();return c>=b},enumerable:!0,configurable:!0}),d.f=b,d.logger=a,d.level=c,d}var e=a("../util")._,f={};c.Level={trace:0,debug:1,info:2,warning:3,warn:3,error:4,fatal:5},c.LevelText={},c.LevelText[c.Level.trace]="TRACE",c.LevelText[c.Level.debug]="DEBUG",c.LevelText[c.Level.info]="INFO ",c.LevelText[c.Level.warning]="WARN ",c.LevelText[c.Level.error]="ERROR",c.levelAsText=function(a){return this.LevelText[a]},c.loggerWithName=function(a){return new c(a)},c.prototype.currentLevel=function(){var a=f[this.name];return a?a:c.Level.trace},c.prototype.setLevel=function(a){f[this.name]=a},c.prototype.override=function(a,b,d){var e=c.levelAsText(a),f=this[e.trim().toLowerCase()],g=f.f,h=Array.prototype.slice.call(arguments,3,arguments.length);this.performLog(g,a,d,h,b)},c.prototype.performLog=function(a,b,d,f,g){var h=this,i=void 0!==g?g:this.currentLevel();if(b>=i){a=e.partial(a,c.levelAsText(b)+" ["+h.name+"]: "+d);for(var j=[],k=0;k<f.length;k++)j[k]=f[k];j.splice(0,1),a.apply(a,j)}},b.exports=c},{"../util":21}],14:[function(a,b){function c(){if(!this)return new(Function.prototype.bind.apply(c,arguments));var a=this;arguments.length&&("string"==typeof arguments[0]?(this.name=arguments[0],this.work=arguments[1],this.completion=arguments[2]):("function"==typeof arguments[0]||"[object Array]"===Object.prototype.toString.call(arguments[0])||arguments[0]instanceof c)&&(this.work=arguments[0],this.completion=arguments[1])),this.error=null,this.completed=!1,this.result=null,this.running=!1,this.cancelled=!1,this.dependencies=[],this._mustSucceed=[],this._onCompletion=[],this.logLevel=null,Object.defineProperty(this,"failed",{get:function(){return!!a.error||a.failedDueToDependency},enumerable:!0,configurable:!0}),Object.defineProperty(this,"composite",{get:function(){return a.work instanceof c||"[object Array]"===Object.prototype.toString.call(a.work)},enumerable:!0,configurable:!0}),Object.defineProperty(this,"numOperationsRemaining",{get:function(){return a.work instanceof c?a.work.completed?0:1:"[object Array]"===Object.prototype.toString.call(a.work)?f.reduce(a.work,function(a,b){return b.completed?a:a+1},0):null},enumerable:!0,configurable:!0}),Object.defineProperty(this,"canRun",{get:function(){return a.dependencies.length?f.reduce(a.dependencies,function(b,c){var d=a._mustSucceed.indexOf(c)>-1,e=b&&c.completed;return d&&e&&(e=e&&!(c.failed||c.cancelled)),e},!0):!0},enumerable:!0,configurable:!0}),Object.defineProperty(this,"failedDueToDependency",{get:function(){if(a.dependencies.length){var b=f.reduce(a.dependencies,function(b,c){var d=a._mustSucceed.indexOf(c)>-1,e=(c.failed||c.cancelled)&&d;return e&&b.push(c),b},[]);return b.length?b:!1}return!1},enumerable:!0,configurable:!0}),Object.defineProperty(this,"failedDueToCancellationOfDependency",{get:function(){if(a.dependencies.length){var b=f.reduce(a.dependencies,function(b,c){var d=a._mustSucceed.indexOf(c)>-1;return d&&c.cancelled&&b.push(c),b},[]);return b.length?b:!1}return!1},enumerable:!0,configurable:!0}),Object.defineProperty(this,"loggingOveridden",{get:function(){return a.logLevel?a.logLevel<=d.Level.info:!1},enumerable:!0,configurable:!0})}var d=a("./log"),e=d.loggerWithName("Operation"),f=a("../util")._;c.running=[],c.prototype._startSingle=function(){var a=this;this.work(function(b,c){a.result=c,a.error=b,a.completed=!0,a.running=!1,a._complete()})},c.prototype._startComposite=function(){var a=this,b=a.work instanceof c?[a.work]:a.work;f.each(b,function(c){c.onCompletion(function(){var c=a.numOperationsRemaining,d=a.name||"Unnamed";if(e.debug(d+" has "+c.toString()+" operations remaining"),!c){var g=f.pluck(b,"error"),h=f.pluck(b,"result");a.result=f.some(h)?h:null,a.error=f.some(g)?g:null,a.completed=!0,a.running=!1,a._complete()}}),c.start()})},c.prototype._logCompletion=function(){var a=this._getLogFunc();if(e.info.isEnabled||this.loggingOveridden){var b=this.name||"Unnamed",c=this.failedDueToDependency;if(c)a('"'+b+'" failed due to failure/cancellation of dependencies: '+f.pluck(c,"name").join(", "));else if(this.failed){var d=this.error;d="[object Array]"===Object.prototype.toString.call(d)?f.filter(d,function(a){return a}):[this.error],a('"'+b+'" failed due to errors:',d)}else a(this.cancelled?'"'+b+'" has been cancelled.':'"'+b+'" has succeeded.')}},c.prototype._getLogFunc=function(){return this.logLevel?f.bind(e.override,e,d.Level.info,this.logLevel):e.info},c.prototype._logStart=function(){if(e.info.isEnabled||this.loggingOveridden){var a=this.name||"Unnamed",b=this._getLogFunc();b('"'+a+'" has started.')}},c.prototype._complete=function(){var a=this;this.completed=!0;var b=c.running.indexOf(this);c.running.splice(b,1),this.completion&&f.bind(this.completion,this)(),this._logCompletion(),f.each(this._onCompletion,function(b){f.bind(b,a)()})},c.prototype.__start=function(){this._logStart(),this.work?(this.composite?this._startComposite():this._startSingle(),c.running.push(this)):(this.result=null,this.error=null,this.running=!1,this._complete())},c.prototype.start=function(){var a=this,b=!this.running&&!this.completed,c=b&&this.failed;c?this._complete():b&&(this.running=!0,this.canRun?this.__start():f.each(this.dependencies,function(b){b.onCompletion(function(){a.canRun&&a.__start()})}))},c.prototype.addDependency=function(){var a=this;if(1==arguments.length)this.dependencies.push(arguments[0]);else if(arguments.length){var b=arguments,c=b[b.length-1],d=!1;"boolean"==typeof c&&(b=Array.prototype.slice.call(b,0,b.length-1),d=c),f.each(b,function(b){a.dependencies.push(b)}),d&&f.each(b,function(b){a._mustSucceed.push(b)})}},c.prototype.onCompletion=function(a){this.completed?f.bind(a,this)():this._onCompletion.push(a)},c.prototype.cancel=function(a){this.cancelled||(this.cancelled=!0,e.debug("Cancelling "+this.name,this),this.composite&&f.each(this.work,function(a){a.cancel()}),this.onCompletion(function(){this.running=!1,a&&a()}))},Object.defineProperty(c,"logLevel",{get:function(){return e.currentLevel()},set:function(a){e.setLevel(a)},configurable:!0,enumerable:!0}),b.exports.Operation=c},{"../util":21,"./log":13}],15:[function(a,b){function c(){if(!this)return new(Function.prototype.bind.apply(c,arguments));var a=this;arguments.length&&("number"==typeof arguments[0]?this.maxConcurrentOperations=arguments[0]:(this.name=arguments[0],this.maxConcurrentOperations=arguments[1])),this._queuedOperations=[],this._runningOperations=[],this._running=!1,this._onStart=[],this._onStop=[],this.logLevel=null,Object.defineProperty(this,"numRunningOperations",{get:function(){return a._runningOperations.length},configurable:!0,enumerable:!0}),Object.defineProperty(this,"loggingOveridden",{get:function(){return a.logLevel?a.logLevel<=d.Level.info:!1},enumerable:!0,configurable:!0})}var d=a("./log"),e=d.loggerWithName("OperationQueue"),f=a("../util")._;c.prototype._nextOperations=function(){for(var a=this;a._runningOperations.length<a.maxConcurrentOperations&&a._queuedOperations.length;){var b=a._queuedOperations[0];a._queuedOperations.splice(0,1),a._runOperation(b)}},c.prototype._runOperation=function(a){for(var b=this,c=0;c<this._queuedOperations.length;c++)if(this._queuedOperations[c]==a){this._queuedOperations.splice(c,1);break}this._runningOperations.push(a),a.completion=function(){var c=b._runningOperations.indexOf(a);b._runningOperations.splice(c,1),b._running&&b._nextOperations(),b._logStatus()},a.start(),this._logStatus()},c.prototype._logStatus=function(){var a=this._getLogFunc();if(e.info.isEnabled||this.loggingOveridden){var b=this.numRunningOperations,c=this._queuedOperations.length,d=this.name||"Unnamed Queue";a(b&&c?'"'+d+'" now has '+b.toString()+" operations running and "+c.toString()+" operations queued":b?'"'+d+'" now has '+b.toString()+" operations running":c?'"'+d+'" now has '+c.toString()+" operations queued":'"'+d+'" has no operations running or queued')}},c.prototype._logStart=function(){var a=this._getLogFunc();if(e.info.isEnabled||this.loggingOveridden){var b=this.name||"Unnamed Queue";a('"'+b+'" is now running')}},c.prototype._getLogFunc=function(){return this.logLevel?f.bind(e.override,e,d.Level.info,this.logLevel):e.info},c.prototype._logStop=function(){var a=this._getLogFunc();if(e.info.isEnabled||this.loggingOveridden){var b=this.name||"Unnamed Queue";a('"'+b+'" is no longer running')}},c.prototype._addOperation=function(a){this.numRunningOperations<this.maxConcurrentOperations&&this._running?this._runOperation(a):this._queuedOperations.push(a),this._logStatus()},c.prototype.addOperation=function(a){var b=this;"[object Array]"===Object.prototype.toString.call(a)?f.each(a,function(a){b._addOperation(a)}):this._addOperation(a)},c.prototype.start=function(){var a=this,b=this._running;this._running=!0,b||(f.each(a._onStart,function(b){f.bind(b,a)()}),a._nextOperations(),a._logStart())},c.prototype.stop=function(a){var b=this,c=this._running;if(this._running=!1,c){if(a){var d=this._runningOperations.slice(0);f.each(d,function(a){a.cancel()})}b._logStop(),f.each(b._onStop,function(a){f.bind(a,b)()})}},c.prototype.onStart=function(a){this._onStart.push(a)},c.prototype.onStop=function(a){this._onStop.push(a)},Object.defineProperty(c,"logLevel",{get:function(){return e.currentLevel()},set:function(a){e.setLevel(a)},configurable:!0,enumerable:!0}),b.exports.OperationQueue=c},{"../util":21,"./log":13}],16:[function(a,b,c){function d(a){var b=this;this.proxy=a,Object.defineProperty(this,"isFault",{get:function(){return b.proxy.isFault},enumerable:!0,configurable:!0})}function e(a){if(this._opts=a,!this)return new e(a);var b=this;if(this.fault=new d(this),this.object=null,this._id=void 0,this.related=null,Object.defineProperty(this,"isFault",{get:function(){return b._id?!b.related:null===b._id?!1:!0},set:function(a){a?(b._id=void 0,b.related=null):b._id||(b._id=null)},enumerable:!0,configurable:!0}),x.call(this,"reverseMapping",this._opts),x.call(this,"forwardMapping",this._opts),x.call(this,"forwardName",this._opts),x.call(this,"reverseName",this._opts),x.call(this,"isReverse",this._opts),Object.defineProperty(this,"isForward",{get:function(){return!b.isReverse},set:function(a){b.isReverse=!a},enumerable:!0,configurable:!0}),void 0===this._opts.isReverse&&void 0!==this._opts.isForward)this.isReverse=!this._opts.isForward;else if(void 0===this._opts.isReverse&&void 0===this._opts.isForward)throw v("Must specify either isReverse or isForward when configuring relationship proxy.")}function f(a){var b=h.call(this),c=this.reverseMapping;if(w.isArray(a))return y.map(a,function(a){return a.__proxies[b]});var d=a.__proxies[b];if(!d){var e='No proxy with name "'+b+'" on mapping '+c.type;throw new v(e)}return d}function g(a){var b=i.call(this),c=this.forwardMapping;if(w.isArray(a))return y.map(a,function(a){return a.__proxies[b]});var d=a.__proxies[b];if(!d){var e='No proxy with name "'+b+'" on mapping '+c.type;throw new v(e)}return d}function h(){return this.isForward?this.reverseName:this.forwardName}function i(){return this.isForward?this.forwardName:this.reverseName}function j(){return this.isForward?this.reverseMapping:this.forwardMapping}function k(){return this.isForward?this.forwardMapping:this.reverseMapping}function l(){if(!this.object)throw new v("Proxy must be installed on an object before can use it.")}function m(a){s.call(this,a),a?w.isArray(a)?(this._id=y.pluck(a,"_id"),this.related=a):(this._id=a._id,this.related=a):(this._id=null,this.related=null)}function n(a,b){t.apply(this,arguments);var c=Array.prototype.slice.call(arguments,2),d=y.partial(this._id.splice,a,b).apply(this._id,y.pluck(c,"_id"));return this.related&&y.partial(this.related.splice,a,b).apply(this.related,c),d}function o(a){function b(a){if(a){var b=a.mapping,c=b.type,d=a._id;return"string"==typeof d&&(d='"'+d+'"'),c+"[_id="+d+"]"}return void 0===a?"undefined":null===a?"null":void 0}return w.isArray(a)?y.map(b,a).join(", "):b(a)}function p(){var a=this;if(a.isFault){if(!a._id)throw new Error(i.call(this)+" has no _id");var b=h.call(this),c=j.call(this),d=w.isArray(a._id)?a._id:[a._id];this._reverseIsArray?y.each(d,function(d){C.registerChange({collection:c.collection,mapping:c.type,_id:d,field:b,removedId:[a.object._id],removed:[a.object],type:D.Delete,obj:a.object})}):y.each(d,function(d){C.registerChange({collection:c.collection,mapping:c.type,_id:d,field:b,"new":null,newId:null,oldId:a.object._id,old:a.object,type:D.Set,obj:a.object})})}else if(this.related){var e=f.call(this,this.related),g=w.isArray(e)?e:[e];y.each(g,function(b){if(w.isArray(b._id)){var c=b._id.indexOf(a.object._id);q.call(b,function(){n.call(b,c,1)})}else m.call(b,null)})}}function q(a){this.related?(this.related.oneToManyObserver.close(),this.related.oneToManyObserver=null,a(),u.call(this,this.related)):a()}function r(a){var b=this,c=f.call(this,a),d=w.isArray(c)?c:[c];y.each(d,function(a){w.isArray(a._id)?q.call(a,function(){n.call(a,a._id.length,0,b.object)}):(p.call(a),m.call(a,b.object))})}function s(a){var b=this.object;if(!b)throw new v("Proxy must have an object associated");var c,d=b.mapping.type,e=b.collection;c=w.isArray(a)?y.pluck(a,"_id"):a?a._id:a;var f=this._id;w.isArray(f)&&!f.length&&(f=null);var g=this.related;w.isArray(g)&&!g.length&&(g=null),C.registerChange({collection:e,mapping:d,_id:b._id,field:i.call(this),newId:c,oldId:f,old:g,"new":a,type:D.Set,obj:b})}function t(a,b){var c=Array.prototype.slice.call(arguments,2),d=this.object.mapping.type,e=this.object.collection;C.registerChange({collection:e,mapping:d,_id:this.object._id,field:i.call(this),index:a,removedId:this._id.slice(a,a+b),removed:this.related?this.related.slice(a,a+b):null,addedId:c.length?y.pluck(c,"_id"):[],added:c.length?c:[],type:D.Splice,obj:this.object})}function u(a){var b=this;if(A(a,this.reverseName,this.object),!a.oneToManyObserver){a.oneToManyObserver=new B(a);var c=function(c){c.forEach(function(c){var d=c.addedCount?a.slice(c.index,c.index+c.addedCount):[],e=k.call(b);C.registerChange({collection:e.collection,mapping:e.type,_id:b.object._id,field:i.call(b),removed:c.removed,added:d,removedId:y.pluck(c.removed,"_id"),addedId:y.pluck(c.added,"_id"),type:D.Splice,obj:b.object})})};a.oneToManyObserver.open(c)}}var v=a("./error").InternalSiestaError,w=(a("./store"),a("./operation/operation").Operation,a("./util")),x=w.defineSubProperty,y=w._,z=(a("./query").Query,a("./operation/log"),a("./notificationCentre")),A=z.wrapArray,B=a("../vendor/observe-js/src/observe").ArrayObserver,C=a("./changes"),D=C.ChangeType;y.extend(d.prototype,{get:function(){this.proxy.get.apply(this.proxy,arguments)},set:function(){this.proxy.set.apply(this.proxy,arguments)}}),y.extend(e.prototype,{_dump:function(){},install:function(a){if(!a)throw new v("No object passed to relationship install");if(this.object)throw new v("Already installed.");this.object=a;var b=this,c=i.call(this);Object.defineProperty(a,c,{get:function(){return b.isFault?b.fault:b.related},set:function(a){b.set(a)},configurable:!0,enumerable:!0}),a.__proxies||(a.__proxies={}),a.__proxies[c]=this,a._proxies||(a._proxies=[]),a._proxies.push(this)},set:function(){throw new v("Must subclass RelationshipProxy")},get:function(){throw new v("Must subclass RelationshipProxy")}}),c.RelationshipProxy=e,c.Fault=d,c.getReverseProxyForObject=f,c.getForwardProxyForObject=g,c.getReverseName=h,c.getForwardName=i,c.getReverseMapping=j,c.getForwardMapping=k,c.checkInstalled=l,c.set=m,c.registerSetChange=s,c.splice=n,c.clearReverseRelated=p,c.setReverse=r,c.objAsString=o,c.wrapArray=u,c.registerSpliceChange=t,c.makeChangesToRelatedWithoutObservations=q},{"../vendor/observe-js/src/observe":24,"./changes":2,"./error":5,"./notificationCentre":10,"./operation/log":13,"./operation/operation":14,"./query":17,"./store":20,"./util":21}],17:[function(a,b,c){function d(a,b){this.mapping=a,this.query=b}var e=a("./operation/log"),f=a("./cache"),g=a("./util"),h=e.loggerWithName("Query");h.setLevel(e.Level.warn),_.extend(d.prototype,{execute:function(a){var b=window.q?window.q.defer():null;return a=g.constructCallbackAndPromiseHandler(a,b),this._executeInMemory(a),b?b.promise:null},_dump:function(a){return a?"{}":{}},_executeInMemory:function(a){var b=window.q?window.q.defer():null;a=g.constructCallbackAndPromiseHandler(a,b);var c,d=f._localCacheByType,e=this.mapping.type,h=this.mapping.collection,i=d[h];if(i&&(c=i[e]),c){for(var j,k=Object.keys(c),l=this,m=[],n=0;n<k.length;n++){var o=k[n],p=c[o],q=l.objectMatchesQuery(p);if("string"==typeof q){j=q;break}q&&m.push(p)}a(j,j?null:m)}else a&&a(null,[]);return b?b.promise:null},objectMatchesQuery:function(a){for(var b=Object.keys(this.query),c=0;c<b.length;c++){var d,e=b[c],f=e.split("__"),g="e";2==f.length?(d=f[0],g=f[1]):d=e;var h=this.query[e],i=a[d];if("e"==g){if(i!=h)return!1}else if("lt"==g){if(i>=h)return!1}else if("lte"==g){if(i>h)return!1}else if("gt"==g){if(h>=i)return!1}else{if("gte"!=g)return'Query operator "'+g+'" does not exist';if(h>i)return!1}}return!0}}),c.Query=d},{"./cache":1,"./operation/log":13,"./util":21}],18:[function(a,b,c){RelationshipType={OneToMany:"OneToMany",OneToOne:"OneToOne",ManyToMany:"ManyToMany"},c.RelationshipType=RelationshipType},{}],19:[function(a,b,c){function d(a){if(!this)return new d(a);var b=this;this.mapping=a,Object.defineProperty(this,"idField",{get:function(){return b.mapping.id||"id"},enumerable:!0,configurable:!0}),g.call(this,"type",this.mapping),g.call(this,"collection",this.mapping),g.call(this,"_fields",this.mapping),Object.defineProperty(this,"_relationshipFields",{get:function(){var a=h.map(Object.keys(b.__proxies),function(a){return b.__proxies[a]});return h.map(a,function(a){return a.isForward?a.forwardName:a.reverseName})},enumerable:!0,configurable:!0}),this.isFault=!1,Object.defineProperty(this,"isSaved",{get:function(){return!!b._rev},enumerable:!0,configurable:!0}),this._rev=null,this.removed=!1}var e=a("./operation/log"),f=a("./util"),g=f.defineSubProperty,h=f._,i=a("./error"),j=(i.InternalSiestaError,a("./changes")),k=a("./cache"),l=e.loggerWithName("SiestaModel");l.setLevel(e.Level.warn),h.extend(d.prototype,{_dump:function(a){var b=this,c={};return c.mapping=this.mapping.type,c.collection=this.collection,c._id=this._id,c=h.reduce(this._fields,function(a,c){return b[c]&&(a[c]=b[c]),a},c),c=h.reduce(this._relationshipFields,function(a,c){var d=b.__proxies[c];return d&&(d.hasOwnProperty("_id")?f.isArray(d._id)?b[c].length&&(a[c]=d._id):d._id&&(a[c]=d._id):a[c]=b[c]),a},c),a?JSON.stringify(c,null,4):c},get:function(a){var b=window.q?window.q.defer():null;return a=f.constructCallbackAndPromiseHandler(a,b),a(null,this),b?b.promise:null},remove:function(a){var b=window.q?window.q.defer():null;return a=f.constructCallbackAndPromiseHandler(a,b),k.remove(this),this.removed=!0,j.registerChange({collection:this.collection,mapping:this.mapping.type,_id:this._id,oldId:this._id,old:this,type:j.ChangeType.Remove,obj:this}),a(null,this),b?b.promise:null},restore:function(a){var b=window.q?window.q.defer():null;return a=f.constructCallbackAndPromiseHandler(a,b),this.removed&&(k.insert(this),this.removed=!1),j.registerChange({collection:this.collection,mapping:this.mapping.type,_id:this._id,newId:this._id,"new":this,type:j.ChangeType.New,obj:this}),a(null,this),b?b.promise:null}}),c.SiestaModel=d,c.dumpSaveQueues=function(){var a={};for(var b in queues)if(queues.hasOwnProperty(b)){var c=queues[b];a[b]={numRunning:c.numRunningOperations,queued:c._queuedOperations.length}}return a}},{"./cache":1,"./changes":2,"./error":5,"./operation/log":13,"./util":21}],20:[function(a,b,c){function d(a,b){var c=window.q?window.q.defer():null;b=j.constructCallbackAndPromiseHandler(b,c),m.debug.isEnabled&&m.debug("get",a);var d;if(a._id){if(j.isArray(a._id))e(k.map(a._id,function(a){return{_id:a}}),b);else if(d=l.get(a))m.debug.isEnabled&&m.debug("Had cached object",{opts:a,obj:d}),b&&b(null,d);else if(j.isArray(a._id))e(k.map(a._id,function(a){return{_id:a}}),b);else if(b){var f=siesta.ext.storage;if(!f)throw new Error("Storage module not installed");f.store.getFromPouch(a,b)}}else{if(!a.mapping){var g={opts:a},i="Invalid options given to store";throw new h(i,g)}if(j.isArray(a[a.mapping.id]))e(k.map(a[a.mapping.id],function(b){var c={};return c[a.mapping.id]=b,c.mapping=a.mapping,c}),b);else if(d=l.get(a))m.debug.isEnabled&&m.debug("Had cached object",{opts:a,obj:d}),b&&b(null,d);else{var n=a.mapping;if(n.singleton)n.get(b);else{var o=n.id,p=a[o];if(!p)throw new h('Invalid options given to store. Missing "'+o.toString()+'."');n.get(p,function(a,c){a?b(a):c?b(null,c):b(null,null)})}}}return c?c.promise:null}function e(a,b){var c=window.q?window.q.defer():null;b=j.constructCallbackAndPromiseHandler(b,c);var e=[],f=[];return k.each(a,function(c){d(c,function(c,d){c?f.push(c):e.push(d),e.length+f.length==a.length&&b&&(f.length?b(f):b(null,e))})}),c?c.promise:null}function f(a,b){function c(c){b&&(c?b(c):b(null,k.map(a,function(a){return e.cached[a]})))}var d=window.q?window.q.defer():null;b=j.constructCallbackAndPromiseHandler(b,d);var e=k.reduce(a,function(a,b){var c=l.get({_id:b});return c?a.cached[b]=c:a.notCached.push(b),a},{cached:{},notCached:[]});return siesta.ext.storageEnabled&&e.notCached.length?siesta.ext.storage.store.getMultipleLocalFromCouch(e,c):c(),d?d.promise:null}function g(a,b,c){function d(b){c&&(b?c(b):c(null,k.map(a,function(a){return f.cached[a]})))}var e=window.q?window.q.defer():null;c=j.constructCallbackAndPromiseHandler(c,e);var f=k.reduce(a,function(a,c){var d={mapping:b};d[b.id]=c;var e=l.get(d);return e?a.cached[c]=e:a.notCached.push(c),a},{cached:{},notCached:[]});return siesta.ext.storageEnabled&&f.notCached.length?siesta.ext.storage.store.getMultipleRemoteFrompouch(b,a,f,d):d(),e?e.promise:null}var h=a("./error").InternalSiestaError,i=a("./operation/log"),j=a("./util"),k=j._,l=a("./cache"),m=i.loggerWithName("Store");m.setLevel(i.Level.warn),c.get=d,c.getMultiple=e,c.getMultipleLocal=f,c.getMultipleRemote=g},{"./cache":1,"./error":5,"./operation/log":13,"./util":21}],21:[function(a,b,c){function d(){var a=new Error("printStackTrace"),b=a.stack;console.log(b)}function e(a){return a.charAt(0).toUpperCase()+a.slice(1)}function f(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[l].concat(b))}}function g(a,b){if(a.map)return a.map(b);var c=[];return l(a,function(a,d,e){c.push(b(a,d,e))}),c}function h(a,b,c,d){if(b=g(b,function(a,b){return{index:b,value:a}}),d){var e=[];a(b,function(a,b){c(a.value,function(c,d){e[a.index]=d,b(c)})},function(a){d(a,e)})}else a(b,function(a,b){c(a.value,function(a){b(a)})})}function i(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[j].concat(b))}}function j(a,b,c){if(c=c||function(){},!a.length)return c();var d=0,e=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d>=a.length?c():e())})};e()}function k(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)}function l(a,b,c){function d(b){b?(c(b),c=function(){}):(e+=1,e>=a.length&&c())}if(c=c||function(){},!a.length)return c();var e=0;k(a,function(a){b(a,o(d))})}function m(a){if(Object.keys)return Object.keys(a);var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b}function n(a,b){if(b=b||function(){},_isArray(a))w(a,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},b);else{var c={};j(_keys(a),function(b,d){a[b](function(a){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),c[b]=e,d(a)})},function(a){b(a,c)})}}function o(a){var b=!1;return function(){if(b)throw new Error("Callback was already called.");b=!0,a.apply(t,arguments)}}function p(a,b){x({map:v,each:l},a,b)}function q(a){K.performMicrotaskCheckpoint(),setTimeout(a)}function r(a,b,c){if(!a)throw b=b||"Assertion failed",c=c||{},new L(b,c)}function s(a,b,c){return Object.defineProperty(this,a,{get:function(){return c?b[c]:b[a]},set:function(d){c?b[c]=d:b[a]=d},enumerable:!0,configurable:!0})}c.printStackTrace=d,c.capitaliseFirstLetter=e;var t={},u=Array.isArray||function(a){return"[object Array]"===_toString.call(a)},v=f(h),w=i(h),x=function(a,b,c){if(c=c||function(){},u(b))a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c);else{var d={};a.each(m(b),function(a,c){b[a](function(b){var e=Array.prototype.slice.call(arguments,1);e.length<=1&&(e=e[0]),d[a]=e,c(b)})},function(a){c(a,d)})}};c.series=n,c.parallel=p,c.isArray=u;var y={},z=Array.prototype,A=Function.prototype,B=z.forEach,C=z.map,D=z.reduce,E=A.bind,F=z.slice,G={};y.keys=m,y.each=y.forEach=function(a,b,c){if(null==a)return a;if(B&&a.forEach===B)a.forEach(b,c);else if(a.length===+a.length){for(var d=0,e=a.length;e>d;d++)if(b.call(c,a[d],d,a)===G)return}else for(var f=y.keys(a),d=0,e=f.length;e>d;d++)if(b.call(c,a[f[d]],f[d],a)===G)return;return a},y.map=y.collect=function(a,b,c){var d=[];return null==a?d:C&&a.map===C?a.map(b,c):(y.each(a,function(a,e,f){d.push(b.call(c,a,e,f))}),d)},y.partial=function(a){var b=F.call(arguments,1);return function(){for(var c=0,d=b.slice(),e=0,f=d.length;f>e;e++)d[e]===y&&(d[e]=arguments[c++]);for(;c<arguments.length;)d.push(arguments[c++]);return a.apply(this,d)}},y.pluck=function(a,b){return y.map(a,y.property(b))};var H="Reduce of empty array with no initial value";y.reduce=y.foldl=y.inject=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),D&&a.reduce===D)return d&&(b=y.bind(b,d)),e?a.reduce(b,c):a.reduce(b);if(y.each(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)}),!e)throw new TypeError(H);return c},y.property=function(a){return function(b){return b[a]}},"function"!=typeof/./&&(y.isFunction=function(a){return"function"==typeof a}),y.isObject=function(a){var b=typeof a;return"function"===b||"object"===b&&!!a};var I=function(a){return null==a?y.identity:y.isFunction(a)?a:y.property(a)};y.sortBy=function(a,b,c){return b=I(b),y.pluck(y.map(a,function(a,d,e){return{value:a,index:d,criteria:b.call(c,a,d,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(d>c||void 0===d)return-1}return a.index-b.index}),"value")};var J=function(){};y.bind=function(a,b){var c,d;if(E&&a.bind===E)return E.apply(a,F.call(arguments,1));if(!y.isFunction(a))throw new TypeError;return c=F.call(arguments,2),d=function(){if(!(this instanceof d))return a.apply(b,c.concat(F.call(arguments)));J.prototype=a.prototype;var e=new J;J.prototype=null;var f=a.apply(e,c.concat(F.call(arguments)));return Object(f)===f?f:e}},y.identity=function(a){return a},y.zip=function(a){if(null==a)return[];for(var b=y.max(arguments,"length").length,c=Array(b),d=0;b>d;d++)c[d]=y.pluck(arguments,d);return c},y.max=function(a,b,c){var d,e,f=-1/0,g=-1/0;if(null==b&&null!=a){a=a.length===+a.length?a:y.values(a);for(var h=0,i=a.length;i>h;h++)d=a[h],d>f&&(f=d)}else b=y.iteratee(b,c),y.each(a,function(a,c,d){e=b(a,c,d),(e>g||e===-1/0&&f===-1/0)&&(f=a,g=e)});return f},y.iteratee=function(a,b,c){return null==a?y.identity:y.isFunction(a)?createCallback(a,b,c):y.isObject(a)?y.matches(a):y.property(a)},y.pairs=function(a){for(var b=y.keys(a),c=b.length,d=Array(c),e=0;c>e;e++)d[e]=[b[e],a[b[e]]];return d},y.matches=function(a){var b=y.pairs(a),c=b.length;return function(a){if(null==a)return!c;a=new Object(a);for(var d=0;c>d;d++){var e=b[d],f=e[0];if(e[1]!==a[f]||!(f in a))return!1}return!0}},y.some=function(a,b,c){if(null==a)return!1;b=y.iteratee(b,c);var d,e,f=a.length!==+a.length&&y.keys(a),g=(f||a).length;
for(d=0;g>d;d++)if(e=f?f[d]:d,b(a[e],e,a))return!0;return!1},y.extend=function(a){if(!y.isObject(a))return a;for(var b,c,d=1,e=arguments.length;e>d;d++){b=arguments[d];for(c in b)hasOwnProperty.call(b,c)&&(a[c]=b[c])}return a},c._=y;var K=a("../vendor/observe-js/src/observe").Platform;c.next=q,c.constructCallbackAndPromiseHandler=function(a,b){return function(c){a&&a.apply(a,arguments),b&&(c?b.reject(c):b.resolve.apply(b,Array.prototype.slice.call(arguments,1)))}};var L=a("./error").InternalSiestaError,M=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}();y.extend(b.exports,{assert:r,defineSubProperty:s,guid:M})},{"../vendor/observe-js/src/observe":24,"./error":5}],22:[function(a,b){function c(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function d(a){return"function"==typeof a}function e(a){return"number"==typeof a}function f(a){return"object"==typeof a&&null!==a}function g(a){return void 0===a}b.exports=c,c.EventEmitter=c,c.prototype._events=void 0,c.prototype._maxListeners=void 0,c.defaultMaxListeners=10,c.prototype.setMaxListeners=function(a){if(!e(a)||0>a||isNaN(a))throw TypeError("n must be a positive number");return this._maxListeners=a,this},c.prototype.emit=function(a){var b,c,e,h,i,j;if(this._events||(this._events={}),"error"===a&&(!this._events.error||f(this._events.error)&&!this._events.error.length)){if(b=arguments[1],b instanceof Error)throw b;throw TypeError('Uncaught, unspecified "error" event.')}if(c=this._events[a],g(c))return!1;if(d(c))switch(arguments.length){case 1:c.call(this);break;case 2:c.call(this,arguments[1]);break;case 3:c.call(this,arguments[1],arguments[2]);break;default:for(e=arguments.length,h=new Array(e-1),i=1;e>i;i++)h[i-1]=arguments[i];c.apply(this,h)}else if(f(c)){for(e=arguments.length,h=new Array(e-1),i=1;e>i;i++)h[i-1]=arguments[i];for(j=c.slice(),e=j.length,i=0;e>i;i++)j[i].apply(this,h)}return!0},c.prototype.addListener=function(a,b){var e;if(!d(b))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",a,d(b.listener)?b.listener:b),this._events[a]?f(this._events[a])?this._events[a].push(b):this._events[a]=[this._events[a],b]:this._events[a]=b,f(this._events[a])&&!this._events[a].warned){var e;e=g(this._maxListeners)?c.defaultMaxListeners:this._maxListeners,e&&e>0&&this._events[a].length>e&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),"function"==typeof console.trace&&console.trace())}return this},c.prototype.on=c.prototype.addListener,c.prototype.once=function(a,b){function c(){this.removeListener(a,c),e||(e=!0,b.apply(this,arguments))}if(!d(b))throw TypeError("listener must be a function");var e=!1;return c.listener=b,this.on(a,c),this},c.prototype.removeListener=function(a,b){var c,e,g,h;if(!d(b))throw TypeError("listener must be a function");if(!this._events||!this._events[a])return this;if(c=this._events[a],g=c.length,e=-1,c===b||d(c.listener)&&c.listener===b)delete this._events[a],this._events.removeListener&&this.emit("removeListener",a,b);else if(f(c)){for(h=g;h-->0;)if(c[h]===b||c[h].listener&&c[h].listener===b){e=h;break}if(0>e)return this;1===c.length?(c.length=0,delete this._events[a]):c.splice(e,1),this._events.removeListener&&this.emit("removeListener",a,b)}return this},c.prototype.removeAllListeners=function(a){var b,c;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[a]&&delete this._events[a],this;if(0===arguments.length){for(b in this._events)"removeListener"!==b&&this.removeAllListeners(b);return this.removeAllListeners("removeListener"),this._events={},this}if(c=this._events[a],d(c))this.removeListener(a,c);else for(;c.length;)this.removeListener(a,c[c.length-1]);return delete this._events[a],this},c.prototype.listeners=function(a){var b;return b=this._events&&this._events[a]?d(this._events[a])?[this._events[a]]:this._events[a].slice():[]},c.listenerCount=function(a,b){var c;return c=a._events&&a._events[b]?d(a._events[b])?1:a._events[b].length:0}},{}],23:[function(a,b){var c,d=Object.prototype.hasOwnProperty,e=Object.prototype.toString,f=function(a){"use strict";if(!a||"[object Object]"!==e.call(a)||a.nodeType||a.setInterval)return!1;var b=d.call(a,"constructor"),f=a.constructor&&a.constructor.prototype&&d.call(a.constructor.prototype,"isPrototypeOf");if(a.constructor&&!b&&!f)return!1;var g;for(g in a);return g===c||d.call(a,g)};b.exports=function g(){"use strict";var a,b,d,e,h,i,j=arguments[0],k=1,l=arguments.length,m=!1;for("boolean"==typeof j?(m=j,j=arguments[1]||{},k=2):("object"!=typeof j&&"function"!=typeof j||j==c)&&(j={});l>k;++k)if(null!=(a=arguments[k]))for(b in a)d=j[b],e=a[b],j!==e&&(m&&e&&(f(e)||(h=Array.isArray(e)))?(h?(h=!1,i=d&&Array.isArray(d)?d:[]):i=d&&f(d)?d:{},j[b]=g(m,i,e)):e!==c&&(j[b]=e));return j}},{}],24:[function(require,module,exports){(function(global){!function(global){"use strict";function detectObjectObserve(){function a(a){b=a}if("function"!=typeof Object.observe||"function"!=typeof Array.observe)return!1;var b=[],c={},d=[];return Object.observe(c,a),Array.observe(d,a),c.id=1,c.id=2,delete c.id,d.push(1,2),d.length=0,Object.deliverChangeRecords(a),5!==b.length?!1:"add"!=b[0].type||"update"!=b[1].type||"delete"!=b[2].type||"splice"!=b[3].type||"splice"!=b[4].type?!1:(Object.unobserve(c,a),Array.unobserve(d,a),!0)}function detectEval(){if("undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime)return!1;if(navigator.getDeviceStorage)return!1;try{var a=new Function("","return true;");return a()}catch(b){return!1}}function isIndex(a){return+a===a>>>0&&""!==a}function toNumber(a){return+a}function isObject(a){return a===Object(a)}function areSameValue(a,b){return a===b?0!==a||1/a===1/b:numberIsNaN(a)&&numberIsNaN(b)?!0:a!==a&&b!==b}function getPathCharType(a){if(void 0===a)return"eof";var b=a.charCodeAt(0);switch(b){case 91:case 93:case 46:case 34:case 39:case 48:return a;case 95:case 36:return"ident";case 32:case 9:case 10:case 13:case 160:case 65279:case 8232:case 8233:return"ws"}return b>=97&&122>=b||b>=65&&90>=b?"ident":b>=49&&57>=b?"number":"else"}function noop(){}function parsePath(a){function b(){if(!(k>=a.length)){var b=a[k+1];return"inSingleQuote"==l&&"'"==b||"inDoubleQuote"==l&&'"'==b?(k++,d=b,m.append(),!0):void 0}}for(var c,d,e,f,g,h,i,j=[],k=-1,l="beforePath",m={push:function(){void 0!==e&&(j.push(e),e=void 0)},append:function(){void 0===e?e=d:e+=d}};l;)if(k++,c=a[k],"\\"!=c||!b(l)){if(f=getPathCharType(c),i=pathStateMachine[l],g=i[f]||i["else"]||"error","error"==g)return;if(l=g[0],h=m[g[1]]||noop,d=void 0===g[2]?c:g[2],h(),"afterPath"===l)return j}}function isIdent(a){return identRegExp.test(a)}function Path(a,b){if(b!==constructorIsPrivate)throw Error("Use Path.get to retrieve path objects");for(var c=0;c<a.length;c++)this.push(String(a[c]));hasEval&&this.length&&(this.getValueFrom=this.compiledGetValueFromFn())}function getPath(a){if(a instanceof Path)return a;if((null==a||0==a.length)&&(a=""),"string"!=typeof a){if(isIndex(a.length))return new Path(a,constructorIsPrivate);a=String(a)}var b=pathCache[a];if(b)return b;var c=parsePath(a);if(!c)return invalidPath;var b=new Path(c,constructorIsPrivate);return pathCache[a]=b,b}function formatAccessor(a){return isIndex(a)?"["+a+"]":'["'+a.replace(/"/g,'\\"')+'"]'}function dirtyCheck(a){for(var b=0;MAX_DIRTY_CHECK_CYCLES>b&&a.check_();)b++;return testingExposeCycleCount&&(global.dirtyCheckCycleCount=b),b>0}function objectIsEmpty(a){for(var b in a)return!1;return!0}function diffIsEmpty(a){return objectIsEmpty(a.added)&&objectIsEmpty(a.removed)&&objectIsEmpty(a.changed)}function diffObjectFromOldObject(a,b){var c={},d={},e={};for(var f in b){var g=a[f];(void 0===g||g!==b[f])&&(f in a?g!==b[f]&&(e[f]=g):d[f]=void 0)}for(var f in a)f in b||(c[f]=a[f]);return Array.isArray(a)&&a.length!==b.length&&(e.length=a.length),{added:c,removed:d,changed:e}}function runEOMTasks(){if(!eomTasks.length)return!1;for(var a=0;a<eomTasks.length;a++)eomTasks[a]();return eomTasks.length=0,!0}function newObservedObject(){function a(a){b&&b.state_===OPENED&&!d&&b.check_(a)}var b,c,d=!1,e=!0;return{open:function(c){if(b)throw Error("ObservedObject in use");e||Object.deliverChangeRecords(a),b=c,e=!1},observe:function(b,d){c=b,d?Array.observe(c,a):Object.observe(c,a)},deliver:function(b){d=b,Object.deliverChangeRecords(a),d=!1},close:function(){b=void 0,Object.unobserve(c,a),observedObjectCache.push(this)}}}function getObservedObject(a,b,c){var d=observedObjectCache.pop()||newObservedObject();return d.open(a),d.observe(b,c),d}function newObservedSet(){function a(b,f){b&&(b===d&&(e[f]=!0),h.indexOf(b)<0&&(h.push(b),Object.observe(b,c)),a(Object.getPrototypeOf(b),f))}function b(a){for(var b=0;b<a.length;b++){var c=a[b];if(c.object!==d||e[c.name]||"setPrototype"===c.type)return!1}return!0}function c(c){if(!b(c)){for(var d,e=0;e<g.length;e++)d=g[e],d.state_==OPENED&&d.iterateObjects_(a);for(var e=0;e<g.length;e++)d=g[e],d.state_==OPENED&&d.check_()}}var d,e,f=0,g=[],h=[],i={object:void 0,objects:h,open:function(b,c){d||(d=c,e={}),g.push(b),f++,b.iterateObjects_(a)},close:function(){if(f--,!(f>0)){for(var a=0;a<h.length;a++)Object.unobserve(h[a],c),Observer.unobservedCount++;g.length=0,h.length=0,d=void 0,e=void 0,observedSetCache.push(this)}}};return i}function getObservedSet(a,b){return lastObservedSet&&lastObservedSet.object===b||(lastObservedSet=observedSetCache.pop()||newObservedSet(),lastObservedSet.object=b),lastObservedSet.open(a,b),lastObservedSet}function Observer(){this.state_=UNOPENED,this.callback_=void 0,this.target_=void 0,this.directObserver_=void 0,this.value_=void 0,this.id_=nextObserverId++}function addToAll(a){Observer._allObserversCount++,collectObservers&&allObservers.push(a)}function removeFromAll(){Observer._allObserversCount--}function ObjectObserver(a){Observer.call(this),this.value_=a,this.oldObject_=void 0}function ArrayObserver(a){if(!Array.isArray(a))throw Error("Provided object is not an Array");ObjectObserver.call(this,a)}function PathObserver(a,b){Observer.call(this),this.object_=a,this.path_=getPath(b),this.directObserver_=void 0}function CompoundObserver(a){Observer.call(this),this.reportChangesOnOpen_=a,this.value_=[],this.directObserver_=void 0,this.observed_=[]}function identFn(a){return a}function ObserverTransform(a,b,c,d){this.callback_=void 0,this.target_=void 0,this.value_=void 0,this.observable_=a,this.getValueFn_=b||identFn,this.setValueFn_=c||identFn,this.dontPassThroughSet_=d}function diffObjectFromChangeRecords(a,b,c){for(var d={},e={},f=0;f<b.length;f++){var g=b[f];expectedRecordTypes[g.type]?(g.name in c||(c[g.name]=g.oldValue),"update"!=g.type&&("add"!=g.type?g.name in d?(delete d[g.name],delete c[g.name]):e[g.name]=!0:g.name in e?delete e[g.name]:d[g.name]=!0)):(console.error("Unknown changeRecord type: "+g.type),console.error(g))}for(var h in d)d[h]=a[h];for(var h in e)e[h]=void 0;var i={};for(var h in c)if(!(h in d||h in e)){var j=a[h];c[h]!==j&&(i[h]=j)}return{added:d,removed:e,changed:i}}function newSplice(a,b,c){return{index:a,removed:b,addedCount:c}}function ArraySplice(){}function calcSplices(a,b,c,d,e,f){return arraySplice.calcSplices(a,b,c,d,e,f)}function intersect(a,b,c,d){return c>b||a>d?-1:b==c||d==a?0:c>a?d>b?b-c:d-c:b>d?d-a:b-a}function mergeSplice(a,b,c,d){for(var e=newSplice(b,c,d),f=!1,g=0,h=0;h<a.length;h++){var i=a[h];if(i.index+=g,!f){var j=intersect(e.index,e.index+e.removed.length,i.index,i.index+i.addedCount);if(j>=0){a.splice(h,1),h--,g-=i.addedCount-i.removed.length,e.addedCount+=i.addedCount-j;var k=e.removed.length+i.removed.length-j;if(e.addedCount||k){var c=i.removed;if(e.index<i.index){var l=e.removed.slice(0,i.index-e.index);Array.prototype.push.apply(l,c),c=l}if(e.index+e.removed.length>i.index+i.addedCount){var m=e.removed.slice(i.index+i.addedCount-e.index);Array.prototype.push.apply(c,m)}e.removed=c,i.index<e.index&&(e.index=i.index)}else f=!0}else if(e.index<i.index){f=!0,a.splice(h,0,e),h++;var n=e.addedCount-e.removed.length;i.index+=n,g+=n}}}f||a.push(e)}function createInitialSplices(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d];switch(e.type){case"splice":mergeSplice(c,e.index,e.removed.slice(),e.addedCount);break;case"add":case"update":case"delete":if(!isIndex(e.name))continue;var f=toNumber(e.name);if(0>f)continue;mergeSplice(c,f,[e.oldValue],1);break;default:console.error("Unexpected record type: "+JSON.stringify(e))}}return c}function projectArraySplices(a,b){var c=[];return createInitialSplices(a,b).forEach(function(b){return 1==b.addedCount&&1==b.removed.length?void(b.removed[0]!==a[b.index]&&c.push(b)):void(c=c.concat(calcSplices(a,b.index,b.index+b.addedCount,b.removed,0,b.removed.length)))}),c}var testingExposeCycleCount=global.testingExposeCycleCount,hasObserve=detectObjectObserve(),hasEval=detectEval(),numberIsNaN=global.Number.isNaN||function(a){return"number"==typeof a&&global.isNaN(a)},createObject="__proto__"in{}?function(a){return a}:function(a){var b=a.__proto__;if(!b)return a;var c=Object.create(b);return Object.getOwnPropertyNames(a).forEach(function(b){Object.defineProperty(c,b,Object.getOwnPropertyDescriptor(a,b))}),c},identStart="[$_a-zA-Z]",identPart="[$_a-zA-Z0-9]",identRegExp=new RegExp("^"+identStart+"+"+identPart+"*$"),pathStateMachine={beforePath:{ws:["beforePath"],ident:["inIdent","append"],"[":["beforeElement"],eof:["afterPath"]},inPath:{ws:["inPath"],".":["beforeIdent"],"[":["beforeElement"],eof:["afterPath"]},beforeIdent:{ws:["beforeIdent"],ident:["inIdent","append"]},inIdent:{ident:["inIdent","append"],0:["inIdent","append"],number:["inIdent","append"],ws:["inPath","push"],".":["beforeIdent","push"],"[":["beforeElement","push"],eof:["afterPath","push"]},beforeElement:{ws:["beforeElement"],0:["afterZero","append"],number:["inIndex","append"],"'":["inSingleQuote","append",""],'"':["inDoubleQuote","append",""]},afterZero:{ws:["afterElement","push"],"]":["inPath","push"]},inIndex:{0:["inIndex","append"],number:["inIndex","append"],ws:["afterElement"],"]":["inPath","push"]},inSingleQuote:{"'":["afterElement"],eof:["error"],"else":["inSingleQuote","append"]},inDoubleQuote:{'"':["afterElement"],eof:["error"],"else":["inDoubleQuote","append"]},afterElement:{ws:["afterElement"],"]":["inPath","push"]}},constructorIsPrivate={},pathCache={};Path.get=getPath,Path.prototype=createObject({__proto__:[],valid:!0,toString:function(){for(var a="",b=0;b<this.length;b++){var c=this[b];a+=isIdent(c)?b?"."+c:c:formatAccessor(c)}return a},getValueFrom:function(a){for(var b=0;b<this.length;b++){if(null==a)return;a=a[this[b]]}return a},iterateObjects:function(a,b){for(var c=0;c<this.length;c++){if(c&&(a=a[this[c-1]]),!isObject(a))return;b(a,this[0])}},compiledGetValueFromFn:function(){var a="",b="obj";a+="if (obj != null";for(var c,d=0;d<this.length-1;d++)c=this[d],b+=isIdent(c)?"."+c:formatAccessor(c),a+=" &&\n     "+b+" != null";a+=")\n";var c=this[d];return b+=isIdent(c)?"."+c:formatAccessor(c),a+="  return "+b+";\nelse\n  return undefined;",new Function("obj",a)},setValueFrom:function(a,b){if(!this.length)return!1;for(var c=0;c<this.length-1;c++){if(!isObject(a))return!1;a=a[this[c]]}return isObject(a)?(a[this[c]]=b,!0):!1}});var invalidPath=new Path("",constructorIsPrivate);invalidPath.valid=!1,invalidPath.getValueFrom=invalidPath.setValueFrom=function(){};var MAX_DIRTY_CHECK_CYCLES=1e3,eomTasks=[],runEOM=hasObserve?function(){var a={pingPong:!0},b=!1;return Object.observe(a,function(){runEOMTasks(),b=!1}),function(c){eomTasks.push(c),b||(b=!0,a.pingPong=!a.pingPong)}}():function(){return function(a){eomTasks.push(a)}}(),observedObjectCache=[],observedSetCache=[],lastObservedSet,UNOPENED=0,OPENED=1,CLOSED=2,RESETTING=3,nextObserverId=1;Observer.prototype={open:function(a,b){if(this.state_!=UNOPENED)throw Error("Observer has already been opened.");return addToAll(this),this.callback_=a,this.target_=b,this.connect_(),this.state_=OPENED,this.value_},close:function(){this.state_==OPENED&&(removeFromAll(this),this.disconnect_(),this.value_=void 0,this.callback_=void 0,this.target_=void 0,this.state_=CLOSED)},deliver:function(){this.state_==OPENED&&dirtyCheck(this)},report_:function(a){try{this.callback_.apply(this.target_,a)}catch(b){Observer._errorThrownDuringCallback=!0,console.error("Exception caught during observer callback: "+(b.stack||b))}},discardChanges:function(){return this.check_(void 0,!0),this.value_}};var collectObservers=!hasObserve,allObservers;Observer._allObserversCount=0,collectObservers&&(allObservers=[]);var runningMicrotaskCheckpoint=!1,hasDebugForceFullDelivery=hasObserve&&hasEval&&function(){try{return eval("%RunMicrotasks()"),!0}catch(ex){return!1}}();global.Platform=global.Platform||{},global.Platform.performMicrotaskCheckpoint=function(){if(!runningMicrotaskCheckpoint){if(hasDebugForceFullDelivery)return void eval("%RunMicrotasks()");if(collectObservers){runningMicrotaskCheckpoint=!0;var cycles=0,anyChanged,toCheck;do{cycles++,toCheck=allObservers,allObservers=[],anyChanged=!1;for(var i=0;i<toCheck.length;i++){var observer=toCheck[i];observer.state_==OPENED&&(observer.check_()&&(anyChanged=!0),allObservers.push(observer))}runEOMTasks()&&(anyChanged=!0)}while(MAX_DIRTY_CHECK_CYCLES>cycles&&anyChanged);testingExposeCycleCount&&(global.dirtyCheckCycleCount=cycles),runningMicrotaskCheckpoint=!1}}},collectObservers&&(global.Platform.clearObservers=function(){allObservers=[]}),ObjectObserver.prototype=createObject({__proto__:Observer.prototype,arrayObserve:!1,connect_:function(){hasObserve?this.directObserver_=getObservedObject(this,this.value_,this.arrayObserve):this.oldObject_=this.copyObject(this.value_)},copyObject:function(a){var b=Array.isArray(a)?[]:{};for(var c in a)b[c]=a[c];return Array.isArray(a)&&(b.length=a.length),b},check_:function(a){var b,c;if(hasObserve){if(!a)return!1;c={},b=diffObjectFromChangeRecords(this.value_,a,c)}else c=this.oldObject_,b=diffObjectFromOldObject(this.value_,this.oldObject_);return diffIsEmpty(b)?!1:(hasObserve||(this.oldObject_=this.copyObject(this.value_)),this.report_([b.added||{},b.removed||{},b.changed||{},function(a){return c[a]}]),!0)},disconnect_:function(){hasObserve?(this.directObserver_.close(),this.directObserver_=void 0):this.oldObject_=void 0},deliver:function(){this.state_==OPENED&&(hasObserve?this.directObserver_.deliver(!1):dirtyCheck(this))},discardChanges:function(){return this.directObserver_?this.directObserver_.deliver(!0):this.oldObject_=this.copyObject(this.value_),this.value_}}),ArrayObserver.prototype=createObject({__proto__:ObjectObserver.prototype,arrayObserve:!0,copyObject:function(a){return a.slice()},check_:function(a){var b;if(hasObserve){if(!a)return!1;b=projectArraySplices(this.value_,a)}else b=calcSplices(this.value_,0,this.value_.length,this.oldObject_,0,this.oldObject_.length);return b&&b.length?(hasObserve||(this.oldObject_=this.copyObject(this.value_)),this.report_([b]),!0):!1}}),ArrayObserver.applySplices=function(a,b,c){c.forEach(function(c){for(var d=[c.index,c.removed.length],e=c.index;e<c.index+c.addedCount;)d.push(b[e]),e++;Array.prototype.splice.apply(a,d)})},PathObserver.prototype=createObject({__proto__:Observer.prototype,get path(){return this.path_},connect_:function(){hasObserve&&(this.directObserver_=getObservedSet(this,this.object_)),this.check_(void 0,!0)},disconnect_:function(){this.value_=void 0,this.directObserver_&&(this.directObserver_.close(this),this.directObserver_=void 0)},iterateObjects_:function(a){this.path_.iterateObjects(this.object_,a)},check_:function(a,b){var c=this.value_;return this.value_=this.path_.getValueFrom(this.object_),b||areSameValue(this.value_,c)?!1:(this.report_([this.value_,c,this]),!0)},setValue:function(a){this.path_&&this.path_.setValueFrom(this.object_,a)}});var observerSentinel={};CompoundObserver.prototype=createObject({__proto__:Observer.prototype,connect_:function(){if(hasObserve){for(var a,b=!1,c=0;c<this.observed_.length;c+=2)if(a=this.observed_[c],a!==observerSentinel){b=!0;break}b&&(this.directObserver_=getObservedSet(this,a))}this.check_(void 0,!this.reportChangesOnOpen_)},disconnect_:function(){for(var a=0;a<this.observed_.length;a+=2)this.observed_[a]===observerSentinel&&this.observed_[a+1].close();this.observed_.length=0,this.value_.length=0,this.directObserver_&&(this.directObserver_.close(this),this.directObserver_=void 0)},addPath:function(a,b){if(this.state_!=UNOPENED&&this.state_!=RESETTING)throw Error("Cannot add paths once started.");var b=getPath(b);if(this.observed_.push(a,b),this.reportChangesOnOpen_){var c=this.observed_.length/2-1;this.value_[c]=b.getValueFrom(a)}},addObserver:function(a){if(this.state_!=UNOPENED&&this.state_!=RESETTING)throw Error("Cannot add observers once started.");if(this.observed_.push(observerSentinel,a),this.reportChangesOnOpen_){var b=this.observed_.length/2-1;this.value_[b]=a.open(this.deliver,this)}},startReset:function(){if(this.state_!=OPENED)throw Error("Can only reset while open");this.state_=RESETTING,this.disconnect_()},finishReset:function(){if(this.state_!=RESETTING)throw Error("Can only finishReset after startReset");return this.state_=OPENED,this.connect_(),this.value_},iterateObjects_:function(a){for(var b,c=0;c<this.observed_.length;c+=2)b=this.observed_[c],b!==observerSentinel&&this.observed_[c+1].iterateObjects(b,a)},check_:function(a,b){for(var c,d=0;d<this.observed_.length;d+=2){var e,f=this.observed_[d],g=this.observed_[d+1];if(f===observerSentinel){var h=g;e=this.state_===UNOPENED?h.open(this.deliver,this):h.discardChanges()}else e=g.getValueFrom(f);b?this.value_[d/2]=e:areSameValue(e,this.value_[d/2])||(c=c||[],c[d/2]=this.value_[d/2],this.value_[d/2]=e)}return c?(this.report_([this.value_,c,this.observed_]),!0):!1}}),ObserverTransform.prototype={open:function(a,b){return this.callback_=a,this.target_=b,this.value_=this.getValueFn_(this.observable_.open(this.observedCallback_,this)),this.value_},observedCallback_:function(a){if(a=this.getValueFn_(a),!areSameValue(a,this.value_)){var b=this.value_;this.value_=a,this.callback_.call(this.target_,this.value_,b)}},discardChanges:function(){return this.value_=this.getValueFn_(this.observable_.discardChanges()),this.value_},deliver:function(){return this.observable_.deliver()},setValue:function(a){return a=this.setValueFn_(a),!this.dontPassThroughSet_&&this.observable_.setValue?this.observable_.setValue(a):void 0},close:function(){this.observable_&&this.observable_.close(),this.callback_=void 0,this.target_=void 0,this.observable_=void 0,this.value_=void 0,this.getValueFn_=void 0,this.setValueFn_=void 0}};var expectedRecordTypes={add:!0,update:!0,"delete":!0},EDIT_LEAVE=0,EDIT_UPDATE=1,EDIT_ADD=2,EDIT_DELETE=3;ArraySplice.prototype={calcEditDistances:function(a,b,c,d,e,f){for(var g=f-e+1,h=c-b+1,i=new Array(g),j=0;g>j;j++)i[j]=new Array(h),i[j][0]=j;for(var k=0;h>k;k++)i[0][k]=k;for(var j=1;g>j;j++)for(var k=1;h>k;k++)if(this.equals(a[b+k-1],d[e+j-1]))i[j][k]=i[j-1][k-1];else{var l=i[j-1][k]+1,m=i[j][k-1]+1;i[j][k]=m>l?l:m}return i},spliceOperationsFromEditDistances:function(a){for(var b=a.length-1,c=a[0].length-1,d=a[b][c],e=[];b>0||c>0;)if(0!=b)if(0!=c){var f,g=a[b-1][c-1],h=a[b-1][c],i=a[b][c-1];f=i>h?g>h?h:g:g>i?i:g,f==g?(g==d?e.push(EDIT_LEAVE):(e.push(EDIT_UPDATE),d=g),b--,c--):f==h?(e.push(EDIT_DELETE),b--,d=h):(e.push(EDIT_ADD),c--,d=i)}else e.push(EDIT_DELETE),b--;else e.push(EDIT_ADD),c--;return e.reverse(),e},calcSplices:function(a,b,c,d,e,f){var g=0,h=0,i=Math.min(c-b,f-e);if(0==b&&0==e&&(g=this.sharedPrefix(a,d,i)),c==a.length&&f==d.length&&(h=this.sharedSuffix(a,d,i-g)),b+=g,e+=g,c-=h,f-=h,c-b==0&&f-e==0)return[];if(b==c){for(var j=newSplice(b,[],0);f>e;)j.removed.push(d[e++]);return[j]}if(e==f)return[newSplice(b,[],c-b)];for(var k=this.spliceOperationsFromEditDistances(this.calcEditDistances(a,b,c,d,e,f)),j=void 0,l=[],m=b,n=e,o=0;o<k.length;o++)switch(k[o]){case EDIT_LEAVE:j&&(l.push(j),j=void 0),m++,n++;break;case EDIT_UPDATE:j||(j=newSplice(m,[],0)),j.addedCount++,m++,j.removed.push(d[n]),n++;break;case EDIT_ADD:j||(j=newSplice(m,[],0)),j.addedCount++,m++;break;case EDIT_DELETE:j||(j=newSplice(m,[],0)),j.removed.push(d[n]),n++}return j&&l.push(j),l},sharedPrefix:function(a,b,c){for(var d=0;c>d;d++)if(!this.equals(a[d],b[d]))return d;return c},sharedSuffix:function(a,b,c){for(var d=a.length,e=b.length,f=0;c>f&&this.equals(a[--d],b[--e]);)f++;return f},calculateSplices:function(a,b){return this.calcSplices(a,0,a.length,b,0,b.length)},equals:function(a,b){return a===b}};var arraySplice=new ArraySplice,expose=global;"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(expose=exports=module.exports),expose=exports),expose.Observer=Observer,expose.Observer.runEOM_=runEOM,expose.Observer.observerSentinel_=observerSentinel,expose.Observer.hasObjectObserve=hasObserve,expose.ArrayObserver=ArrayObserver,expose.ArrayObserver.calculateSplices=function(a,b){return arraySplice.calculateSplices(a,b)},expose.Platform=global.Platform,expose.ArraySplice=ArraySplice,expose.ObjectObserver=ObjectObserver,expose.PathObserver=PathObserver,expose.CompoundObserver=CompoundObserver,expose.Path=Path,expose.ObserverTransform=ObserverTransform}("undefined"!=typeof global&&global&&"undefined"!=typeof module&&module?global:this||window)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[6]),function b(a,c,d){function e(g,h){if(!c[g]){if(!a[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};a[g][0].call(k.exports,function(b){var c=a[g][1][b];return e(c?c:b)},k,k.exports,b,a,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){function d(a){return a?"*"==a||a.indexOf("*")>-1?a=p:i.isArray(a)||(a=[a]):a=["GET"],n.map(a,function(a){return a.toUpperCase()})}function e(a){if(!this)return new e(a);this._rawOpts=m(!0,{},a),this._opts=a;var b=function(a){return a instanceof RegExp||(a=new RegExp(a,"g")),a}.bind(this);if(this._opts.path){var c=this._opts.path;i.isArray(c)||(c=[c]),this._opts.path=[],n.each(c,function(a){this._opts.path.push(b.call(this,a))}.bind(this))}else this._opts.path=[""];if(this._opts.method=d(this._opts.method),!this._opts.mapping)throw new Error("Descriptors must be initialised with a mapping",{opts:a,descriptor:this});if("string"==typeof this._opts.mapping){if(!this._opts.collection)throw new Error("Passed mapping as string, but did not specify the collection it belongs to",{opts:a,descriptor:this});var f;if(f="string"==typeof this._opts.collection?l[this._opts.collection]:this._opts.collection,!f)throw new Error("Collection "+this._opts.collection+" does not exist",{opts:a,descriptor:this});var g=f[this._opts.mapping];if(!g)throw new Error("Mapping "+this._opts.mapping+" does not exist",{opts:a,descriptor:this});this._opts.mapping=g}var h=this._opts.data;if(h&&h.length){var j,o=h.split(".");if(1==o.length)j=o[0];else{var p={};j=p;for(var q=o[0],r=1;r<o.length;r++){var s=o[r];if(r==o.length-1)p[q]=s;else{var t={};p[q]=t,p=t,q=s}}}this._opts.data=j}k.call(this,"path",this._opts),k.call(this,"method",this._opts),k.call(this,"mapping",this._opts),k.call(this,"data",this._opts),k.call(this,"transforms",this._opts)}var f=siesta._internal,g=f.log,h=f.error.InternalSiestaError,i=f.util,j=i.assert,k=i.defineSubProperty,l=f.CollectionRegistry,m=f.extend,n=i._,o=g.loggerWithName("Descriptor");o.setLevel(g.Level.trace);var p=["POST","PATCH","PUT","HEAD","GET","DELETE","OPTIONS","TRACE","CONNECT"];n.extend(e.prototype,{httpMethods:p,_matchPath:function(a){var b;for(b=0;b<this._opts.path.length;b++){var c=this._opts.path[b];o.trace.isEnabled&&o.trace("Matching path",a,c.toString());var d=c.exec(a);if(o.trace.isEnabled&&(d?o.trace("Matched path successfully",a,c.toString()):o.trace("Failed to match path",a,c.toString())),d)return!0}return!1},_matchMethod:function(a){for(var b=0;b<this.method.length;b++)if(a.toUpperCase()==this.method[b])return!0;return!1},bury:function(a,b){var c=b,d=Object.keys(b);j(1==d.length);for(var e=d[0],f=b;"string"!=typeof f[e];)f=f[e],d=Object.keys(f),j(1==d.length),e=d[0];var g=f[e],h={};return f[e]=h,h[g]=a,c},_embedData:function(a){if(this.data){var b;return"string"==typeof this.data?(b={},b[this.data]=a):b=this.bury(a,m(!0,{},this.data)),b}return a},_extractData:function(a){if(o.debug.isEnabled&&o.debug("_extractData",a),this.data){if("string"==typeof this.data)return a[this.data];var b=Object.keys(this.data);j(1==b.length);for(var c=a,d=this.data;"string"!=typeof d;){b=Object.keys(d),j(1==b.length);var e=b[0];if(d=d[e],c=c[e],!c)break}return c?c[d]:null}return a},_matchConfig:function(a){var b=a.type?this._matchMethod(a.type):{};return b&&(b=a.url?this._matchPath(a.url):{}),b},_matchData:function(a){var b=null;return this.data?a&&(b=this._extractData(a)):b=a,b},match:function(a,b){var c=this._matchConfig(a),d=!!c,e=!1;return d&&(e=this._matchData(b)),e},_transformData:function(a){var b=this.transforms;if("function"==typeof b)a=b(a);else for(var c in b)if(b.hasOwnProperty(c)&&a[c]){var d=b[c],e=a[c];if("string"==typeof d){var f=d.split(".");if(delete a[c],1==f.length)a[f[0]]=e;else{a[f[0]]={};for(var g=a[f[0]],j=1;j<f.length-1;j++){var k=f[j];g[k]={},g=g[k]}g[f[f.length-1]]=e}}else{if("function"!=typeof d)throw new h("Invalid transformer");var l=d(e);i.isArray(l)?(delete a[c],a[l[0]]=l[1]):a[c]=l}}return a}}),c.Descriptor=e,c.resolveMethod=d},{}],2:[function(a,b,c){function d(){return this?(this.requestDescriptors={},void(this.responseDescriptors={})):new d(opts)}function e(a,b){var c=b.mapping,d=c.collection;i(c),i(d),i("string"==typeof d),a[d]||(a[d]=[]),a[d].push(b)}function f(a,b){var c;return c="string"==typeof b?a[b]||[]:a[b._name]||[]}var g=siesta._internal,h=g.util,i=h.assert,j=h._,k=g.log,l=k.loggerWithName("DescriptorRegistry");l.setLevel(k.Level.warn),console.log("_",j),j.extend(d.prototype,{registerRequestDescriptor:function(a){e(this.requestDescriptors,a)},registerResponseDescriptor:function(a){l.trace.isEnabled&&l.trace("registerResponseDescriptor"),e(this.responseDescriptors,a)},requestDescriptorsForCollection:function(a){return f(this.requestDescriptors,a)},responseDescriptorsForCollection:function(a){var b=f(this.responseDescriptors,a);return b.length||l.debug.isEnabled&&l.debug("No response descriptors for collection ",this.responseDescriptors),b},reset:function(){this.requestDescriptors={},this.responseDescriptors={}}}),c.DescriptorRegistry=new d},{}],3:[function(a,b){function c(a,b,c){if(y.debug.isEnabled){var d=y.debug,e=a.type+" "+b.status+" "+a.url;y.trace.isEnabled&&c&&(d=y.trace,e+=": "+JSON.stringify(c,null,4)),d(e)}}function d(a){if(y.debug.isEnabled){var b=y.debug,c=a.type+" "+a.url;y.trace.isEnabled&&(b=y.trace),b(c)}}function e(a,b,e,f){var g=this,h=Array.prototype.slice.call(arguments,2),i={},j=this._name;"function"==typeof h[0]?f=h[0]:"object"==typeof h[0]&&(i=h[0],f=h[1]);var k=window.q?window.q.defer():null;if(f=s.constructCallbackAndPromiseHandler(f,k),i.type=a,!i.url){var l=this.baseURL;i.url=l+b}void 0===i.parseResponse&&(i.parseResponse=!0),i.success=function(a,b,d){c(i,d,a);var e={data:a,status:b,xhr:d};if(i.parseResponse){for(var h,k,l=x.responseDescriptorsForCollection(g),m=0;m<l.length;m++){var n=l[m];if(k=n.match(i,a)){h=n;break}}if(h)if(y.trace.isEnabled&&y.trace("Mapping extracted data: "+JSON.stringify(k,null,4)),"object"==typeof k){var o=h.mapping;o.map(k,function(a,b){f&&f(a,b,e)},i.obj)}else f(null,!0,e);else if(f){if(!j)throw new w("Unnamed collection");var p={},q=t.ErrorCode.NoDescriptorMatched;
p[t.ErrorField.Code]=q,p[t.ErrorField.Message]=t.Message[q],f(p,null,e)}}else f(null,null,e)},i.error=function(a,b,c){var d={xhr:a,status:b,error:c};f&&f(d,null,d)},d(i),siesta.ext.http.ajax(i)}function f(a,b,c){this._serialise(b,function(b,d){var e=d;a.fields&&(e={},u.each(a.fields,function(a){e[a]=d[a]})),c(b,e)})}function g(a,b,c){var d,g=this,h=Array.prototype.slice.call(arguments,3),i={};"function"==typeof h[0]?d=h[0]:"object"==typeof h[0]&&(i=h[0],d=h[1]);var j=window.q?window.q.defer():null;d=s.constructCallbackAndPromiseHandler(d,j),h=Array.prototype.slice.call(h,2);var k,l=x.requestDescriptorsForCollection(this);i.type=a;var m=this.baseURL;i.url=m+b;for(var n=0;n<l.length;n++){var o=l[n];if(o._matchConfig(i)){k=o;break}}return k?(y.trace.isEnabled&&y.trace("Matched descriptor: "+k._dump(!0)),f.call(k,c,i,function(f,j){y.trace.isEnabled&&y.trace("_serialise",{err:f,data:j}),f?d&&d(f,null,null):(i.data=j,i.obj=c,u.partial(e,a,b,i,d).apply(g,h))})):d&&(y.trace.isEnabled&&y.trace("Did not match descriptor"),d("No descriptor matched",null,null)),j?j.promise:null}function h(a,b,c){var d,f=window.q?window.q.defer():null,g=Array.prototype.slice.call(arguments,3),h={};"function"==typeof g[0]?d=g[0]:"object"==typeof g[0]&&(h=g[0],d=g[1]),d=s.constructCallbackAndPromiseHandler(d,f);var i=h.deletionMode||"restore";return void 0===h.parseResponse&&(h.parseResponse=!1),e.call(a,"DELETE",b,h,function(a,b,e,f){a?"restore"==i&&c.restore():"success"==i&&c.remove(),d(a,b,e,f)}),("now"==i||"restore"==i)&&c.remove(),f?f.promise:null}function i(a,b,c){var d=Array.prototype.slice.call(arguments,3);return u.partial(b?g:e,c).apply(a,d)}function j(a){var b=Array.prototype.slice.call(arguments,1);return u.partial(i,a,!1,"GET").apply(this,b)}function k(a){var b=Array.prototype.slice.call(arguments,1);return u.partial(i,a,!1,"OPTIONS").apply(this,b)}function l(a){var b=Array.prototype.slice.call(arguments,1);return u.partial(i,a,!1,"TRACE").apply(this,b)}function m(a){var b=Array.prototype.slice.call(arguments,1);return u.partial(i,a,!1,"HEAD").apply(this,b)}function n(a){var b=Array.prototype.slice.call(arguments,1);return u.partial(i,a,!0,"POST").apply(this,b)}function o(a){var b=Array.prototype.slice.call(arguments,1);return u.partial(i,a,!0,"PUT").apply(this,b)}function p(a){var b=Array.prototype.slice.call(arguments,1);return u.partial(i,a,!0,"PATCH").apply(this,b)}if("undefined"==typeof siesta&&"undefined"==typeof b)throw new Error("Could not find window.siesta. Make sure you include siesta.core.js first.");var q=siesta._internal,r=(siesta.Collection,q.log),s=q.util,t=q.error,u=s._,v=a("./descriptor"),w=q.error.InternalSiestaError,x=a("./descriptorRegistry").DescriptorRegistry,y=r.loggerWithName("HTTP");y.setLevel(r.Level.trace);var z,A={RequestDescriptor:a("./requestDescriptor").RequestDescriptor,ResponseDescriptor:a("./responseDescriptor").ResponseDescriptor,Descriptor:v.Descriptor,_resolveMethod:v.resolveMethod,Serialiser:a("./serialiser"),DescriptorRegistry:a("./descriptorRegistry").DescriptorRegistry,setAjax:function(a){z=a},_httpResponse:e,_httpRequest:g,DELETE:h,HTTP_METHOD:i,GET:j,TRACE:l,OPTIONS:k,HEAD:m,POST:n,PUT:o,PATCH:p,_serialiseObject:f};Object.defineProperty(A,"ajax",{get:function(){var a=z||($?$.ajax:null)||(jQuery?jQuery.ajax:null);if(!a)throw new w("ajax has not been defined and could not find $.ajax or jQuery.ajax");return a},set:function(a){z=a}}),"undefined"!=typeof siesta&&(siesta.ext||(siesta.ext={}),siesta.ext.http=A),"undefined"!=typeof b&&(b.exports=A)},{"./descriptor":1,"./descriptorRegistry":2,"./requestDescriptor":4,"./responseDescriptor":5,"./serialiser":6}],4:[function(a,b,c){function d(a){return this?(e.call(this,a),this._opts.serializer&&(this._opts.serialiser=this._opts.serializer),this._opts.serialiser||(this._opts.serialiser=f.depthSerializer(0)),k.call(this,"serialiser",this._opts),void k.call(this,"serializer",this._opts,"serialiser")):new d(a)}var e=a("./descriptor").Descriptor,f=a("./serialiser"),g=siesta._internal,h=g.util,i=h._,j=g.log,k=h.defineSubProperty,l=j.loggerWithName("RequestDescriptor");l.setLevel(j.Level.warn),d.prototype=Object.create(e.prototype),i.extend(d.prototype,{_serialise:function(a,b){var c=window.q?window.q.defer():null;b=h.constructCallbackAndPromiseHandler(b,c);var d=this;l.trace.isEnabled&&l.trace("_serialise");var e,f=this.serialiser(a,function(a,c){e||(c=d._transformData(c),b&&b(a,d._embedData(c)))});return void 0!==f?(l.trace.isEnabled&&l.trace("serialiser doesnt use a callback"),e=!0,f=d._transformData(f),b&&b(null,d._embedData(f))):l.trace.isEnabled&&l.trace("serialiser uses a callback",this.serialiser),c?c.promise:null},_dump:function(a){var b={};b.methods=this.method,b.mapping=this.mapping.type,b.path=this._rawOpts.path;var c;c="function"==typeof this._rawOpts.serialiser?"function () { ... }":this._rawOpts.serialiser,b.serialiser=c;var d={};for(var e in this.transforms)if(this.transforms.hasOwnProperty(e)){var f=this.transforms[e];d[e]="function"==typeof f?"function () { ... }":this.transforms[e]}return b.transforms=d,a?JSON.stringify(b,null,4):b}}),c.RequestDescriptor=d},{"./descriptor":1,"./serialiser":6}],5:[function(a,b,c){function d(a){return this?void e.call(this,a):new d(a)}var e=a("./descriptor").Descriptor;d.prototype=Object.create(e.prototype),_.extend(d.prototype,{_extractData:function(a){var b=e.prototype._extractData.call(this,a);return b&&(b=this._transformData(b)),b},_matchData:function(a){var b=e.prototype._matchData.call(this,a);return b&&(b=this._transformData(b)),b},_dump:function(a){var b={};b.methods=this.method,b.mapping=this.mapping.type,b.path=this._rawOpts.path;var c={};for(var d in this.transforms)if(this.transforms.hasOwnProperty(d)){var e=this.transforms[d];c[d]="function"==typeof e?"function () { ... }":this.transforms[d]}return b.transforms=c,a?JSON.stringify(b,null,4):b}}),c.ResponseDescriptor=d},{"./descriptor":1}],6:[function(a,b,c){function d(a){var b=a.mapping.id;return b?a[b]?a[b]:null:void(i.debug.isEnabled&&i.debug("No idfield"))}function e(a,b,c){i.trace.isEnabled&&i.trace("depthSerialiser");var d={};j.each(b._fields,function(a){i.trace.isEnabled&&i.trace("field",a),b[a]&&(d[a]=b[a])});var f=[],g=[],h={},k=[];j.each(b._relationshipFields,function(j){i.trace.isEnabled&&i.trace("relationshipField",j);var l=b.__proxies[j];l.isForward&&(i.debug.isEnabled&&i.debug(j),f.push(j),l.get(function(l,m){i.trace.isEnabled&&i.trace("proxy.get",j),i.debug.isEnabled&&i.debug(j,m),l?(g.push(l),k.push(j),h[j]={err:l,v:m}):m?a?e(a-1,m,function(a,b,e){a?g.push(a):d[j]=b,k.push(j),h[j]={err:a,v:m,resp:e},f.length==k.length&&c&&c(g.length?g:null,d,h)}):(k.push(j),d[j]=m[b.__proxies[j].forwardMapping.id],h[j]={err:l,v:m},f.length==k.length&&c&&c(g.length?g:null,d,h)):(i.debug.isEnabled&&i.debug("no value for "+j),k.push(j),h[j]={err:l,v:m},f.length==k.length&&c&&c(g.length?g:null,d,h))}))}),f.length||c&&c(null,d,{})}var f=siesta._internal,g=f.log,h=f.util,i=g.loggerWithName("Serialiser");i.setLevel(g.Level.warn);var j=h._;c.depthSerialiser=function(a){return j.partial(e,a)},c.depthSerializer=function(a){return j.partial(e,a)},c.idSerializer=d,c.idSerialiser=d},{}]},{},[3]);